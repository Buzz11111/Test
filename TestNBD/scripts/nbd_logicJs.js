var commonConst = {
	"UstanovlenId": "a0b630bc-fbed-4863-9053-6cec9ee3a459",
	"UstanovlenCode": 4,
	"SnyatId": "259762d5-2ee4-4acb-a2c7-18593cb6cc4f",
	"SnyatCode": 5,
	//a.polunina Убрала в рамках задачи https://rm.mfc.ru/issues/46142
	// "PeradanId": "cf989528-3bd8-47bf-bb11-378aae61c2a2",
	// "PeradanCode": 3,
	// "UtilizaciyaId": "32f6eded-2f6e-4ce8-a4d9-5f0378e4c3b0",
	// "UtilizaciyaCode": 7,
	// "PriostanovlenId": "2fb7fcd3-2754-4605-926c-33ddf3834a8a",
	// "PriostanovlenCode": 11,
	// "VozobnovlenId": "f7730d93-7567-4fe7-b146-b5d9b2559d02",
	// "VozobnovlenCode": 12,
	"GotovId": "52c7de6f-1bc2-48a7-90b4-1b14264a01ab",
	"GotovCode": 13,
	"VipushenId": "c82c2eb8-0cf9-4693-8a2b-c6bf605c97ab",
	"VipushenCode": 14,
	"ZapreshenId": "b9151ccf-bdae-43b4-b660-35cec7abf953",
	"ZapreshenCode": 15,
	"ZaprochenaCorrectId": "c0221145-9593-46ec-bc72-b883554ea00d",
	"ZaprochenaCorrectCode": 16
}

var keyElementCodes = {
	// Колесная пара в сборе
	"wheel_pair_id": "c7ea506c-b2ab-49fd-9fc7-e7f4726e4cc6",
	"wheel_pair_code": "5",
	// Главная часть воздухораспределителя
	"main_part_air_distributor_id": "919ce1ba-4fb5-4bbe-8469-a63e8679c3f5",
	"main_part_air_distributor_code": "9",
	// Поглощающий аппарат
	"absorbing_device_id": "da3ef755-972f-4a0e-8b45-efd1ccb9f219",
	"absorbing_device_code": "8",
	// Рама боковая
	"side_frame_id": "b28e1a4f-d340-4ce0-a37a-d84dcfa1b6fb",
	"side_frame_code": "7",
	// Балка надрессорная
	"pressure_beam_id": "477d0c01-84d3-441c-9bb9-15f9d609671d",
	"pressure_beam_code": "6",
	// Корпус автосцепки
	"coupler_id": "6eab3f2a-03b7-4570-9278-55944ed353d2",
	"coupler_code": "10",
	// Авторежим
	"auto_mode_id": "a9c68ae7-9047-4e64-8a1b-7125982705f5",
	"auto_mode_code": "11",
	// Клин фрикционный
	"friction_wedge_id": "5a912378-16a5-49ed-a3cb-0b8e456a75ee",
	"friction_wedge_code": "12",
	// Корпус скользуна
	"slider_body_id": "34c12f72-eb33-4ab1-ba3e-a80166258e5d",
	"slider_body_code": "13",
	// Колпак скользуна
	"slider_cap_id": "ff1d8011-75dc-4d30-832f-f47c3d5ac430",
	"slider_cap_code": "14",
	// Адаптер колеса
	"wheel_adapter_id": "de1e2909-cd71-4cf6-b190-6a8b77891003",
	"wheel_adapter_code": "15",

	// Тормозной цилиндр
	"brake_cylinder_id": "6e063e06-9ee0-4b6e-b139-dce19840068c",
	"brake_cylinder_code": "16",
	// Пружины рессорного подвешивания подклиновая наружная
	"spring_suspension_under_wedge_external_id": "2491a44c-44c0-4ea0-974d-19e8e4e0a517",
	"spring_suspension_under_wedge_external_code": "17",
	// Пружины рессорного подвешивания подклиновая внутренняя
	"spring_suspension_under_wedge_internal_id": "652ad7a8-b305-4b3a-953f-a1d642de7c08",
	"spring_suspension_under_wedge_internal_code": "18",
	// Пружины рессорного подвешивания наружная
	"spring_suspension_external_id": "c14b0b6c-b87e-4811-b9ee-acda1750a21d",
	"spring_suspension_external_code": "19",
	// Пружины рессорного подвешивания внутренняя
	"spring_suspension_internal_id": "567d590c-635b-49dc-b549-5463d73c2c76",
	"spring_suspension_internal_code": "20",
	// Пружины скользуна наружная
	"spring_slider_external_id": "fce1cfa5-ae1b-4c73-8be3-7f82f4a03c61",
	"spring_slider_external_code": "21",
	// Пружины скользуна внутренняя
	"spring_slider_internal_id": "055222ff-3135-42be-88db-9e4baae328c3",
	"spring_slider_internal_code": "22",
	// Резервуары воздушные для автотормозов
	"air_tank_auto_brakes_id": "794cbb3d-8860-4ce5-aa34-229906282b26",
	"air_tank_auto_brakes_code": "23",
	// Тяговый хомут автосцепки
	"traction_clamp_coupling_id": "9fedb2e3-6ab9-4175-8d8d-8f4398597184",
	"traction_clamp_coupling_code": "24",
	// Триангель
	"triangel_id": "e3200e0f-29a9-4076-9a53-0615a1530abb",
	"triangel_code": "25",
	// Магистральная часть воздухораспределителя
	"trunk_part_air_distributor_id": "3147020f-5589-4a3b-baf5-6468221a00e3",
	"trunk_part_air_distributor_code": "26",
	// Адаптер подшипника
	"bearing_adapter_id": "245d3b99-2693-4195-b70a-ff6576b3922b",
	"bearing_adapter_code": "38",
	//Сменный ЖД кузов
	"removable_railway_carcass_id": "ad836d1b-6ecb-4dce-a508-8e9f42095ba3",
	"removable_railway_carcass_code": "39",
	//Планка фрикционная
	"friction_strip_id":"fb64a1dc-1a7b-4bb9-9575-d3f47bdf57cf",
	"friction_strip_code": "27",
	//Скоба
	"brace_id": "21947b0d-9610-45ec-80ac-6efe7a0f0103",
	"brace_code": "28",
	//Ось чистовая
	"clear_axis_id":"e4ef0365-0365-40df-ab4e-a77104c352df",
	"clear_axis_code": "40",
	//Колесо
	"wheel_id":"0813e4cb-5497-400d-9bb2-e309dda359ba",
	"wheel_code": "33",
	//Пластины в клиновых карманах
	"wedge_pockets_id": "8d6deb72-5c2e-4294-a289-01bd8a1d7f2f",
	"wedge_pockets_code": "41",
	//Кольцо в подпятник
	"saddle_ring_id":"8cdec5a2-69ac-4dd9-8568-f53853b55f86",
	"saddle_ring_code": "42",
	//Вставки в клиновые карманы
	"wedge_pockets_inserts_id": "f8f1d758-81a5-493d-8e9d-d5b4166dd34e",
	"wedge_pockets_inserts_code": "43",
	//Вкладыш подпятника
	"saddle_bearing_id": "a70ac9bc-3212-4361-9b83-ab36282f7c97",
	"saddle_bearing_code": "44",
	// Планка износостойкая
	"wearproof_strip_id": "529b7358-40a5-49ea-b443-ff67c5303b3d",
	"wearproof_strip_code": "30",
	// Вставка
	"insert_id": "a7648678-df09-4388-9bc2-4ef31a4618ba",
	"insert_code": "31",
	// Кольцо
	"ring_id": "c57e6c37-bb65-4604-b312-9b8c6fcfc4fe",
	"ring_code": "29",
	//Замок
	"lock_id":"9c60e01e-b4b7-448a-ae1b-7709f55d43a2",
	"lock_code": "36",
	//Валик подъемника
	"elevator_roll_id": "966f3039-1528-4af5-9e8e-2378dd738243",
	"elevator_roll_code": "37",
	//Корпус автосцепки
	"auto_coupler_id": "6eab3f2a-03b7-4570-9278-55944ed353d2",
	"auto_coupler_code": "10",
	//Упоры передний и задний объединенные
	"front_rear_detents_id":"cb0c6745-79e1-4f4c-8100-805942413ad5",
	"front_rear_detents_code":"45",
	//Крышка люка полувагона
	"gondola_hatch_id": "12bade5a-a313-4646-8bf8-d260dd287d1c",
	"gondola_hatch_code": "46",
	//Пружина рессорного подвешивания наружная
	"spring_outside_id":"08b8a0fd-c525-4389-9186-18f8bc4a09b4",
	"spring_outside_code":"47",
	//Пружина рессорного подвешивания внутренняя
	"spring_inside_id":"a0bcf214-a48f-4a35-b762-c7b0786c4193",
	"spring_inside_code":"48",
	//Пружина скользуна наружная
	"spring_slider_outside_id":"4aed23f8-9710-4904-a2f5-b89d9bc7c75c",
	"spring_slider_outside_code":"49",
	//Пружина скользуна внутренняя
	"spring_slider_inside_id":"975cd310-7675-4436-899f-4c6b84555f6a",
	"spring_slider_inside_code":"50",
	//Подшипник буксового узла
	"bearing_node_id":"556f259c-7a5e-49bb-b156-50f5b0517707",
	"bearing_node_code":"51",
	//Ось черновая
	"rough_axis_id":"a0e6b16a-5fee-4318-a4dc-115ae65d4b09",
	"rough_axis_code":"52",
	//Корпус поглощающего аппарата
	"absorbing_device_body_id":"38dd229a-915f-49ef-bba8-a28f055c9962",
	"absorbing_device_body_code":"53",
	//Хомут тяговый
	"traction_clamp_id":"4ba30e4b-a6e2-4cbd-bab0-ff51c79c7b87",
	"traction_clamp_code":"54",
	//Авторежим грузовой
	"auto_mode_cargo_id":"c91fe0b9-99c8-4ad4-b504-3bb3d15af749",
	"auto_mode_cargo_code":"55"
}

var dictionary_ke_node_types = {
	// Колесная пара
	"wheel_pair": "a3afe986-102a-4a10-aafe-5407134f7c15",
	// Передача тормозная рычажная
	"brake_transmission_group": "b817ce27-bd7b-4151-8de6-5036a203994e",
	// Комплект пружин
	"spring_group": "5fe8c6fd-fd66-49da-92d3-222b1b3a1243",
	// Скользун
	"slider_group": "a70bf64c-215b-4d42-9c8e-f8ab4ac9f357",
	// Хомут в сборе в поглощающим аппаратом
	"clamp_with_absorbing_device_group": "5db9db1f-e0cb-41fc-80ec-52cb1141ea51",
	// Воздухораспределитель
	"air_distributor_group": "aa12b486-85f2-416f-b299-e76e07174934"
}

var eventTypeEnum = {
	"Info": 1,
	"Debug": 2,
	"Warning": 3,
	"Error": 4
};

// Получить информацию о внешнем сервисе по ключу
function getexternalservice(key) {
	var externalservice_params = {
		"recname": key
	};

	var externalservice = db.findbyparams("external_services", externalservice_params)
	if (!!externalservice && externalservice.length > 0) {
		return externalservice[0];
	}
}

// Получить участника по текущему пользователю.
function getmemberbyuser() {
	var user = getcurrentuser();

	if (!!user.groups) {
		for (var i = 0; i < user.groups.length; i++) {
			var group = user.groups[i];
			var authgroupsParams = {
				"authgroup": group.recid
			};
			var reestr_members = db.findbyparams("reestr_members", authgroupsParams)
			if (!!reestr_members && reestr_members.length > 0) {
				return reestr_members[0]
			}
		}
	}

	return null;
}
// Получить участника по текущему пользователю по recid участника
function getmemberbyuserwithrecid(recid) {
	var user = getcurrentuserbyid(recid);
	if (!!user.groups) {
		for (var i = 0; i < user.groups.length; i++) {
			var group = user.groups[i];
			var authgroupsParams = {
				"authgroup": group.recid
			};
			var reestr_members = db.findbyparams("reestr_members", authgroupsParams)
			if (!!reestr_members && reestr_members.length > 0) {
				return reestr_members[0]
			}
		}
	}

	return null;
}

// Запрос пользователя.
function getcurrentuser() {
	var url = String().concat(host, "/auth/userProfile");
	var headers = addAuthHeader(headers);
	var res = fetch(url, {
		headers: {
			'Authorization': headers.Authorization
		},
		"Method": "get"
	});

	if (!res.Success) {
		throw new Error(res.Message)
	}
	else {
		var data = JSON.parse(res.Data)
		return data;
	}
}

// Запрос пользователя по recid.
function getcurrentuserbyid(recid) {
	var url = String().concat(host, "/auth/userProfile/", recid);
	var headers = addAuthHeader(headers);
	var res = fetch(url, {
		headers: {
			'Authorization': headers.Authorization
		},
		"Method": "get"
	});

	if (!res.Success) {
		throw new Error(res.Message)
	}
	else {
		var data = JSON.parse(res.Data)
		return data;
	}
}

// Запрос к блокчейну
function sendrequest(request, nodeip) {
	// test
	// // var debugResponse =  {
	// // 	"result":{
	// // 		"hash":"testhash",
	// // 		"node":"testnode",
	// // 		"recn":"testrecn",
	// // 		"tn":"testtn"
	// // 	}
	// // };
	// // return debugResponse;

	//https://88.87.79.140:9000 - волгоград
	//https://77.238.98.235:9000 - москва
	// var f = "https://localhost:9000"; //"https://" + nodeip;

	// if (!!nodeip) {
	// 	url = "https://" + nodeip;
	// }

	var blockchainData = GetBlockchainData();
	if(!blockchainData.success)
		return blockchainData;

	var res = fetch(blockchainData.data.nodeip, {
		headers: {
			'Authorization': 'Basic ' + _base64.encode(String().concat(blockchainData.data.login, ":", blockchainData.data.password)),
			"Content-Type": "application/json"
		},
		"body": JSON.stringify(request),
		"Method": "post"
	});

	if (!res.Success) {
		throw new Error(res.Message)
	}
	else {
		var data = JSON.parse(res.Data)
		return data;
	}

}

// Запрос к блокчейну без throw
function sendrequestNoThrow(request, nodeip) {
	// test
	// // var debugResponse =  {
	// // 	"result":{
	// // 		"hash":"testhash",
	// // 		"node":"testnode",
	// // 		"recn":"testrecn",
	// // 		"tn":"testtn"
	// // 	}
	// // };
	// // return debugResponse;

	//https://88.87.79.140:9000 - волгоград
	//https://77.238.98.235:9000 - москва
	// var url = "https://localhost:9000"; //"https://" + nodeip;

	// if (!!nodeip) {
	// 	url = "https://" + nodeip;
	// }

	var blockchainData = GetBlockchainData();
	if(!blockchainData.success)
		return blockchainData;

		var res = fetch(blockchainData.data.nodeip, {
			headers: {
				'Authorization': 'Basic ' + _base64.encode(String().concat(blockchainData.data.login, ":", blockchainData.data.password)),
			"Content-Type": "application/json"
		},
		"body": JSON.stringify(request),
		"Method": "post"
	});

	if (!res.Success) {
		return {
			'success': false,
			'data': res.Message
		};
	}
	else {
		var data = JSON.parse(res.Data)
		return {
			'success': true,
			'data': data
		};
	}

}

// Получение списка объектов по типу
function getkelist(params) {

	var dictionary_ke_types = db.findbyrecid("dictionary_ke_types", params.ketype);
	var request =
		{
			"method":
				{
					"function": "list_objects",
					"package": "NBD"
				},
			"object_class": dictionary_ke_types.recname
		}

	return sendrequest(request);
}

// Получение списка объектов с фильтром по номеру паспорта
// ketype - recid type
// kenumber - ke number
function getkelistfilter(params) {

	var dictionary_ke_types = db.findbyrecid("dictionary_ke_types", params.ketype);

	var request =
		{
			"method":
				{
					"function": "list_objects",
					"package": "NBD"
				},
			"object_class": dictionary_ke_types.recname,
			"filter":
				{
					"common": {
						"номер паспорта": params.kenumber
					}
				}
		}

	return sendrequest(request, params.nodeip);
}

// Установать СЧ на вагон для группы kesender.
function installkebysender(params) {
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	var reestr_vehicles = db.findbyrecid("reestr_vehicles", params.vehicle);

	if (reestr_vehicles.vagon_number != null
		&& reestr_vehicles.vagon_number !== "undefined"
		&& reestr_vehicles.vagon_number.length > 0) {
			return {
				success: false,
				message: "Для вагона уже введен сетевой номер, установка невозможна. Чтобы установить СЧ, необходимо очистить поле \"Номер вагона зарегистрированный\""
			};
	}

	var dateke = new Date(params.operation_date);
	var requestdata = {
		"numberke": reestr_key_element.numberke,
		"wagonnumber": reestr_vehicles.vagon_number,
		"manufacturernumber": reestr_vehicles.manufacturer_number,
		"date": dateke.getUTCFullYear() +
			'-' + (dateke.getUTCMonth() + 1).toString().padStart(2, 0) +
			'-' + (dateke.getUTCDate()).toString().padStart(2, 0)
	};
	var res = true;
	res = apiaddketowagon(requestdata);
	return res;
}

// Установить СЧ на вагон.
function installke(params) {
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	if (isNullObject(reestr_key_element)) {
		return badResp("составная часть не найден в системе.")
	}

	if (reestr_key_element.batchid != null && reestr_key_element.batchid !=""){
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", reestr_key_element.batchid);
		if (isNullObject(batch)) {
			return badResp("Запись о партии не найдена в системе");
		}
		if (member.recid == batch.recipient_droplist){
			//если получатель
			if (batch.batch_status != "ef519ef4-ec73-4776-9295-2d007bb32907" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp("Невозможно выполнить данную операцию")
			}
		} else{
			//если отправитель
			//статус партии отклонена или получена частично флаг false
			if (batch.batch_status != "281496a2-3d01-479e-80cb-96e6e6e76135" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp("Невозможно выполнить данную операцию")
			}
		}
	}

	var reestr_vehicles = db.findbyrecid("reestr_vehicles", params.vehicle);
	if (isNullObject(reestr_vehicles)) {
		return badResp("Вагон не найден в системе.")
	}

	var dateke = new Date(params.operation_date);
	var requestdata = {
		"numberke": reestr_key_element.numberke,
		"wagonnumber": reestr_vehicles.vagon_number,
		"manufacturernumber": reestr_vehicles.manufacturer_number,
		"date": dateke.getUTCFullYear() +
			'-' + (dateke.getUTCMonth() + 1).toString().padStart(2, 0) +
			'-' + (dateke.getUTCDate()).toString().padStart(2, 0)
	};

	return apiaddketowagon(requestdata);
}

// Выполнить ремонт СЧ по форме.
function repairke(params) {
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	if (isEmptyString(params.operation_date)) {
		return badResp("Необходимо указать \"Дата проведения операции\".");
	}

	if (isEmptyString(params.type_malfunction)) {
		return badResp("Необходимо указать \"Код неисправности\".");
	}

	if (isEmptyString(params.type_work_performed)) {
		return badResp("Необходимо указать \"Вид ремонта\".");
	}

	if (isEmptyString(params.work_performed)) {
		return badResp("Необходимо указать \"Выполненные работы\".");
	}

	var type_malfunction = db.findbyrecid("dictionary_type_malfunction_pressure_beam", params.type_malfunction);
	var type_work_performed = db.findbyrecid("dictionary_type_work_performed", params.type_work_performed);
	var work_performed = db.findbyrecid("dictionary_work_performed", params.work_performed);

	var type_malfunction_code = !!type_malfunction
		? type_malfunction.code
		: null;

	var type_work_performed_code = !!type_work_performed
		? type_work_performed.code
		: null;

	var work_performed_recname = !!work_performed
		? work_performed.recname
		: null;

	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);

	if (isNullObject(reestr_key_element)) {
		return badResp("составная часть '" + params.recid + "' не найден в системе.");
	}

	var nodeip = getnodeipbymember(reestr_key_element.owner);

	var repairbch = {
		"nodeip": nodeip,
		"link":
			{
				"hash": reestr_key_element.blockchainhash,
				"node": reestr_key_element.blockchainnode,
				"recn": reestr_key_element.blockchainrecn,
				"tn": reestr_key_element.blockchaintn
			},
		"repair_info":
			{
				"comments": work_performed_recname
			}
	};

	var blockchainResponse = repairblockchain(repairbch);

	if (!!blockchainResponse.result) {
		// Ремонт
		var logItem = set_ke_log(reestr_key_element, "814af3e7-3207-47a8-a47c-4a8678e1467d");
		// Убрано из логов в рамках https://rm.mfc.ru/issues/42476
		// // Вид выполненного ремонта
		// "type_work_performed": params.type_work_performed,
		// // Код неисправности
		// "malfunction_code": !!type_malfunction
		// 	? type_malfunction.code + " " + type_malfunction.recname
		// 	: "",
		// // Выполненные работы
		// "works_performed": params.work_performed,

		res = res && db.insert("log", logItem);

		reestr_key_element.last_blockchain_request = JSON.stringify(repairbch, null, '\t');

		res = res && db.update("reestr_key_elements", reestr_key_element);

		event.log("reestr_key_elements",
			params.recid,
			"СЧ с номером " + reestr_key_element.numberke + " отправлен в ремонт. Тип ремонта: " + work_performed_recname + ".",
			eventTypeEnum.Info,
			repairbch);
	}
	else {
		return blockchainResponse;
	}

	if (isparamsvalid) {
	}
	else {
		return {
			success: false,
			message: errormessage
		};
	}

	return res;
}

// Получить идентификатор узла блокчейна по участнику.
function getnodeipbymember(ownerid) {
	var nodeip;
	if (!!ownerid) {
		var reestr_members = db.findbyrecid("reestr_members", ownerid);
		if (!!reestr_members && !!reestr_members.idclientnode) {
			var reestr_nodes = db.findbyrecid("reestr_nodes", reestr_members.idclientnode);
			if (!!reestr_nodes && !!reestr_nodes.ip_address) {
				nodeip = reestr_nodes.ip_address;
			}
		}
	}

	return nodeip;
}

// Сменить собственника по форме.
function changeownerke(params) {
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	var oldnodeip = getnodeipbymember(reestr_key_element.owner);

	var reestr_members = db.findbyrecid("reestr_members", params.new_owner);
	var reestr_nodes = db.findbyrecid("reestr_nodes", reestr_members.idclientnode);

	var res = true;
	if (!!reestr_key_element) {
		
		var changebch = {
			"nodeip": oldnodeip,
			"link":
				{
					"hash": reestr_key_element.blockchainhash,
					"node": reestr_key_element.blockchainnode,
					"recn": reestr_key_element.blockchainrecn,
					"tn": reestr_key_element.blockchaintn
				},
			"owner": reestr_nodes.node_id
		};

		var changeresultblockchain = changeownerlockchain(changebch);
		
		if (!!changeresultblockchain &&
			!!changeresultblockchain.result) {
			
			var logItem = set_ke_log(reestr_key_element, "7745d6ac-854b-431c-8ef8-28215c4dd49f");
			// Убрано из логов в рамках https://rm.mfc.ru/issues/42476
			// "member": params.new_owner,
			// "reason_transfer_ke": params.reason,

			reestr_key_element.owner = params.new_owner;
			reestr_key_element.statuske = commonConst.PeradanId;
			reestr_key_element.recupdated = new Date().toISOString();
			reestr_key_element.recupdatedby = "js";
			reestr_key_element.last_blockchain_request = JSON.stringify(changebch, null, '\t');

			res = res && db.update("reestr_key_elements", reestr_key_element);

			db.insert("log", logItem);
		}
		else {
			return changeresultblockchain;
		}
	}
	return res;
}

//a.polunina убрала в рамках задачи https://rm.mfc.ru/issues/46142
// // Утилизировать СЧ по форме.
// function recyclingke(params) {
// 	var res = true;
// 	var isparamsvalid = true;
// 	var errormessage = "Ошибка в параметрах. ";

// 	if (isEmptyString(params.recycling_type)) {
// 		params.recycling_type = 1;
// 	}

// 	if (isEmptyString(params.reason)) {
// 		return badResp("Необходимо указать \"Причина утилизации\".");
// 	}

// 	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);

// 	if (isNullObject(reestr_key_element)) {
// 		return badResp("составная часть '" + params.recid + "' не найден в системе.");
// 	}

// 	var nodeip = getnodeipbymember(reestr_key_element.owner);

// 	var recyclingbch = {
// 		"nodeip": nodeip,
// 		"link":
// 			{
// 				"hash": reestr_key_element.blockchainhash,
// 				"node": reestr_key_element.blockchainnode,
// 				"recn": reestr_key_element.blockchainrecn,
// 				"tn": reestr_key_element.blockchaintn
// 			}
// 	};

// 	var blockchainResponse = recyclingblockchain(recyclingbch);

// 	if (!!blockchainResponse.result) {
// 		// Утилизация
// 		var logItem = set_ke_log(reestr_key_elementsTmp, "65a774bb-64e6-4eca-b60e-a0e1438af55e", !!node ? node.unique_number : null, !!node ? node.ke_node_type : null);
// 		// Убрано из логов в рамках https://rm.mfc.ru/issues/42476
// 		// // Причина утилизации
// 		// "utilization_reason": params.reason,
// 		// // Тип утилизации
// 		// "utilization_type": params.recycling_type,

// 		res = res && db.insert("log", logItem);

// 		// Утилизация
// 		reestr_key_element.statuske = "32f6eded-2f6e-4ce8-a4d9-5f0378e4c3b0";
// 		reestr_key_element.last_blockchain_request = JSON.stringify(recyclingbch, null, '\t');

// 		res = res && db.update("reestr_key_elements", reestr_key_element);

// 		event.log("reestr_key_elements",
// 			params.recid,
// 			"Утилизирован СЧ с номером " + reestr_key_element.numberke + ".",
// 			eventTypeEnum.Info,
// 			recyclingbch);
// 	}
// 	else {
// 		return blockchainResponse;
// 	}

// 	if (isparamsvalid) {
// 	}
// 	else {
// 		return {
// 			success: false,
// 			message: errormessage
// 		};
// 	}

// 	return res;
// }

// function getrandomint(min, max) {
//     min = Math.ceil(min);
//     max = Math.floor(max);
//     return Math.floor(Math.random() * (max - min + 1)) + min;
// }

// function generaterfidnumber(letteralphabet) {
// 	var rfidnumber = "";

// 	for (var i = 0; i < 12; i++) {
// 		rfidnumber += letteralphabet[getrandomint(0, letteralphabet.length - 1)];
// 	}

// 	return rfidnumber;
// }

// // Сгенерировать номера СЧ.
// function generaterfid(params) {
// 	var rfidRequest = db.findbyrecid("rfid_request", params.recid);
// 	var res = true;

// 	if ((rfidRequest.rfid_request_status.toString() == "1") || (rfidRequest.rfid_request_status.toString() == "2") || (rfidRequest.rfid_request_status.toString() == "6") || (rfidRequest.rfid_request_status.toString() == "9")) {
// 		var letteralphabet = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "C", "E", "T", "B", "M", "H", "K", "P", "O", "X"];

// 		if (rfidRequest.count == null
// 			|| rfidRequest.count === "undefined"
// 			|| parseInt(rfidRequest.count) <= 0) {
// 			return {
// 				success: false,
// 				message: "Указано неверное количество номеров для генерации"
// 			};
// 		}

// 		if (parseInt(rfidRequest.count) > 1000) {
// 			return badResp("Нельзя сгенерировать больше 1000 УИН в одном пуле. Сгенерируйте несколько пулов, указав в каждом меньше 1000 УИН.");
// 		}

// 		var member = null;
// 		if(isEmptyString(rfidRequest.requestor_id_from_op)){
// 			if(isEmptyString(rfidRequest.requestor_id)){
// 				return badResp("Не удалось определить владельца пула номеров")
// 			}else{
// 				member = rfidRequest.requestor_id;
// 			}
// 		}else{
// 			member = rfidRequest.requestor_id_from_op;
// 		}

// 		for (var i = 0; i < parseInt(rfidRequest.count); i++) {
// 			var rfidnumber = "";

// 			do {
// 				rfidnumber = generaterfidnumber(letteralphabet);

// 				var ke_numbers_params = {
// 					"recname": rfidnumber
// 				};

// 				var kenumbers = db.findbyparams("ke_numbers", ke_numbers_params);
// 			}
// 			while (!!kenumbers);

// 			var ke_number = {
// 				"recname": rfidnumber,
// 				"rfid_request": rfidRequest.recid,
// 				"issuer": member,
// 				"generate_date": new Date().toISOString(),
// 				"status": "52e9190f-f319-4199-9308-cee6d7c79e31",
// 				"number_status": "f0849fb8-def2-405d-9166-d4c8866202b6"
// 			};

// 			db.insert("ke_numbers", ke_number);
// 		}

// 		rfidRequest.rfid_request_status = 3;
// 		rfidRequest.requestor_id = member;

// 		res = res && db.update("rfid_request", rfidRequest);
// 	}

// 	return {
// 		success: true,
// 		message: "Номера успешно сгенерированы"
// 	};
// }

function validatereestrpartstype(params) {
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	var reestr_parts_type = db.findbyrecid("reestr_parts_type", params.reestr_parts_type);

	// Тип составной части
	var ke_type = db.findbyrecid("dictionary_key_elements_codes", reestr_parts_type.key_element_code);

	var validationRes = {
		"isparamsvalid": isparamsvalid,
		"errormessage": errormessage
	};

	return validationRes;
}

/**
 * Сканирование номера СЧ для оператора РЖД
 * @param {*} params 
 */
function rzd_op_scannumber(params){
	//Проверка поля "Владелец"
	if(isEmptyString(params.member)){
		return badResp("Поле \"Владелец\" не может быть пустым");
	}
	var member = db.findbyrecid("reestr_members", params.member);
	if(isNullObject(member)){
		return badResp("Владелец не найден в системе");
	}

	return scannumber(params);
}
/**
 * Формирование запроса в блокчейн и json файла паспорта
 * @param {*} param 
 */
function formkeyelementpassportfile(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	var error_message_arr = []; //Создаем пустой массив, куда будем записывать ошибки при формировании запроса и json паспорта
	var success_message_arr = []; //Создаем пустой массив, куда будем записывать успешные операции
	var result_arr = []; //Массив с результатами выполнения по каждому элементу для передачи в следующий метод (registersignedkeyelementpassport)
	if(params.recordIdList != null){
		for(var i = 0; i < params.recordIdList.length; i++){
			var headers = {
				"Content-Type": "application/json"
			};
			var headers = addAuthHeader(headers);
			var url = String().concat(host, "/plugins/nbdlogicplugin/createkeyelementpassport/", params.recordIdList[i].toString())
			var res = fetch(url, {
				headers: headers,
				"body": JSON.stringify(params),
				"Method": "post"
			});
			var result_parse = JSON.parse(res.data);

			if(isNotEmptyString(result_parse)){
				if (result_parse.success != false){
					success_message_arr.push(result_parse.message);
				} else {
					error_message_arr.push(result_parse.message);
				}
				result_parse.recid = params.recordIdList[i].toString();
				result_arr.push(result_parse);
			} else{
				return res;
			}
		}
	
		// Добавляем разделитель ";" между сообщениями
		var success_message = success_message_arr.join("; "); 
		var error_message = error_message_arr.join("; "); 
		//Если при обработке всех выбранных записей были получены ошибки, выдаём сообщение об этом
		if (error_message_arr.length == params.recordIdList.length){
			return badResp(error_message);
		} else {
			//В случае одного элемента - выводим сообщение как есть
			if(params.recordIdList.length == 1){
				return successResp(success_message, result_arr);
			} else {
			// иначе - выводим сообщения о количестве успешно обработанных элементов и тексты ошибок, плюс информацию об ошибках и успешных операциях - возвращаем для следующего метода
			var message_text = String().concat(success_message_arr.length, " из ", params.recordIdList.length, " действий выполнено. ", error_message);
			return successResp(message_text, result_arr);
			}
		}
	}else{
		return badResp("Массив идентификаторов равен null")
	}
}

/**
 * Подписание json файла паспорта
 * @param {*} param 
 */
function signkeyelementpassportfile(params){
	if(params.recordIdList != null){
		for(var i = 0; i < params.recordIdList.length; i++){
			var headers = {
				"Content-Type": "application/json"
			};
			var headers = addAuthHeader(headers);
			var url = String().concat(host, "/plugins/nbdlogicplugin/signkeyelementpassport/", params.recordIdList[i].toString())
			var res = fetch(url, {
				headers: headers,
				"body": JSON.stringify(params),
				"Method": "post"
			});
			if(isNotEmptyString(res.data)){
				return JSON.parse(res.data)
			}else{
				return res;
			}
		}
	}else{
		return badResp("Массив идентификаторов равен null")
	}
}

/**
 * Выпуск в обращение подписанного паспорта
 * @param {*} param 
 */
function registersignedkeyelementpassport(params){
	// if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
	// 	params.values.recid = params.recid
	// 	params = params.values;
	// };
	var error_message_arr = []; //Создаем пустой массив, куда будем записывать ошибки при формировании запроса и json паспорта
	var success_message_arr = []; //Создаем пустой массив, куда будем записывать успешные операции
	//т.к. метод вызывается из списка задач workflow, обрабатываем не params.recordIdList, а специально подготовленный объект params.data из метода formkeyelementpassportfile
	if(params.data != null){
		for(var i = 0; i < params.data.length; i++){
			if(params.data[i].success){
				var headers = {
					"Content-Type": "application/json"
				};
				var headers = addAuthHeader(headers);
				var url = String().concat(host, "/plugins/nbdlogicplugin/registersignedkeyelementpassport/", params.data[i].recid.toString())
				var res = fetch(url, {
					headers: headers,
					"body": JSON.stringify(params),
					"Method": "post"
				});
				var result_parse = JSON.parse(res.data);
				
				if(isNotEmptyString(result_parse)){
					if (result_parse.success != false){
						success_message_arr.push(result_parse.message);
					} else {
						error_message_arr.push(result_parse.message);
					}
				}else{
					return res;
				}
			}
		}
		if (error_message_arr.length > 0){
			var error_message = error_message_arr.join("; "); // Добавляем разделитель ";" между сообщениями
			var message_text = success_message_arr.length>0 ? String().concat(success_message_arr.length, " из ", params.countOfSelectedRecords, " действий выполнено. ", error_message) : error_message; //Указываем количество успешных действий, если они были
			return badResp(message_text);
		} else {
			var success_message = success_message_arr.join("; "); // Добавляем разделитель ";" между сообщениями
			return successResp(success_message);
		}
	}else{
		return badResp("Массив идентификаторов равен null")
	}
}



/**
 * Сканирование номера СЧ
 * @param {*} params 
 */
function scannumber(params) {
	var headers = {
		"Content-Type": "application/json"
	};
	var headers = addAuthHeader(headers);
	var url = String().concat(host, "/plugins/nbdlogicplugin/kescannumber/", params.recid.toString())
	var res = fetch(url, {
		headers: headers,
		"body": JSON.stringify(params),
		"Method": "post"
	});
	if(isNotEmptyString(res.data)){
		return JSON.parse(res.data)
	}else{
		return res;
	}
}


/**
 * Валидация составной части на уникальность по параметрам
 * manufacturer_details Сведения об изготовителе
 * manufacturer_number Номер по системе предприятия изготовителя
 * date_manufacture Дата изготовления
 * key_element_code тип СЧ
 * Среди тех, что уже выпущены в обращение
 * @param {*} params 
 */
function validate_dublicate_elements(params){
	//выбираем все СЧ с набором одинаковых параметров, которые корректно обрабатывает findbyparams
	//остальные проверяем далее
	var dublicate_key_elements = db.findbyparams("reestr_key_elements", {
		"manufacturer_details": params.manufacturer_details,
		//"manufacturer_number": params.manufacturer_number,
		"key_element_code": params.key_element_code
	});

	if (isNotEmptyOrNullArray(dublicate_key_elements)) {
		for (let i = 0; i < dublicate_key_elements.length; i++) {
			//Проверяем что совпадают номера по системе предприятия изготовителя
			if (dublicate_key_elements[i].manufacturer_number == params.manufacturer_number) {

				//Проверяем что элемент выпущен в обращение
				//"Выпущен в обращение", "Установлен на ТС", "Снят с ТС"
				if (dublicate_key_elements[i].statuske == "c82c2eb8-0cf9-4693-8a2b-c6bf605c97ab" //Выпущен в обращение
					|| dublicate_key_elements[i].statuske == "a0b630bc-fbed-4863-9053-6cec9ee3a459" //Установлен на ТС
					|| dublicate_key_elements[i].statuske == "259762d5-2ee4-4acb-a2c7-18593cb6cc4f" //Снят с ТС
				) {
					var date_params = new Date(params.date_manufacture);
					date_params.setHours(date_params.getUTCHours() + 3);
					date_params.setUTCHours(0, 0, 0, 0);
					var date_exist = new Date(dublicate_key_elements[i].date_manufacture);
					date_exist.setHours(date_exist.getUTCHours() + 3);
					date_exist.setUTCHours(0, 0, 0, 0);

					if (date_params.getTime() == date_exist.getTime()) {
						return badResp("В системе уже зарегистрирована СЧ такого типа с указанными  \"Дата изготовления\", \"Номер по системе предприятия изготовителя\", \"Сведения об изготовителе\" ")
					}
				}
			}
		}
	}
	return successResp();
}

/**
 * Формирование объекта СЧ для блокчейна
 * @param {*} params //Параметры запроса
 */
function form_key_element_object_for_blockchain(params){
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	if (isNullObject(reestr_key_element)) {
		return badResp("составная часть не найден в системе.");
	}

	var error_message_head = "Не удалось выпустить в обращение СЧ <a href=\"/tables/reestr_key_elements/"+ reestr_key_element.recid +"\" target=\"_blank\" class=\"alert-link\">"+ reestr_key_element.numberke +"</a> : ";
	if (reestr_key_element.statuske != commonConst.GotovId) {
		return badResp(error_message_head + "составная часть в текущем статусе нельзя выпустить в обращение.");
	}

	// ke_number (УИН)
	if (isEmptyString(reestr_key_element.ke_number)) {
		return badResp(error_message_head + "требуется заполнить обязательное поле - УИН.");
	}
	var ke_number = db.findbyrecid("ke_numbers", reestr_key_element.ke_number);
	if (isNullObject(ke_number)) {
		return badResp(error_message_head + "УИН не найден в системе.");
	}

	// method_of_marking (Способ (тип) маркировки)
	if (isEmptyString(reestr_key_element.method_of_marking)) {
		return badResp(error_message_head + "требуется заполнить обязательное поле - Способ (тип) маркировки.");
	}
	var dictionary_method_of_marking = db.findbyrecid("dictionary_method_of_marking", reestr_key_element.method_of_marking);
	if (isNullObject(dictionary_method_of_marking)) {
		return badResp(error_message_head + "способ (тип) маркировки СЧ не найден в системе.");
	}

	// key_element_code (Наименование изделия)
	if (isEmptyString(reestr_key_element.key_element_code)) {
		return badResp(error_message_head + "требуется заполнить обязательное поле - Наименование изделия.");
	}
	var dictionary_key_elements_codes = db.findbyrecid("dictionary_key_elements_codes", reestr_key_element.key_element_code);
	if (isNullObject(dictionary_key_elements_codes)) {
		return badResp(error_message_head + "наименование изделия не найдено в системе.");
	}

	// documentation_number (Обозначение изделия)
	if (isEmptyString(reestr_key_element.documentation_number)) {
		return badResp(error_message_head + "требуется заполнить обязательное поле - Обозначение изделия.");
	}
	var reestr_documentation = db.findbyrecid("reestr_documentation", reestr_key_element.documentation_number);
	if (isNullObject(reestr_documentation)) {
		return badResp(error_message_head + "обозначение изделия не найдено в системе.");
	}

	// date_manufacture (Дата изготовления)
	if (isEmptyString(reestr_key_element.date_manufacture)) {
		return badResp(error_message_head + "требуется заполнить обязательное поле - Дата изготовления.");
	}

	// manufacturer_details (Сведения об изготовителе)
	if (isEmptyString(reestr_key_element.manufacturer_details)) {
		return badResp(error_message_head + "требуется заполнить обязательное поле - Сведения об изготовителе.");
	}
	
	var manufacturer_details = db.findbyrecid("reestr_members", reestr_key_element.manufacturer_details);
	if (isNullObject(manufacturer_details)) {
		return badResp(error_message_head + "сведения об изготовителе не найдены в системе.");
	}

	//Получение ip адреса блокчейна
	var nodeip = null;
	if(isEmptyString(params.memberid)){
		nodeip = getnodeipbymember(reestr_key_element.owner);
	}else{
		nodeip = getnodeipbymember(params.memberid);
	}
	if (isEmptyString(nodeip)) {
		return badResp(error_message_head + "не удалось определить IP адрес блокчейна.");
	}

	var date_manufacture = new Date(reestr_key_element.date_manufacture);

	// Выпуск в обращение в блокчейне
	var add_object_blockchain = {
		"nodeip": nodeip,

		// тип СЧ
		"ke_type": dictionary_key_elements_codes.recname,
		// Наименование по НД
		"ke_normative_name": dictionary_key_elements_codes.normative_name.trim(),
		// УИН
		"ke_number": ke_number.recname,
		// Способ (тип) маркировки
		"method_of_marking" : dictionary_method_of_marking.reccode,
		// Наименование изделия
		"key_element_code": dictionary_key_elements_codes.reccode,
		// Обозначение изделия
		"documentation_number": reestr_documentation.detail,
		// Дата изготовления
		"date_manufacture": date_manufacture.getUTCFullYear() +
			'-' + (date_manufacture.getUTCMonth() + 1).toString().padStart(2, 0) +
			'-' + (date_manufacture.getUTCDate()).toString().padStart(2, 0),
		// Сведения об изготовителе
		"manufacturer_details": manufacturer_details.fullname,
	};

	// Балка надрессорная
	if (reestr_key_element.key_element_code == keyElementCodes.pressure_beam_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}
		
		// life_time (Срок службы)
		if (isEmptyString(reestr_key_element.life_time)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Срок службы.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;
			 
		// melt_number (Номер плавки)
		if (isEmptyString(reestr_key_element.melt_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер плавки.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp("Марка материала не найдена в системе.");
		}

		// administration_code (Код государства собственника детали)
		if (isEmptyString(reestr_key_element.administration_code)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Код государства собственника детали.");
		}
		
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		var dictionary_administration_codes = db.findbyrecid("dictionary_administration_codes", reestr_key_element.administration_code);
		if (isNullObject(dictionary_administration_codes)) {
			return badResp(error_message_head + "Код государства собственника детали не найден в системе.");
		}
		/*
		//complete_set_sender (Предприятие, отправившее комплектацию)
		if(isEmptyString(reestr_key_element.complete_set_sender)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Предприятие, отправившее комплектацию");
		}
		*/
		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Срок службы
		add_object_blockchain.life_time = reestr_key_element.life_time;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Номер плавки
		add_object_blockchain.melt_number = reestr_key_element.melt_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		// Код государства собственника детали
		add_object_blockchain.administration_code = dictionary_administration_codes.reccode;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Рама боковая
	if (reestr_key_element.key_element_code == keyElementCodes.side_frame_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}
		
		// life_time (Срок службы)
		if (isEmptyString(reestr_key_element.life_time)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Срок службы.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// melt_number (Номер плавки)
		if (isEmptyString(reestr_key_element.melt_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер плавки.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		// administration_code (Код государства собственника детали)
		if (isEmptyString(reestr_key_element.administration_code)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Код государства собственника детали.");
		}
		var dictionary_administration_codes = db.findbyrecid("dictionary_administration_codes", reestr_key_element.administration_code);
		if (isNullObject(dictionary_administration_codes)) {
			return badResp(error_message_head + "Код государства собственника детали не найден в системе.");
		}

		// slip_knots_distance (Расстояние между наружными упорными поверхностями буксового проема (количество шишек))
		if (isEmptyString(reestr_key_element.slip_knots_distance)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Расстояние между наружными упорными поверхностями буксового проема (количество шишек).");
		}
		
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}
		/*
		//complete_set_sender (Предприятие, отправившее комплектацию)
		if(isEmptyString(reestr_key_element.complete_set_sender)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Предприятие, отправившее комплектацию");
		}
		*/
		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Срок службы
		add_object_blockchain.life_time = reestr_key_element.life_time;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Номер плавки
		add_object_blockchain.melt_number = reestr_key_element.melt_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		// Код государства собственника детали
		add_object_blockchain.administration_code = dictionary_administration_codes.reccode;
		// Расстояние между наружными упорными поверхностями буксового проема (количество шишек)
		add_object_blockchain.slip_knots_distance = reestr_key_element.slip_knots_distance;
		//	Сведения об изготовителе заготовки
			add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Адаптер подшипника, Корпус скользуна, Колпак скользуна, Планка фрикционная, Скоба, Пластины в клиновых карманах, Кольцо в подпятник, Вкладыш подпятника
	if (dictionary_key_elements_codes.recid == keyElementCodes.bearing_adapter_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.slider_body_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.slider_cap_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.friction_strip_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.brace_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.wedge_pockets_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.saddle_ring_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.wedge_pockets_inserts_id
		|| dictionary_key_elements_codes.recid == keyElementCodes.saddle_bearing_id) {
		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	//Клин фрикционный
	if (dictionary_key_elements_codes.recid == keyElementCodes.friction_wedge_id) {
		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		// Т.к. у Клина фрикционного добавлено поле manufacturer_number, которое отображается в засимости от чек бокса point_to_manufacturer_number,
		// выполнена данная провека, для отправки разных запросов в блокчейн
		if (isNotEmptyString(reestr_key_element.manufacturer_number)) {

			//проверка на уникальность по дате, номеру, заводу, типу
			var validate_dublicate = validate_dublicate_elements(reestr_key_element);
			if(!validate_dublicate.success){
				return validate_dublicate;
			}
			/*
			if (isEmptyString(reestr_key_element.manufacturer_number)) {
				return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
			}*/
			//	Номер изделия по системе нумерации предприятия-изготовителя
			add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		}
		
		
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
		
	}

	//Сменный ЖД кузов
	if(dictionary_key_elements_codes.recid == keyElementCodes.removable_railway_carcass_id){
		// life_time (Срок службы)
		if (isEmptyString(reestr_key_element.life_time)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Срок службы.");
		}

		//individual_features (Индивидуальные особенности)
		if (isEmptyString(reestr_key_element.individual_features)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Индивидуальные особенности.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		// carcass_load_capacity (Грузоподъемность)
		reestr_key_element.carcass_load_capacity = reestr_key_element.carcass_load_capacity.replace(",", "\.");
		if (isEmptyString(reestr_key_element.carcass_load_capacity)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Грузоподъемность.");
		}
		if(isNaN(reestr_key_element.carcass_load_capacity)){
			return badResp(error_message_head + "Грузоподъемность не число");
		}
		var carcass_load_capacity_parsed = parseFloat(reestr_key_element.carcass_load_capacity);
		if(carcass_load_capacity_parsed < 0){
			return badResp(error_message_head + "Грузоподъемность отрицательна");
		}

		// carcass_volume (Объем кузова (котла))
		reestr_key_element.carcass_volume = reestr_key_element.carcass_volume.replace(",", "\.");
		if (isEmptyString(reestr_key_element.carcass_volume)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Объем кузова (котла).");
		}
		if(isNaN(reestr_key_element.carcass_volume)){
			return badResp(error_message_head + "Объем кузова не число");
		}
		var carcass_volume_parsed = parseFloat(reestr_key_element.carcass_volume);
		if(carcass_volume_parsed < 0){
			return badResp(error_message_head + "Объем кузова отрицательный");
		}

		//tare_max_weight (Масса тары максимальная)
		reestr_key_element.tare_max_weight = reestr_key_element.tare_max_weight.replace(",", "\.");
		if (isEmptyString(reestr_key_element.tare_max_weight)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Масса тары максимальная.");
		}
		if(isNaN(reestr_key_element.tare_max_weight)){
			return badResp(error_message_head + "Масса тары не число");
		}
		var tare_max_weight_parsed = parseFloat(reestr_key_element.tare_max_weight);
		if(tare_max_weight_parsed < 0){
			return badResp(error_message_head + "Масса тары отрицательна");
		}

		//specialization (Специализация)
		if (isEmptyString(reestr_key_element.specialization)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Специализация.");
		}

		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", reestr_key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// Срок службы
		add_object_blockchain.life_time = reestr_key_element.life_time;
		// Индивидуальные особенности
		add_object_blockchain.individual_features = reestr_key_element.individual_features;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		// Грузоподъемность
		add_object_blockchain.carcass_load_capacity = reestr_key_element.carcass_load_capacity.toString();
		// Объем кузова (котла)
		add_object_blockchain.carcass_volume = reestr_key_element.carcass_volume.toString();
		// Масса тары максимальная
		add_object_blockchain.tare_max_weight = reestr_key_element.tare_max_weight.toString();
		// Специализация
		var dictionary_spec = db.findbyrecid("dictionary_specializations", reestr_key_element.specialization)
		if(isNullObject(dictionary_spec)){
			return badResp(error_message_head + "Информация о специализации не найдена в системе")
		}
		add_object_blockchain.specialization = dictionary_spec.spec_name;
		// Технические условия
		add_object_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();
	}

	// Ось чистовая
	if (reestr_key_element.key_element_code == keyElementCodes.clear_axis_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// rough_axis_manufacturing_date  (Год изготовления черновой оси)
		if (isEmptyString(reestr_key_element.rough_axis_manufacturing_date)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Год изготовления черновой оси.");
		}

		// rough_axis_number (Номер черновой оси)
		var rough_axis_number = null;
		if (reestr_key_element.has_rough_axis_number != null && reestr_key_element.has_rough_axis_number) {
			if (isEmptyString(reestr_key_element.rough_axis)) {
				return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер черновой оси.");
			}

			var rough_axis = db.findbyrecid("reestr_key_elements", reestr_key_element.rough_axis);
			if (isNullObject(rough_axis)) {
				return badResp(error_message_head + "Ось черновая, указанная в оси чистовой, не найдена в системе.");
			}

			// Проверяем, что указанная черновая ось уже не указана у другой чистовой оси 
			var key_elements_by_rough_axis_params = {
				"rough_axis": reestr_key_element.rough_axis
			};
			var key_elements_by_rough_axis = db.findbyparams("reestr_key_elements", key_elements_by_rough_axis_params);
			if (key_elements_by_rough_axis.length > 1) {
				for (var i = 0; i < key_elements_by_rough_axis.length; i++) {
					if (key_elements_by_rough_axis[i] != reestr_key_element.recid) {
						return badResp(error_message_head + "Ось черновая, указанная в оси чистовой, уже указана для СЧ с УИН " + key_elements_by_rough_axis[i].numberke + ".");
					}
				}
			}

			rough_axis_number = rough_axis.manufacturer_number;
		}
		else {
			if (isEmptyString(reestr_key_element.rough_axis_number)) {
				return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер черновой оси.");
			}

			rough_axis_number = reestr_key_element.rough_axis_number;
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}
		/*
		//Предприятие, отправившее комплектацию
		if(isEmptyString(reestr_key_element.complete_set_sender)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Предприятие, отправившее комплектацию");
		}
		*/

		/* //Предприятие полного освидетельствования
		if(isEmptyString(reestr_key_element.depo_complete_survey)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Предприятие полного освидетельствования");
		}
		
		//Дата освидетельствования
		if(isEmptyString(reestr_key_element.date_install)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Дата освидетельствования");
		} */

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Год изготовления черновой оси
		add_object_blockchain.rough_axis_manufacturing_date = reestr_key_element.rough_axis_manufacturing_date;
		// Номер черновой оси
		add_object_blockchain.rough_axis_number = rough_axis_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Колесо
	if (reestr_key_element.key_element_code == keyElementCodes.wheel_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// melt_number  (Номер плавки.)
		if (isEmptyString(reestr_key_element.melt_number )) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер плавки.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp("Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Убрано в рамказ задачи #42947
		// //wheel_width (Толщина обода)
		// if(!isEmptyString(reestr_key_element.wheel_width)){
		// 	reestr_key_element.wheel_width = reestr_key_element.wheel_width.replace(",", "\.");
		// 	if(isNotEmptyString(reestr_key_element.wheel_width)){
		// 		if(isNaN(reestr_key_element.wheel_width)){
		// 			return badResp(error_message_head + "Толщина обода не число");
		// 		}
		// 		var wheel_width_parsed = parseFloat(reestr_key_element.wheel_width);
		// 		if(wheel_width_parsed < 0){
		// 			return badResp(error_message_head + "Толщина обода отрицательна");
		// 		}
		// 	}
		// }/* else{
		// 	return badResp(error_message_head + "Требуется заполнить обязательное поле - Толщина обода.");
		// } */
		

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Номер плавки
		add_object_blockchain.melt_number = reestr_key_element.melt_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	//Замок
	if (reestr_key_element.key_element_code == keyElementCodes.lock_id
		|| reestr_key_element.key_element_code == keyElementCodes.elevator_roll_id) {
		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}
		
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	//Корпус автосцепки
	if (reestr_key_element.key_element_code == keyElementCodes.auto_coupler_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		//coupling_model (Модель автосцепки)
		if(isEmptyString(reestr_key_element.coupling_model)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Модель автосцепки");
		}
		var dictionary_coupling_model = db.findbyrecid("dictionary_couplings_models", reestr_key_element.coupling_model);
		if (isNullObject(dictionary_coupling_model)) {
			return badResp(error_message_head + "Модель автосцепки не найдена в системе");
		}

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
		//Модель автосцепки
		add_object_blockchain.coupling_model = dictionary_coupling_model.coupling_name;
	}

	// Упоры передний и задний объединенные
	if (reestr_key_element.key_element_code == keyElementCodes.front_rear_detents_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}
		
		// life_time (Срок службы)
		if (isEmptyString(reestr_key_element.life_time)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Срок службы.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}
		
		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// life_time (Срок службы)
		if (isEmptyString(reestr_key_element.life_time)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Срок службы.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		// administration_code (Код государства собственника детали)
		if (isEmptyString(reestr_key_element.administration_code)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Код государства собственника детали.");
		}
		var dictionary_administration_codes = db.findbyrecid("dictionary_administration_codes", reestr_key_element.administration_code);
		if (isNullObject(dictionary_administration_codes)) {
			return badResp(error_message_head + "Код государства собственника детали не найден в системе.");
		}

		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", reestr_key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Срок службы
		add_object_blockchain.life_time = reestr_key_element.life_time;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Срок службы
		add_object_blockchain.life_time = reestr_key_element.life_time;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		// Код государства собственника детали
		add_object_blockchain.administration_code = dictionary_administration_codes.reccode;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
		// Технические условия
		add_object_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();
	}

	// Крышка люка полувагона
	if (reestr_key_element.key_element_code == keyElementCodes.gondola_hatch_id) {
		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
	}

	// Пружина рессорного подвешивания наружная
	if (reestr_key_element.key_element_code == keyElementCodes.spring_outside_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
			add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Пружина рессорного подвешивания внутренняя
	if (reestr_key_element.key_element_code == keyElementCodes.spring_inside_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}

		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}



		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
			add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}
	
	// Пружина скользуна наружная
	if (reestr_key_element.key_element_code == keyElementCodes.spring_slider_outside_id) {
		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Пружина скользуна внутренняя
	if (reestr_key_element.key_element_code == keyElementCodes.spring_slider_inside_id) {
		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
			add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Подшипник буксового узла
	if (reestr_key_element.key_element_code == keyElementCodes.bearing_node_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", reestr_key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}
		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Технические условия
		add_object_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();
	}

	// Ось черновая
	if (reestr_key_element.key_element_code == keyElementCodes.rough_axis_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;
			
		// melt_number (Номер плавки)
		if (isEmptyString(reestr_key_element.melt_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер плавки.");
		}

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		// Номер плавки
		add_object_blockchain.melt_number = reestr_key_element.melt_number;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Корпус поглощающего аппарата
	if (reestr_key_element.key_element_code == keyElementCodes.absorbing_device_body_id) {

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}
		
		//absorbing_device_body_model (Модель корпуса поглощающего аппарата)
		if(isEmptyString(reestr_key_element.absorbing_device_body_model)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Модель корпус поглощающего аппарата");
		}
		var dictionary_absorbing_device_body_model = db.findbyrecid("dictionary_absorbing_device_body_models", reestr_key_element.absorbing_device_body_model);
		if (isNullObject(dictionary_absorbing_device_body_model)) {
			return badResp(error_message_head + "Модель корпус поглощающего аппарата не найдена в системе");
		}
		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Обозначение модели
		add_object_blockchain.absorbing_device_body_model = dictionary_absorbing_device_body_model.recname;
	}

	// Хомут тяговый
	if (reestr_key_element.key_element_code == keyElementCodes.traction_clamp_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		// steel_grade (Марка материала)
		if (isEmptyString(reestr_key_element.steel_grade)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Марка материала.");
		}
		var dictionary_steel_grade = db.findbyrecid("dictionary_steel_grade", reestr_key_element.steel_grade);
		if (isNullObject(dictionary_steel_grade)) {
			return badResp(error_message_head + "Марка материала не найдена в системе.");
		}
		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		}

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Марка материала
		add_object_blockchain.steel_grade = dictionary_steel_grade.recname;
		//	Сведения об изготовителе заготовки
		add_object_blockchain.billet_manufacturer_info = reestr_key_element.billet_manufacturer_info;
	}

	// Авторежим грузовой
	if (reestr_key_element.key_element_code == keyElementCodes.auto_mode_cargo_id) {
		// certificate_number (Сведения о сертификате соответствия)
		if (isEmptyString(reestr_key_element.certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения о сертификате соответствия.");
		}
		var reestr_certificates = db.findbyrecid("reestr_certificates", reestr_key_element.certificate_number);
		if (isNullObject(reestr_certificates)) {
			return badResp(error_message_head + "Сведения о сертификате соответствия не найдены в системе.");
		}

		// ke_manufacturer (Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.ke_manufacturer)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя.");
		}
		var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.ke_manufacturer);
		if (isNullObject(ke_manufacturer)) {
			return badResp(error_message_head + "Предприятие-изготовитель не найден в системе.");
		}

		// branding_code_certificate_number (Регистрационный номер свидетельства о присвоении номера для клеймения)
		if (isEmptyString(reestr_key_element.branding_code_certificate_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Регистрационный номер свидетельства о присвоении номера для клеймения.");
		}

		// manufacturer_number (Номер изделия по системе нумерации предприятия-изготовителя)
		if (isEmptyString(reestr_key_element.manufacturer_number)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Номер изделия по системе нумерации предприятия-изготовителя.");
		}

		//проверка на уникальность по дате, номеру, заводу, типу
		var validate_dublicate = validate_dublicate_elements(reestr_key_element);
		if(!validate_dublicate.success)
			return validate_dublicate;

		//billet_manufacturer_info (Сведения об изготовителе заготовки)
		// if(isEmptyString(reestr_key_element.billet_manufacturer_info)){
		// 	return badResp(error_message_head + "Требуется заполнить обязательное поле - Сведения об изготовителе заготовки")
		// }

		//technical_conditions (Технические условия)
		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", reestr_key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// life_time (Срок службы)
		if (isEmptyString(reestr_key_element.life_time)) {
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Срок службы.");
		}

		//auto_mode_cargo_model (Модель авторежим грузовой)
		if(isEmptyString(reestr_key_element.auto_mode_cargo_model)){
			return badResp(error_message_head + "Требуется заполнить обязательное поле - Модель авторежим грузовой");
		}
		var dictionary_auto_mode_cargo_model = db.findbyrecid("dictionary_auto_mode_cargo_models", reestr_key_element.auto_mode_cargo_model);
		if (isNullObject(dictionary_auto_mode_cargo_model)) {
			return badResp(error_message_head + "Модель авторежим грузовой не найдена в системе");
		}

		// Сведения о сертификате соответствия
		add_object_blockchain.certificate_number = reestr_certificates.registration_number;
		// Условный номер для клеймения продукции вагоностроения
		add_object_blockchain.ke_manufacturer_code = ke_manufacturer.code;
		// Сокращенное наименование предприятия-изготовителя
		add_object_blockchain.ke_manufacturer_name = ke_manufacturer.recname;
		// Регистрационный номер свидетельства о присвоении номера для клеймения
		add_object_blockchain.branding_code_certificate_number = reestr_key_element.branding_code_certificate_number;
		// Номер изделия по системе нумерации предприятия-изготовителя
		add_object_blockchain.manufacturer_number = reestr_key_element.manufacturer_number;
		// Технические условия
		add_object_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();
		// Срок службы
		add_object_blockchain.life_time = reestr_key_element.life_time;
		// Обозначение модели
		add_object_blockchain.auto_mode_cargo_model = dictionary_auto_mode_cargo_model.recname;
		
	}

	return{
		success: true,
		reestr_key_element: reestr_key_element,
		add_object_blockchain: add_object_blockchain
	}
}

// Регистрация-годный.
function registerkeasgood(params) {
	var headers = {
		"Content-Type": "application/json"
	};
	var headers = addAuthHeader(headers);
	var url = String().concat(host, "/plugins/nbdlogicplugin/registerkeyelementasgood/", params.recid.toString())
	var res = fetch(url, {
		headers: headers,
		"body": JSON.stringify(params),
		"Method": "post"
	});
	if(isNotEmptyString(res.data)){
		return JSON.parse(res.data)
	}else{
		return res;
	}
	// var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);

	// if(
	// 	reestr_key_element.key_element_code != keyElementCodes.pressure_beam_id && 
	// 	reestr_key_element.key_element_code != keyElementCodes.wedge_pockets_id && 
	// 	reestr_key_element.key_element_code != keyElementCodes.wedge_pockets_inserts_id && 
	// 	reestr_key_element.key_element_code != keyElementCodes.saddle_ring_id ){
		
	// 	var error_message_head = "Не удалось выпустить в обращение СЧ <a href=\"/tables/reestr_key_elements/"+ reestr_key_element.recid +"\" target=\"_blank\" class=\"alert-link\">"+ reestr_key_element.numberke +"</a> : ";
	// 	// Свидетельство о приемке
	// 	if (isEmptyString(reestr_key_element.acceptance_certificate)) {
	// 		return badResp(error_message_head + "требуется заполнить обязательное поле - Свидетельство о приемке.");
	// 	}

	// 	// ke_number (УИН)
	// 	if (isEmptyString(reestr_key_element.ke_number)) {
	// 		return badResp(error_message_head + "требуется заполнить обязательное поле - УИН.");
	// 	}
	// 	var ke_number = db.findbyrecid("ke_numbers", reestr_key_element.ke_number);
	// 	if (isNullObject(ke_number)) {
	// 		return badResp(error_message_head + "УИН не найден в системе.");
	// 	}

	// 	var blockchain_requests = "";
	// 	var date = new Date();
		
	// 	//Получение ip адреса блокчейна
	// 	var nodeip = null;
	// 	if(isEmptyString(params.memberid)){
	// 		nodeip = getnodeipbymember(reestr_key_element.owner);
	// 	}else{
	// 		nodeip = getnodeipbymember(params.memberid);
	// 	}
	// 	if (isEmptyString(nodeip)) {
	// 		return badResp(error_message_head + "не удалось определить IP адрес блокчейна.");
	// 	}
		
	// 	if (isEmptyString(nodeip)) {
	// 		return badResp(error_message_head + "не удалось определить IP адрес блокчейна.");
	// 	}
	// 	if(isEmptyString(reestr_key_element.blockchainhash)){
	// 		var form_key_element_object_for_blockchain_result = form_key_element_object_for_blockchain(params);
	// 		if(!form_key_element_object_for_blockchain_result.success){
	// 			return form_key_element_object_for_blockchain_result
	// 		}

	// 		reestr_key_element = form_key_element_object_for_blockchain_result.reestr_key_element;
	// 		var add_object_blockchain = form_key_element_object_for_blockchain_result.add_object_blockchain;
	// 		var add_object_blockchain_resp = addobject(add_object_blockchain, false);
			
	// 		//Обход блокчейна
	// 		if(add_object_blockchain_resp.noblockhain){
	// 			reestr_key_element.blockchainhash = "";
	// 			reestr_key_element.blockchainnode = "";
	// 			reestr_key_element.blockchainrecn = "";
	// 			reestr_key_element.blockchaintn = "";
	// 			blockchain_requests += "";
	// 			reestr_key_element.last_blockchain_request = blockchain_requests
	// 			reestr_key_element.date_entry_blockchain = date.toISOString();
	// 			reestr_key_element.statuske = commonConst.VipushenId;
	// 			db.update("reestr_key_elements", reestr_key_element);

	// 			return successResp("СЧ <a href=\"/tables/reestr_key_elements/"+ reestr_key_element.recid +"\" target=\"_blank\" class=\"alert-link\">"+ reestr_key_element.numberke +"</a> успешно выпущен в обращение.");
	// 		}
	// 		if (!!add_object_blockchain_resp.result) {
	// 			reestr_key_element.blockchainhash = add_object_blockchain_resp.result.hash;
	// 			reestr_key_element.blockchainnode = add_object_blockchain_resp.result.node;
	// 			reestr_key_element.blockchainrecn = add_object_blockchain_resp.result.recn;
	// 			reestr_key_element.blockchaintn = add_object_blockchain_resp.result.tn;
	// 			blockchain_requests += JSON.stringify(add_object_blockchain, null, '\t');
	// 			reestr_key_element.last_blockchain_request = blockchain_requests
	// 			reestr_key_element.date_entry_blockchain = date.toISOString();

	// 			db.update("reestr_key_elements", reestr_key_element);
	// 			event.log("reestr_key_elements",
	// 				reestr_key_element.recid,
	// 				"СЧ с номером " + reestr_key_element.numberke + " отправлен в блокчейн.",
	// 				eventTypeEnum.Info,
	// 				add_object_blockchain);
	// 		}
	// 		else {
	// 			return badResp(error_message_head + add_object_blockchain_resp);
	// 		}
	// 	}

	// 	// Установка метки на СЧ в блокчейне
	// 	if (!!reestr_key_element.blockchainhash) {
	// 		var initial_release_date = date.toISOString();

	// 		var set_label_blockchain = {
	// 			"nodeip": nodeip,

	// 			"hash": reestr_key_element.blockchainhash,
	// 			"node": reestr_key_element.blockchainnode,
	// 			"recn": reestr_key_element.blockchainrecn,
	// 			"tn": reestr_key_element.blockchaintn,

	// 			"tid": null,
	// 			"ke_number": ke_number.recname,

	// 			"initial_release": initial_release_date
	// 		};
	// 		var set_label_blockchain_resp = setlabelblockchain(set_label_blockchain);

	// 		if (!!set_label_blockchain_resp.result) {

	// 			event.log("reestr_key_elements",
	// 				reestr_key_element.recid,
	// 				"На СЧ с номером " + reestr_key_element.numberke + " установлена метка в блокчейн.",
	// 				eventTypeEnum.Info,
	// 				set_label_blockchain);

	// 			reestr_key_element.statuske = commonConst.VipushenId;
	// 			blockchain_requests = reestr_key_element.last_blockchain_request;
	// 			blockchain_requests += JSON.stringify(set_label_blockchain, null, '\t');
	// 			reestr_key_element.last_blockchain_request = blockchain_requests;
	// 			reestr_key_element.date_entry_blockchain = date.toISOString();

	// 			reestr_key_element.initial_release = initial_release_date;

	// 			db.update("reestr_key_elements", reestr_key_element);

	// 			event.log("reestr_key_elements",
	// 				reestr_key_element.recid,
	// 				"СЧ с номером " + reestr_key_element.numberke + " зарегистрирован как годный.",
	// 				eventTypeEnum.Info,
	// 				set_label_blockchain);

	// 			var logItem = {
	// 				"reged_key_element": reestr_key_element.recid,
	// 				// Выпуск в обращение
	// 				"ke_action": "2a0e2523-e403-4e84-b04b-39369ce9ee61",
	// 				"operation_date": (new Date()).toISOString(),
	// 				"reccreated": new Date().toISOString()
	// 				};
	// 			db.insert("log", logItem);
	// 		}
	// 		else {
	// 			return set_label_blockchain_resp;
	// 		}
	// 	}
	// 	if(isEmptyString(reestr_key_element.gamma_percent_resource_end_date) && (reestr_key_element.key_element_code == keyElementCodes.side_frame_id || reestr_key_element.key_element_code == keyElementCodes.pressure_beam_id)){
	// 		return successResp("СЧ <a href=\"/tables/reestr_key_elements/"+ reestr_key_element.recid +"\" target=\"_blank\" class=\"alert-link\">"+ reestr_key_element.numberke +"</a> успешно выпущен в обращение, перед установкой на вагон необходимо заполнить поле \"Год окончания гамма-процентного ресурса\"");
	// 	}else{
	// 		return successResp("СЧ <a href=\"/tables/reestr_key_elements/"+ reestr_key_element.recid +"\" target=\"_blank\" class=\"alert-link\">"+ reestr_key_element.numberke +"</a> успешно выпущен в обращение.");
	// 	}
	// }else{
	// 	var headers = {
	// 		"Content-Type": "application/json"
	// 	};
	// 	var headers = addAuthHeader(headers);
	// 	var url = String().concat(host, "/plugins/nbdlogicplugin/registerkeyelementasgood/", params.recid.toString())
	// 	var res = fetch(url, {
	// 		headers: headers,
	// 		"body": JSON.stringify(params),
	// 		"Method": "post"
	// 	});
	// 	if(isNotEmptyString(res.data)){
	// 		return JSON.parse(res.data)
	// 	}else{
	// 		return res;
	// 	}
	// }
}

/**
 * Формирование электронного паспорта СЧ
 * @param {*} params 
 */
function form_key_element_json_passport(params){
	var key_element = db.findbyrecid("reestr_key_elements", params.recid);
	var user = getcurrentuser();
	
	if (ischeckfields()){
		//Проверка заполненности полей пользователя
		//Имя
		if(isEmptyString(user.firstname)){
			return badResp("В профиле пользователя не заполнено поле \"Имя\", проверьте профиль");
		}

		//Фамилия
		if(isEmptyString(user.lastname)){
			return badResp("В профиле пользователя не заполнено поле \"Фамилия\", проверьте профиль");
		}

		//Отчество
		if(isEmptyString(user.patronymic)){
			return badResp("В профиле пользователя не заполнено поле \"Отчество\", проверьте профиль");
		}

		//Телефон
		// if(isEmptyString(user.phonenumber)){
		// 	return badResp("В профиле пользователя не заполнено поле \"Телефон\", проверьте профиль");
		// }

		//email
		if(isEmptyString(user.email)){
			return badResp("В профиле пользователя не заполнено поле \"Электронная почта\", проверьте профиль");
		}
	}
	var form_key_element_object_for_blockchain_result = form_key_element_object_for_blockchain(key_element.recid);
	if(!form_key_element_object_for_blockchain_result.success){
		return form_key_element_object_for_blockchain_result
	}

	key_element = form_key_element_object_for_blockchain_result.reestr_key_element;

	var add_object_blockchain_resp = addobject(form_key_element_object_for_blockchain_result.add_object_blockchain, true);
	return add_object_blockchain_resp;
}

// Регистрация-брак.
function registerkeasbad(params) {
	var res = true;

	var reestr_parts_type = db.findbyrecid("reestr_key_elements", params.recid);

	reestr_parts_type.statuske = commonConst.ZapreshenId;
	res = res && db.update("reestr_key_elements", reestr_parts_type);

	return res;
}

// Получить первый доступный номер по запросу.
function get_min_ke_number(request_id) {

	var min_number_obj;
	var min_number = 0;
	var rfidsParams = {
		"rfid_request": request_id,
		"status": "52e9190f-f319-4199-9308-cee6d7c79e31"
	};
	var ke_numbers = db.findbyparams("ke_numbers", rfidsParams);
	if (!!ke_numbers) {
		min_number = parseInt(ke_numbers[0].int_number);
		min_number_obj = ke_numbers[0];
		for (var i = 0; i < ke_numbers.length; i++) {
			var numMin = ke_numbers[i];
			if (min_number > numMin.int_number) {
				min_number = parseInt(numMin.int_number);
				min_number_obj = numMin;
			}
		}
	}

	return min_number_obj;
}

/**
 * Выпуск в обращение
 * @param {*} params Параметры составной части 
 * @param {*} return_object флаг, определяющий, отправится ли запрос в блокчейн, либо его тело вернется в виде объекта
 */
function addobject(params, return_object) {
	// var params = {
	// 	// тип СЧ
	// 	"ke_type": "",
	// 	// УИН
	// 	"ke_number": "",
	// 	// Способ (тип) маркировки
	// 	"method_of_marking" : "",
	// 	// Наименование изделия
	// 	"key_element_code": "",
	// 	// Обозначение изделия
	// 	"documentation_number": "",
	// 	// Дата изготовления
	// 	"date_manufacture": "",
	// 	// Сведения об изготовителе
	// 	"manufacturer_details": ""
	// }

	// {
	// 	"method": {
	// 		"package": "NBD",
	// 		"function": "add_object"
	// 	},
	// 	// params.ke_type
	// 	"object_class": "string",
	// 	"object_data": {
	// 		"label": {
	// 			"tid": "string or null",
	// 			// params.ke_number
	// 			"UIN": "string"
	// 		},
	// 		"common": {
	// 			// params.method_of_marking
	// 			"Способ (тип) маркировки": "string",
	// 			// params.key_element_code
	// 			"Наименование изделия по НД": "string",
	// 			// params.documentation_number
	// 			"Обозначение изделия": "string",
	// 			// params.date_manufacture
	// 			"Дата изготовления": "string",
	// 			// params.manufacturer_details
	// 			"Сведения об изготовителе": "string"
	// 		},
	// 		// Балка надрессорная
	// 		"specific": {
	// 			// params.certificate_number
	// 			"Сведения о сертификате соответствия": "string",
	// 			// params.life_time
	// 			"Срок службы": "string",
	// 			// params.ke_manufacturer_code
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": "decimal string",
	// 			// params.ke_manufacturer_name
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": "string",
	// 			// params.branding_code_certificate_number
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string",
	// 			// params.manufacturer_number
	// 			"Номер изделия по системе нумерации предприятия-изготовителя": "string",
	// 			// params.melt_number
	// 			"Номер плавки": "string",
	// 			// params.steel_grade
	// 			"Марка материала": "string",
	// 			// params.administration_code
	// 			"Код государства собственника детали (значение из классификатора КЖА 1001 15)": "decimal string"
	// 		},
	// 		// Рама боковая
	// 		"specific": {
	// 			// params.certificate_number
	// 			"Сведения о сертификате соответствия": "string",
	// 			// params.life_time
	// 			"Срок службы": "string",
	// 			// params.ke_manufacturer_code
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": "decimal string",
	// 			// params.ke_manufacturer_name
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": "string",
	// 			// params.branding_code_certificate_number
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string",
	// 			// params.manufacturer_number
	// 			"Номер изделия по системе нумерации предприятия-изготовителя": "string",
	// 			// params.melt_number
	// 			"Номер плавки": "string",
	// 			// params.steel_grade
	// 			"Марка материала": "string",
	// 			// params.administration_code
	// 			"Код государства собственника детали (значение из классификатора КЖА 1001 15)": "decimal string",
	// 			// params.slip_knots_distance
	// 			"Расстояние между наружными упорными поверхностями буксового проема (количество шишек)": "decimal string"
	// 		},
	// 		// Клин фрикционный, Адаптер подшипника, Корпус скользуна, Колпак скользуна, Планка фрикционная, Скоба, Пластины в клиновых карманах, Кольцо в подпятник
	// 		"specific": {
	// 			// params.ke_manufacturer_code
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": "decimal string",
	// 			// params.ke_manufacturer_name
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": "string",
	// 			// params.branding_code_certificate_number
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string",
	// 			// params.steel_grade
	// 			"Марка материала": "string"
	// 		},
	//		//Сменный ЖД кузов
	// 		"specific":{
	// 			"Срок службы":"string",
	// 			"Индивидуальные особенности":"string",
	// 			"Номер изделия по системе нумерации предприятия-изготовителя":"string",
	// 			"Марка материала": "string",
	// 			"Грузоподъемность": "string",
	// 			"Объем кузова (котла)":"string",
	// 			"Масса тары максимальная":"string",
	// 			"Специализация":"string"
	// 		},
	//		//Ось чистовая
	// 		"specific":{
	// 			"Сведения о сертификате соответстви":"string",
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)":"string",
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)":"string",
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string",
	// 			"Номер изделия по системе нумерации предприятия-изготовителя": "string",
	// 			"Год изготовления черновой оси":"string",
	// 			"Марка материала":"string"
	// 		},
	//		//Колесо
	// 		"specific":{
	// 			"Сведения о сертификате соответстви":"string",
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)":"string",
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)":"string",
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string",
	// 			"Номер изделия по системе нумерации предприятия-изготовителя": "string",
	// 			"Номер плавки":"string",
	// 			"Марка материала":"string"
	// 		},
	//		//Замок, валик подъемника
	//      "specific": {
	// 			// params.ke_manufacturer_code
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": "decimal string",
	// 			// params.ke_manufacturer_name
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": "string",
	// 			// params.branding_code_certificate_number
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string"
	// 		},
	//		//Корпус автосцепки
	// 		"specific":{
	// 			"Сведения о сертификате соответстви":"string",
	// 			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)":"string",
	// 			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)":"string",
	// 			"Регистрационный номер свидетельства о присвоении номера для клеймения": "string",
	// 			"Номер изделия по системе нумерации предприятия-изготовителя": "string",
	// 			"Марка материала":"string",
	//			"Обозначение модели": "string"
	// 	}
	// };

	var request =
		{
			"method": {
				"function": "add_object",
				"package": "NBD"
			},
			"object_class": params.ke_type,
			"object_data": {
				"common": {
					"Способ (тип) маркировки": params.method_of_marking,
					"Наименование изделия по НД": params.ke_normative_name,
					"Обозначение изделия": params.documentation_number.trim(),
					"Дата изготовления": params.date_manufacture,
					"Сведения об изготовителе": params.manufacturer_details
				},
				"specific": null
			}
		};
	
	// Балка надрессорная
	if (params.key_element_code == keyElementCodes.pressure_beam_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Срок службы": params.life_time,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade,
				"Код государства собственника детали (значение из классификатора КЖА 1001 15)": params.administration_code
			};
	}

	// Рама боковая
	if (params.key_element_code == keyElementCodes.side_frame_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Срок службы": params.life_time,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade,
				"Код государства собственника детали (значение из классификатора КЖА 1001 15)": params.administration_code,
				"Расстояние между наружными упорными поверхностями буксового проема (количество шишек)": params.slip_knots_distance
			};
	}

	// Адаптер подшипника, Корпус скользуна, Колпак скользуна, Планка фрикционная, Скоба, Пластины в клиновых карманах, Кольцо в подпятник, Вставки в клиновые карманы, Вкладыш подпятника
	if (params.key_element_code == keyElementCodes.bearing_adapter_code
		|| params.key_element_code == keyElementCodes.slider_body_code
		|| params.key_element_code == keyElementCodes.slider_cap_code
		|| params.key_element_code == keyElementCodes.friction_strip_code
		|| params.key_element_code == keyElementCodes.brace_code
		|| params.key_element_code == keyElementCodes.wheel_adapter_code
		|| params.key_element_code == keyElementCodes.wedge_pockets_code
		|| params.key_element_code == keyElementCodes.saddle_ring_code
		|| params.key_element_code == keyElementCodes.wedge_pockets_inserts_code
		|| params.key_element_code == keyElementCodes.saddle_bearing_code) {

		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade
			};
	}

	// Клин фрикционный
	if (params.key_element_code == keyElementCodes.friction_wedge_code) {
		if (isNotEmptyString(params.manufacturer_number)) {
			request.object_data.specific = { 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number
			};
		} else {
			request.object_data.specific = { 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade
			};
		}
	}
	
	// Сменный ЖД кузов
	if (params.key_element_code == keyElementCodes.removable_railway_carcass_code){
		request.object_data.specific = {
			"Технические условия": params.technical_conditions,
			"Срок службы": params.life_time,
			"Индивидуальные особенности": params.individual_features,
			"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
			"Марка материала":	params.steel_grade,
			"Грузоподъемность":	params.carcass_load_capacity,
			"Объем кузова (котла)": params.carcass_volume,
			"Масса тары максимальная": params.tare_max_weight,
			"Специализация": params.specialization
		}
	}

	// Ось чистовая
	if (params.key_element_code == keyElementCodes.clear_axis_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Номер черновой оси": params.rough_axis_number, 
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Год изготовления черновой оси": params.rough_axis_manufacturing_date,
				"Марка материала": params.steel_grade
			};
	}

	// Колесо
	if (params.key_element_code == keyElementCodes.wheel_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade
			};
	}

	//Замок, валик подъемника
	if(params.key_element_code == keyElementCodes.lock_code
		|| params.key_element_code == keyElementCodes.elevator_roll_code){
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number
			};
	}

	// Корпус автосцепки
	if (params.key_element_code == keyElementCodes.coupler_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Марка материала": params.steel_grade,
				"Обозначение модели": params.coupling_model.toString()
			};
	}

	// Упоры передний и задний объединенные
	if (params.key_element_code == keyElementCodes.front_rear_detents_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Технические условия": params.technical_conditions,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Срок службы": params.life_time,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Марка материала": params.steel_grade,
				"Код государства собственника детали (значение из классификатора КЖА 1001 15)": params.administration_code
			};
	}

	// Крышка люка полувагона
	if (params.key_element_code == keyElementCodes.gondola_hatch_code) {
		request.object_data.specific = 
			{
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number
			};
	}

	 //Пружина рессорного подвешивания наружная
	 if (params.key_element_code == keyElementCodes.spring_outside_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade
			};
	}

	 //Пружина рессорного подвешивания внутренняя
	 if (params.key_element_code == keyElementCodes.spring_inside_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade
			};
	}

	 //Пружина скользуна наружная
	 if (params.key_element_code == keyElementCodes.spring_slider_outside_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Марка материала": params.steel_grade
			};
	}

	//Пружина скользуна внутренняя
	if (params.key_element_code == keyElementCodes.spring_slider_inside_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Марка материала": params.steel_grade
			};
	}

	//Подшипник буксового узла
	if (params.key_element_code == keyElementCodes.bearing_node_code) {
		request.object_data.specific = 
			{ 
				"Технические условия": params.technical_conditions,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number
			};
	}

	//Ось черновая
	if (params.key_element_code == keyElementCodes.rough_axis_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade
			};
	}

	//Корпус поглощающего аппарата
	if (params.key_element_code == keyElementCodes.absorbing_device_body_code) {
		request.object_data.specific = 
			{ 
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Обозначение модели": params.absorbing_device_body_model.toString()
			};
	}

	//Хомут тяговый
	if (params.key_element_code == keyElementCodes.traction_clamp_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Марка материала": params.steel_grade
			};
	}

	//Авторежим грузовой
	if (params.key_element_code == keyElementCodes.auto_mode_cargo_code) {
		request.object_data.specific = 
			{
				"Технические условия": params.technical_conditions, 
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Обозначение модели": params.auto_mode_cargo_model.toString(),
				"Срок службы": params.life_time
			};
	}

	if(return_object){
		var return_res = {
			nodeip: params.nodeip,
			request: request
		}
		return return_res;
	}else{
		return sendrequest(request, params.nodeip);
	}
}

// Установить метку
function setlabelblockchain(params) {
	// {
	// 	"method": {
	// 		"package":"NBD",
	// 		"function":"object_set_label"
	// 	},
	// 	"object_link": <object link structure>,
	// 	"label": {
	// 		"tid": <string>,
	// 		"UIN": <string>
	// 	},
	// 	"info": {
	// 		"Сведения о первичном вводе в обращение": <string>
	// 	}
	// }

	var request = {
        "method": {
            "function": "object_set_label",
            "package": "NBD"
        },
        "object_link": {
            "hash": params.hash,
            "node": params.node,
            "recn": params.recn,
            "tn": params.tn
        },
        "label": {
			"tid": null,
            "UIN": params.ke_number
        },
        "info": {
            "Сведения о первичном вводе в обращение": params.initial_release
        }
    };

	if (!!params.tid) {
		request.label.tid = params.tid;
	}

	return sendrequest(request, params.nodeip);
}

//определение родительского СЕ по id СЕ нижнего/среднего уровня
function getparentse(recid){
	var parentSE = db.findbyrecid("reestr_ke_nodes", recid);
	if(isNotNullObject(parentSE)){
		if(isNotEmptyString(parentSE.parent_ke_node))
			return getparentse(parentSE.parent_ke_node);
		else
			return successResp("", parentSE);
	}
	return badResp("Не найден родительский СЕ/узел");
}

//поиск дочерних СЧ и СЕ для родительского узла
var childs_se_out = [];
var childs_ke_out = [];
/**
 * 
 * @param {*} main_node родительский СЕ
 * @param {*} only_se найти только дочерние СЕ
 * @param {*} childs_ke_out ссылка на массив дочерних СЧ
 * @param {*} childs_se_out ссылка на массив дочерних СЕ
 */
function findchilds(main_node, only_se){
	try {
		if(isNotNullObject(main_node)){
			childs_se_out.push(main_node);
			if(!only_se){
				var childs_ke = db.findbyparams("reestr_key_elements", {"ke_node":main_node.recid});

				if(isNotEmptyOrNullArray(childs_ke)){
					for(let i=0; i<childs_ke.length; i++){
						childs_ke_out.push(childs_ke[i]);
					}
				}
			}

			var childs_se = db.findbyparams("reestr_ke_nodes", {"parent_ke_node":main_node.recid, "assembly_element_type": commonAssemblyElementTypes.assembly_unit_id});
				
			if(isNotEmptyOrNullArray(childs_se)){
				for(let i=0; i<childs_se.length; i++){
					var res = findchilds(childs_se[i], only_se);
				}
			}
		}
		return successResp();
	} catch(ex){
		return badResp(ex.message);
	}
}

// Снять СЧ верхнего уровня c вагона (из интерфейса)
function removeke_unit(params){
	return removeke(params);
}

// Снять СЧ верхнего уровня c вагона (из интерфейса)
function removeke(params){
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	if (isNullObject(reestr_key_element)) {
		return badResp("составная часть не найден в системе.");
	}

	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		return badResp("Невозможно получить текущего пользователя");
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		return badResp("Получатель не найден в системе");
	}

	//Проверяем что у СЧ есть ссылка на партию
	if (reestr_key_element.batchid != null && reestr_key_element.batchid != "") {
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", reestr_key_element.batchid);
		if (isNullObject(batch)) {
			return badResp("Запись о партии не найдена в системе");
		}
		if (member.recid == batch.recipient_droplist){
			//если получатель
			if (batch.batch_status != "ef519ef4-ec73-4776-9295-2d007bb32907" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp("Невозможно выполнить данную операцию.")
			}
		} else{
			//если отправитель
			//статус партии отклонена или получена частично флаг false
			if (batch.batch_status != "281496a2-3d01-479e-80cb-96e6e6e76135" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp("Невозможно выполнить данную операцию.")
			}
		}
	}

	//если СЧ верхнего уровня - снимаем его с вагона
	if (isEmptyString(reestr_key_element.ke_node)){
		var vehicleid = reestr_key_element.vehicle;
		var res = removekefromwagon(reestr_key_element.numberke);

		// Обновление количества СЧ/СЕ, установленных на вагон
		var counting_res = counting_ke_se_onvagon(vehicleid);
		if(!res.success){
			return res;
		}
		if(!counting_res.success){
			return badResp(String().concat(res.message, "При обновлении количества СЧ/СЕ, установленных на вагон, произошла ошибка"));
		}
		return res;
	}
	//если СЧ входит в состав СЕ
	return remove_ke_se(reestr_key_element.ke_node);
}

// Снять СЕ верхнего уровня c вагона (из интерфейса)
function removese_unit(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	return removese(params);
}

// Снять СЕ верхнего уровня c вагона (из интерфейса)
function removese(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	var reestr_ke_node = db.findbyrecid("reestr_ke_nodes", params.recid);
	if (isNullObject(reestr_ke_node)) {
		return badResp("составная часть не найден в системе.");
	}
	return remove_ke_se(reestr_ke_node.recid);
}
// Снять СЧ с вагона целиком (Снимаем все родительские СЕ, их дочерние СЕ/СЧ).
function remove_ke_se(parentid) {
	var vehicleid = null;
	 childs_se_out = [];
	 childs_ke_out = [];
	if (isNotEmptyString(parentid)){
		var main_se = getparentse(parentid);
		if(!main_se.success && isNullObject(main_se.data)){
			return badResp("Произошла ошибка при поиске сборочной единицы/узла верхнего уровня");
			
		} else {
			vehicleid = main_se.data.vehicle;
			var res = findchilds(main_se.data, false)
			if(!res.success){
				return res;
			}

			for(let i=0; i<childs_ke_out.length; i++){
				var res = removekefromwagon(childs_ke_out[i].numberke);
				if (!res.success) {
					return badResp("Произошла ошибка во время снятия СЧ " + childs_ke_out[i].numberke + " с вагона." + res.message);
				}
			}

			// //снимаем с вагона СЕ верхнего уровня
			var res = removesefromwagon(main_se.data.unique_number, true);
			if (!res.success) {
				return badResp("Произошла ошибка во время снятия СЕ <a href=\"/tables/reestr_ke_nodes/"  + main_se.data[i].recid + "\" target=\"_blank\" class=\"alert-link\">" + main_se.data[i].unique_number + "</a> с вагона." + res.message);
			}

			// для снятия с вагона всех СЕ, кроме СЕ верхнего уровня
			childs_se_out.splice(childs_se_out.indexOf(main_se.data), 1);
			for(let i=0; i<childs_se_out.length; i++){
				var res = removesefromwagon(childs_se_out[i].unique_number, false);
				if (!res.success) {
					return badResp("Произошла ошибка во время снятия СЕ <a href=\"/tables/reestr_ke_nodes/"  + childs_se_out[i].recid + "\" target=\"_blank\" class=\"alert-link\">" + childs_se_out[i].unique_number + "</a> с вагона." + res.message);
				}
			}
		}
	}

	// Обновление количества СЧ/СЕ, установленных на вагон
	if(isNotEmptyString(vehicleid)){
		var counting_res = counting_ke_se_onvagon(vehicleid);
		if(!counting_res.success){
			return badResp("СЕ <a href=\"/tables/reestr_ke_nodes/" + main_se.data.recid  + "\" target=\"_blank\" class=\"alert-link\">" + main_se.data.unique_number +"</a> и всё входящие в её состав детали были успешно сняты с вагона. При обновлении количества СЧ/СЕ, установленных на вагон, произошла ошибка");
		}
	}

	return successResp("СЕ <a href=\"/tables/reestr_ke_nodes/" + main_se.data.recid  + "\" target=\"_blank\" class=\"alert-link\">" + main_se.data.unique_number +"</a> и всё входящие в её состав детали были успешно сняты с вагона.");
}

/**
 * Снять СЕ с вагона.
 * @param {*} number УИН СЕ
 * @param {*} change_status флаг "менять статус?" =true для СЕ верхнего уровня и = false для перенесенных в родительский узел
 */
function removesefromwagon(number, change_status) {
	var res = true;

	var reestr_ke_nodesTmp_params = {
		"unique_number": number
	};
	var reestr_ke_nodesTmps = db.findbyparams("reestr_ke_nodes", reestr_ke_nodesTmp_params);
	if (isEmptyOrNullArray(reestr_ke_nodesTmps)) {
		return badResp("Сборочная единица/узел " + number + "не найден в системе.");
	}
	var reestr_ke_nodesTmps = reestr_ke_nodesTmps[0];

	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		return badResp("Невозможно получить текущего пользователя");
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		return badResp("Получатель не найден в системе");
	}

	if (reestr_ke_nodesTmps.batchid != null && reestr_ke_nodesTmps.batchid !=""){
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", reestr_ke_nodesTmps.batchid);
		if (isNullObject(batch)) {
			return badResp("Запись о партии не найдена в системе");
		}
		if (member.recid == batch.recipient_droplist){
			//если получатель
			if (batch.batch_status != "ef519ef4-ec73-4776-9295-2d007bb32907" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_ke_nodesTmps.change_node != true){
				return badResp("Невозможно выполнить данную операцию")
			}
		} else{
			//если отправитель
			//статус партии отклонена или получена частично флаг false
			if (batch.batch_status != "281496a2-3d01-479e-80cb-96e6e6e76135" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_ke_nodesTmps.change_node != true){
				return badResp("Невозможно выполнить данную операцию")
			}
		}
	}

	var rzd_url = get_rzd_urls_portal_settings();
	if(!rzd_url.success){
		return badResp("Не удалось получить адрес АРМ Росжелдора");
	}

	var member = getmemberbyuser();

	var nodeip = getnodeipbymember(member.recid);
	if (isEmptyString(nodeip)) {
		return badResp("Не удалось определить IP адрес блокчейна.");
	}

	var removefromwagonbch = {
		"nodeip": nodeip,
		"link":
			{
				"hash": reestr_ke_nodesTmps.blockchainhash,
				"node": reestr_ke_nodesTmps.blockchainnode,
				"recn": reestr_ke_nodesTmps.blockchainrecn,
				"tn": reestr_ke_nodesTmps.blockchaintn
			}
	};
	
	var isnode = reestr_ke_nodesTmps.assembly_element_type == commonAssemblyElementTypes.node_id;
	var blockchainResponse = null;
	if(!isnode){
		blockchainResponse = removefromwagonblockchain(removefromwagonbch);
	}

	if (isnode || !!blockchainResponse.result) {
		var node_log_actions = db.findbyparams("dictionary_node_actions", { "code": 6 });
			
		//Снятие с ТС
		var logItem = set_node_log(reestr_ke_nodesTmps, node_log_actions[0].recid, "");
		
		reestr_ke_nodesTmps.vehicle = null;
		reestr_ke_nodesTmps.install_date = null;
		reestr_ke_nodesTmps.assembly_element_position_on_vagon = null;
		reestr_ke_nodesTmps.is_registrated_installation = false;
		reestr_ke_nodesTmps.blockchain_request_body = JSON.stringify(blockchainResponse.request);

		var attached_file_dop_ep = getattachedfileincolumn("reestr_ke_nodes", "node_passport_file_appendix", reestr_ke_nodesTmps.recid);
		if(attached_file_dop_ep != null && attached_file_dop_ep.length > 0){
			var delete_file_res = delete_files(attached_file_dop_ep[0].recId);
            if(!delete_file_res.success){
                return delete_file_res;
			}
		}		
			
		// Если СЕ верхнего уровня - меняем статус на Снят с ТС
		if(change_status){
			reestr_ke_nodesTmps.status = "25d67987-0cd4-404a-85d7-847d142af11f";
		}
		res = res && db.update("reestr_ke_nodes", reestr_ke_nodesTmps);

		//Прописываем содержимое узла
		var all_key_elements_obj = db.findbyparams("reestr_key_elements", { "ke_node": reestr_ke_nodesTmps.recid });
		if (isNotEmptyOrNullArray(all_key_elements_obj)) {
			for (var i = 0; i < all_key_elements_obj.length; i++) {
				var key_element_type_record = db.findbyrecid("dictionary_key_elements_codes", all_key_elements_obj[i].key_element_code);
				if (isNotNullObject(key_element_type_record)) {
					if (i < all_key_elements_obj.length - 1) {
						logItem.node_content += all_key_elements_obj[i].numberke + '(' + key_element_type_record.recname + ')' + ", ";
					} else {
						logItem.node_content += all_key_elements_obj[i].numberke + '(' + key_element_type_record.recname + ')';
					}
				} else {
					if (i < all_key_elements_obj.length - 1) {
						logItem.node_content += all_key_elements_obj[i].numberke + ", ";
					} else {
						logItem.node_content += all_key_elements_obj[i].numberke;
					}
				}
			}
		}
		//db.insert("node_log", logItem);
		// Отправка записи в АРМ Росжелдора 29.09.2020 amaslov 44458
		MakeLogRecord("node_log", logItem, rzd_url.rzd_name_url);

		event.log("reestr_ke_nodes",
		reestr_ke_nodesTmps.recid,
			"СЕ " + reestr_ke_nodesTmps.unique_number + " снят с ТС ",
			eventTypeEnum.Info,
			removefromwagonbch);
	}
	else {
		return badResp(blockchainResponse);
	}

	return successResp("СЕ <a href=\"/tables/reestr_ke_nodes/" + reestr_ke_nodesTmps.recid + "\" target=\"_blank\" class=\"alert-link\">" + reestr_ke_nodesTmps.unique_number + "</a> снят с ТС");
}
// Снять СЧ с вагона.
function removekefromwagon(number) {
	var res = true;

	var reestr_key_elementsTmp_params = {
		"numberke": number
	};
	var reestr_key_elementsTmps = db.findbyparams("reestr_key_elements", reestr_key_elementsTmp_params);
	if (isEmptyOrNullArray(reestr_key_elementsTmps)) {
		return badResp("составная часть не найден в системе.");
	}

	var rzd_url = get_rzd_urls_portal_settings();
	if(!rzd_url.success){
		return badResp("Не удалось получить адрес АРМ Росжелдора");
	}

	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		return badResp("Невозможно получить текущего пользователя");
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		return badResp("Получатель не найден в системе");
	}

	var reestr_key_elementsTmp = reestr_key_elementsTmps[0];

	if (reestr_key_elementsTmp.batchid != null && reestr_key_elementsTmp.batchid !=""){
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", reestr_key_elementsTmp.batchid);
		if (isNullObject(batch)) {
			return badResp("Запись о партии не найдена в системе");
		}
		if (member.recid == batch.recipient_droplist){
			//если получатель
			if (batch.batch_status != "ef519ef4-ec73-4776-9295-2d007bb32907" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_elementsTmp.change_node != true){
				return badResp("Невозможно разгруппировать СЕ, в который входит СЧ, входящий в партию не в статусе - Получена или Получена частично.")
			}
		} else{
			//если отправитель
			//статус партии отклонена или получена частично флаг false
			if (batch.batch_status != "281496a2-3d01-479e-80cb-96e6e6e76135" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_elementsTmp.change_node != true){
				return badResp("Невозможно разгруппировать СЕ, в который входит СЧ, входящий в партию не в статусе - Отклонена или Получена частично.")
			}
		}
	}

	var nodeip = getnodeipbymember(reestr_key_elementsTmp.node_owner);
	if (isEmptyString(nodeip)) {
		return badResp("Не удалось определить IP адрес блокчейна.");
	}
	
	var node = null;
	if (isNotEmptyString(reestr_key_elementsTmp.ke_node)) {
			node = db.findbyrecid("reestr_ke_nodes", reestr_key_elementsTmp.ke_node);
	} 

	var removefromwagonbch = {
		"nodeip": nodeip,
		"link":
			{
				"hash": reestr_key_elementsTmp.blockchainhash,
				"node": reestr_key_elementsTmp.blockchainnode,
				"recn": reestr_key_elementsTmp.blockchainrecn,
				"tn": reestr_key_elementsTmp.blockchaintn
			}
	};
	//Условие, которое позволяет снять СЧ без отправки в блокчейн (для отладки)
	if(reestr_key_elementsTmp.key_element_code == "" || reestr_key_elementsTmp.key_element_code == ""){
		// Снятие с ТС
		var logItem = set_ke_log(reestr_key_elementsTmp, "b158bc11-095a-4926-8db7-ef88b7e33efa", !!node ? node.recid : null, !!node ? node.ke_node_type : null);

		reestr_key_elementsTmp.vehicle = null;
		reestr_key_elementsTmp.install_ke_date = null;
		reestr_key_elementsTmp.position_on_vagon = null;
		reestr_key_elementsTmp.is_registrated_installation = false;

		var attached_file_dop_ep = getattachedfileincolumn("reestr_key_elements", "key_element_passport_file_appendix", reestr_key_elementsTmp.recid);
		if(attached_file_dop_ep != null && attached_file_dop_ep.length > 0){
			var delete_file_res = delete_files(attached_file_dop_ep[0].recId);
            if(!delete_file_res.success){
                return delete_file_res;
			}
		}	

		// Снят с ТС
		reestr_key_elementsTmp.statuske = "259762d5-2ee4-4acb-a2c7-18593cb6cc4f";
		reestr_key_elementsTmp.last_blockchain_request = JSON.stringify(removefromwagonbch, null, '\t');

		// Снятие с ТС
		res = res && db.update("reestr_key_elements", reestr_key_elementsTmp);

		//db.insert("log", logItem);
		// Отправка записи в АРМ Росжелдора 29.09.2020 amaslov 44458
		MakeLogRecord("log", logItem, rzd_url.rzd_name_url);

		event.log("reestr_key_elements",
			reestr_key_elementsTmp.recid,
			"СЧ " + reestr_key_elementsTmp.numberke + " снят с ТС",
			eventTypeEnum.Info,
			removefromwagonbch);
	} else {
		var blockchainResponse = removefromwagonblockchain(removefromwagonbch);

		if (!!blockchainResponse.result) {
			// Снятие с ТС
			var logItem = set_ke_log(reestr_key_elementsTmp, "b158bc11-095a-4926-8db7-ef88b7e33efa", !!node ? node.recid : null, !!node ? node.ke_node_type : null);

			reestr_key_elementsTmp.vehicle = null;
			reestr_key_elementsTmp.install_ke_date = null;
			reestr_key_elementsTmp.position_on_vagon = null;
			reestr_key_elementsTmp.is_registrated_installation = false;

			var attached_file_dop_ep = getattachedfileincolumn("reestr_key_elements", "key_element_passport_file_appendix", reestr_key_elementsTmp.recid);
			if(attached_file_dop_ep != null && attached_file_dop_ep.length > 0){
				var delete_file_res = delete_files(attached_file_dop_ep[0].recId);
				if(!delete_file_res.success){
					return delete_file_res;
				}
			}	

			// Снят с ТС
			reestr_key_elementsTmp.statuske = "259762d5-2ee4-4acb-a2c7-18593cb6cc4f";
			reestr_key_elementsTmp.last_blockchain_request = JSON.stringify(blockchainResponse.request);

			res = res && db.update("reestr_key_elements", reestr_key_elementsTmp);

			//db.insert("log", logItem);
			// Отправка записи в АРМ Росжелдора 29.09.2020 amaslov 44458
			MakeLogRecord("log", logItem, rzd_url.rzd_name_url);

			event.log("reestr_key_elements",
				reestr_key_elementsTmp.recid,
				"СЧ " + reestr_key_elementsTmp.numberke + " снят с ТС",
				eventTypeEnum.Info,
				removefromwagonbch);
		}
		else {
			return badResp(blockchainResponse);
		}
	}

	return successResp("СЧ <a href=\"/tables/reestr_key_elements/" + reestr_key_elementsTmp.recid + "\" target=\"_blank\" class=\"alert-link\">" + reestr_key_elementsTmp.numberke + "</a> успешно снят с ТС.");
}

// API: Снять СЧ с вагона.
function apiremovekefromwagon(requestdata) {

	var reestr_key_elementsTmp_params = {
		"numberke": requestdata.numberke
	};
	var reestr_key_elementsTmps = db.findbyparams("reestr_key_elements", reestr_key_elementsTmp_params);
	if (isEmptyOrNullArray(reestr_key_elementsTmps)) {
		return badResp("составная часть не найден в системе.");
	}

	var reestr_key_elementsTmp = reestr_key_elementsTmps[0];

	//если СЧ верхнего уровня - снимаем его с вагона
	if (isEmptyString(reestr_key_elementsTmp.ke_node)){
		return removekefromwagon(reestr_key_elementsTmp.numberke);
	}
	//если СЧ входит в состав СЕ
	return remove_ke_se(reestr_key_elementsTmp.ke_node);
}

// Проверка ограничений по количеству СЧ на вагоне перед установкой
function checkcountlimitation(keyelemens, vagonid) {
	var isparamsvalid = true;
	var errormessage = "";

	var input_wheel_pair_count = 0;
	var input_side_frame_count = 0;
	var input_pressure_beam_count = 0;
	var input_air_distributor_count = 0;
	var input_absorbing_device_count = 0;
	var input_coupler_count = 0;
	var input_auto_mode_count = 0;
	var input_friction_wedge_count = 0;
	var input_slider_body_count = 0;
	var input_slider_cap_count = 0;
	var input_wheel_adapter_count = 0;
	var input_brake_cylinder_count = 0;
	var input_spring_suspension_under_wedge_external_count = 0;
	var input_spring_suspension_under_wedge_internal_count = 0;
	var input_spring_suspension_external_count = 0;
	var input_spring_suspension_internal_count = 0;
	var input_spring_slider_external_count = 0;
	var input_spring_slider_internal_count = 0;
	var input_air_tank_auto_brakes_count = 0;
	var input_traction_clamp_coupling_count = 0;
	var input_triangel_count = 0;
	var input_trunk_part_air_distributor_count = 0;
	var input_bearing_adapter_count = 0;
	var input_removable_railway_carcass_count = 0;
	var input_friction_strip_count = 0;
	var input_brace_count = 0;
	var input_clear_axis_count = 0;
	var input_wheel_count = 0;
	var input_wedge_pockets_count = 0;
	var input_saddle_rings_count = 0;
	var input_wedge_pockets_inserts_count = 0;
	var input_saddle_bearings_count = 0;
	var input_locks_count = 0 ;
	var input_elevator_rolls_count = 0;
	var input_auto_couplers_count = 0;
	var input_front_rear_detents = 0;
	var input_gondola_hatches = 0;
	var input_rough_axis_count = 0;
	var input_absorbing_device_body_count = 0;
	var input_traction_clamp_count = 0;

	for (var i = 0; i < keyelemens.length; i++) {
		var reestr_key_element = keyelemens[i];

		// Балка надрессорная
		if (reestr_key_element.key_element_code == keyElementCodes.pressure_beam_id) {
			input_pressure_beam_count++;
		}
		// Рама боковая
		if (reestr_key_element.key_element_code == keyElementCodes.side_frame_id) {
			input_side_frame_count++
		}
		// Колесная пара в сборе
		if (reestr_key_element.key_element_code == keyElementCodes.wheel_pair_id) {
			input_wheel_pair_count++;
		}
		// Главная часть воздухораспределителя
		if (reestr_key_element.key_element_code == keyElementCodes.main_part_air_distributor_id) {
			input_air_distributor_count++;
		}
		// Поглощающий аппарат
		if (reestr_key_element.key_element_code == keyElementCodes.absorbing_device_id) {
			input_absorbing_device_count++;
		}
		// Авторежим
		if (reestr_key_element.key_element_code == keyElementCodes.auto_mode_id) {
			input_auto_mode_count++;
		}
		// Клин фрикционный
		if (reestr_key_element.key_element_code == keyElementCodes.friction_wedge_id) {
			input_friction_wedge_count++;
		}
		// Корпус скользуна
		if (reestr_key_element.key_element_code == keyElementCodes.slider_body_id) {
			input_slider_body_count++;
		}
		// Колпак скользуна
		if (reestr_key_element.key_element_code == keyElementCodes.slider_cap_id) {
			input_slider_cap_count++;
		}
		// Адаптер колеса
		if (reestr_key_element.key_element_code == keyElementCodes.wheel_adapter_id) {
			input_wheel_adapter_count++;
		}
		// Тормозной цилиндр
		if (reestr_key_element.key_element_code == keyElementCodes.brake_cylinder_id) {
			input_brake_cylinder_count++;
		}
		// Пружины рессорного подвешивания подклиновая наружная
		if (reestr_key_element.key_element_code == keyElementCodes.spring_suspension_under_wedge_external_id) {
			input_spring_suspension_under_wedge_external_count++;
		}
		// Пружины рессорного подвешивания подклиновая внутренняя
		if (reestr_key_element.key_element_code == keyElementCodes.spring_suspension_under_wedge_internal_id) {
			input_spring_suspension_under_wedge_internal_count++;
		}
		// Пружины рессорного подвешивания наружная
		if (reestr_key_element.key_element_code == keyElementCodes.spring_suspension_external_id) {
			input_spring_suspension_external_count++;
		}
		// Пружины рессорного подвешивания внутренняя
		if (reestr_key_element.key_element_code == keyElementCodes.spring_suspension_internal_id) {
			input_spring_suspension_internal_count++;
		}
		// Пружины скользуна наружная
		if (reestr_key_element.key_element_code == keyElementCodes.spring_slider_external_id) {
			input_spring_slider_external_count++;
		}
		// Пружины скользуна внутренняя
		if (reestr_key_element.key_element_code == keyElementCodes.spring_slider_internal_id) {
			input_spring_slider_internal_count++;
		}
		// Резервуары воздушные для автотормозов
		if (reestr_key_element.key_element_code == keyElementCodes.air_tank_auto_brakes_id) {
			input_air_tank_auto_brakes_count++;
		}
		// Тяговый хомут автосцепки
		if (reestr_key_element.key_element_code == keyElementCodes.traction_clamp_coupling_id) {
			input_traction_clamp_coupling_count++;
		}
		// Триангель
		if (reestr_key_element.key_element_code == keyElementCodes.triangel_id) {
			input_triangel_count++;
		}
		// Магистральная часть воздухораспределителя
		if (reestr_key_element.key_element_code == keyElementCodes.trunk_part_air_distributor_id) {
			input_trunk_part_air_distributor_count++;
		}
		// Адаптер подшипника
		if (reestr_key_element.key_element_code == keyElementCodes.bearing_adapter_id) {
			input_bearing_adapter_count++;
		}
		// Сменный жд кузов
		if (reestr_key_element.key_element_code == keyElementCodes.removable_railway_carcass_id) {
			input_removable_railway_carcass_count++;
		}
		// Планка фрикционная
		if (reestr_key_element.key_element_code == keyElementCodes.friction_strip_id) {
			input_friction_strip_count++;
		}
		// Скоба
		if (reestr_key_element.key_element_code == keyElementCodes.brace_id) {
			input_brace_count++;
		}
		// Чистовая ось
		if (reestr_key_element.key_element_code == keyElementCodes.clear_axis_id) {
			input_clear_axis_count++;
		}
		// Колесо
		if (reestr_key_element.key_element_code == keyElementCodes.wheel_id) {
			input_wheel_count++;
		}
		// Пластины в клиновых карманах
		if (reestr_key_element.key_element_code == keyElementCodes.wedge_pockets_id) {
			input_wedge_pockets_count++;
		}
		// Кольцо в подпятник
		if (reestr_key_element.key_element_code == keyElementCodes.saddle_ring_id) {
			input_saddle_rings_count++;
		}
		// Вставки в клиновые карманы
		if (reestr_key_element.key_element_code == keyElementCodes.wedge_pockets_inserts_id) {
			input_wedge_pockets_inserts_count++;
		}
		// Вкладыш подпятника
		if (reestr_key_element.key_element_code == keyElementCodes.saddle_bearing_id) {
			input_saddle_bearings_count++;
		}
		// Замок
		if (reestr_key_element.key_element_code == keyElementCodes.lock_id) {
			input_locks_count++;
		}
		// Валик подъемника
		if (reestr_key_element.key_element_code == keyElementCodes.elevator_roll_id) {
			input_elevator_rolls_count++;
		}
		// Корпус автосцепки
		if (reestr_key_element.key_element_code == keyElementCodes.auto_coupler_id) {
			input_auto_couplers_count++;
		}
		// Упоры передний и задний объединенные
		if (reestr_key_element.key_element_code == keyElementCodes.front_rear_detents_id){
			input_front_rear_detents++;					
		}
		// Крышка люка полувагона
		if (reestr_key_element.key_element_code == keyElementCodes.gondola_hatch_id){
			input_gondola_hatches++;					
		}
		// Черновая ось
		if (reestr_key_element.key_element_code == keyElementCodes.rough_axis_id) {
			input_rough_axis_count++;
		}
		//Корпус поглощающего аппарата
		if(reestr_key_element.key_element_code == keyElementCodes.absorbing_device_body_id){
			input_absorbing_device_body_count++;
		}
		//Тяговый хомут
		if(reestr_key_element.key_element_code == keyElementCodes.traction_clamp_id){
			input_traction_clamp_count++
		}
	}

	var vehicle_wheel_pair_count = 0;
	var vehicle_side_frame_count = 0;
	var vehicle_pressure_beam_count = 0;
	var vehicle_air_distributor_count = 0;
	var vehicle_absorbing_device_count = 0;
	var vehicle_auto_mode_count = 0;
	var vehicle_friction_wedge_count = 0;
	var vehicle_slider_body_count = 0;
	var vehicle_slider_cap_count = 0;
	var vehicle_wheel_adapter_count = 0;
	var vehicle_brake_cylinder_count = 0;
	var vehicle_spring_suspension_under_wedge_external_count = 0;
	var vehicle_spring_suspension_under_wedge_internal_count = 0;
	var vehicle_spring_suspension_external_count = 0;
	var vehicle_spring_suspension_internal_count = 0;
	var vehicle_spring_slider_external_count = 0;
	var vehicle_spring_slider_internal_count = 0;
	var vehicle_air_tank_auto_brakes_count = 0;
	var vehicle_traction_clamp_coupling_count = 0;
	var vehicle_triangel_count = 0;
	var vehicle_trunk_part_air_distributor_count = 0;
	var vehicle_bearing_adapter_count = 0;
	var vehicle_removable_railway_carcass_count = 0;
	var vehicle_friction_strip_count = 0;
	var vehicle_brace_count = 0;
	var vehicle_clear_axis_count = 0;
	var vehicle_wheel_count = 0;
	var vehicle_wedge_pockets_count = 0;
	var vehicle_saddle_rings_count = 0;
	var vehicle_wedge_pockets_inserts_count = 0;
	var vehicle_saddle_bearings_count = 0;
	var vehicle_locks_count = 0 ;
	var vehicle_elevator_rolls_count = 0;
	var vehicle_auto_couplers_count = 0;
	var vehicle_front_rear_detents = 0;
	var vehicle_gondola_hatches = 0;
	var vehicle_rough_axis_count = 0;
	var vehicle_absorbing_device_body_count = 0;
	var vehicle_traction_clamp_count = 0;


	var reestr_vehicles = db.findbyrecid("reestr_vehicles", vagonid);

	if (reestr_vehicles == null
		|| reestr_vehicles === "undefined") {
		return {
			success: false,
			message: "Вагон '" + vagonid + "' не найден в системе."
		};
	}

	var reestr_key_elementsByVehicle_params = {
		"vehicle": reestr_vehicles.recid
	};
	var reestr_key_elementsByVehicle = db.findbyparams("reestr_key_elements", reestr_key_elementsByVehicle_params)

	var dictionary_count_ke_on_vagonTmp_params = {
		"model_vagon": reestr_vehicles.dictionary_models
	};

	var dictionary_count_ke_on_vagonTmps = db.findbyparams("dictionary_count_ke_on_vagon", dictionary_count_ke_on_vagonTmp_params)

	var dictionary_count_ke_on_vagonTmp = null;
	if (!!dictionary_count_ke_on_vagonTmps) {
		dictionary_count_ke_on_vagonTmp = dictionary_count_ke_on_vagonTmps[0];
	}
	else {
		return {
			success: false,
			message: "Описание модели '" + reestr_vehicles.dictionary_models + "' не найдено в системе."
		};
	}

	if (!!reestr_key_elementsByVehicle) {
		for (var i = 0; i < reestr_key_elementsByVehicle.length; i++) {
			var reestr_key_elementByVehicle = reestr_key_elementsByVehicle[i];

			// Балка надрессорная
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.pressure_beam_id) {
				vehicle_pressure_beam_count++;
			}
			// Рама боковая
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.side_frame_id) {
				vehicle_side_frame_count++
			}
			// Колесная пара в сборе
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.wheel_pair_id) {
				vehicle_wheel_pair_count++;
			}
			// Главная часть воздухораспределителя
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.main_part_air_distributor_id) {
				vehicle_air_distributor_count++;
			}
			// Поглощающий аппарат
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.absorbing_device_id) {
				vehicle_absorbing_device_count++;
			}
			// Авторежим
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.auto_mode_id) {
				vehicle_auto_mode_count++;
			}
			// Клин фрикционный
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.friction_wedge_id) {
				vehicle_friction_wedge_count++;
			}
			// Корпус скользуна
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.slider_body_id) {
				vehicle_slider_body_count++;
			}
			// Колпак скользуна
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.slider_cap_id) {
				vehicle_slider_cap_count++;
			}
			// Адаптер колеса
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.wheel_adapter_id) {
				vehicle_wheel_adapter_count++;
			}
			// Тормозной цилиндр
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.brake_cylinder_id) {
				vehicle_brake_cylinder_count++;
			}
			// Пружины рессорного подвешивания подклиновая наружная
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.spring_suspension_under_wedge_external_id) {
				vehicle_spring_suspension_under_wedge_external_count++;
			}
			// Пружины рессорного подвешивания подклиновая внутренняя
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.spring_suspension_under_wedge_internal_id) {
				vehicle_spring_suspension_under_wedge_internal_count++;
			}
			// Пружины рессорного подвешивания наружная
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.spring_suspension_external_id) {
				vehicle_spring_suspension_external_count++;
			}
			// Пружины рессорного подвешивания внутренняя
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.spring_suspension_internal_id) {
				vehicle_spring_suspension_internal_count++;
			}
			// Пружины скользуна наружная
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.spring_slider_external_id) {
				vehicle_spring_slider_external_count++;
			}
			// Пружины скользуна внутренняя
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.spring_slider_internal_id) {
				vehicle_spring_slider_internal_count++;
			}
			// Резервуары воздушные для автотормозов
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.air_tank_auto_brakes_id) {
				vehicle_air_tank_auto_brakes_count++;
			}
			// Тяговый хомут автосцепки
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.traction_clamp_coupling_id) {
				vehicle_traction_clamp_coupling_count++;
			}
			// Триангель
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.triangel_id) {
				vehicle_triangel_count++;
			}
			// Магистральная часть воздухораспределителя
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.trunk_part_air_distributor_id) {
				vehicle_trunk_part_air_distributor_count++;
			}
			
			// Адаптер подшипника
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.bearing_adapter_id) {
				vehicle_bearing_adapter_count++;
			} 
			// Сменный жд кузов
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.removable_railway_carcass_id) {
				vehicle_removable_railway_carcass_count++;
			}
			// Планка фрикционная
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.friction_strip_id) {
				vehicle_friction_strip_count++;
			}
			// Скоба
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.brace_id) {
				vehicle_brace_count++;
			}
			// Чистовая ось
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.clear_axis_id) {
				vehicle_clear_axis_count++;
			}
			// Колесо
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.wheel_id) {
				vehicle_wheel_count++;
			}
			// Пластины в клиновых карманах
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.wedge_pockets_id) {
				vehicle_wedge_pockets_count++;
			}
			// Кольцо в подпятник
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.saddle_ring_id) {
				vehicle_saddle_rings_count++;
			}
			// Вставки в клиновые карманы
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.wedge_pockets_inserts_id) {
				vehicle_wedge_pockets_inserts_count++;
			}
			// Вкладыш подпятника
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.saddle_bearing_id) {
				vehicle_saddle_bearings_count++;
			}
			// Замок
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.lock_id) {
				vehicle_locks_count++;
			}
			// Валик подъемника
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.elevator_roll_id) {
				vehicle_elevator_rolls_count++;
			}
			// Корпус автосцепки
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.auto_coupler_id) {
				vehicle_auto_couplers_count++;
			}
			// Упоры передний и задний объединенные
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.front_rear_detents_id) {
				vehicle_front_rear_detents++;
			}
			// Крышка люка полувагона
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.gondola_hatch_id) {
				vehicle_gondola_hatches++;
			}
			// Черновая ось
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.rough_axis_id) {
				vehicle_rough_axis_count++;
			}
			//Корпус поглощающего аппарата
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.absorbing_device_body_id) {
				vehicle_absorbing_device_body_count++;
			}
			//Тяговый хомут
			if (reestr_key_elementByVehicle.key_element_code == keyElementCodes.traction_clamp_id) {
				vehicle_traction_clamp_count++;
			}
		}
	}

	// Балка надрессорная
	if ((input_pressure_beam_count + vehicle_pressure_beam_count) > dictionary_count_ke_on_vagonTmp.pressure_beam) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Балка надрессорная в количестве " + input_pressure_beam_count + ", пожалуйста проверьте введенные данные.";
	}
	// Рама боковая
	if ((input_side_frame_count + vehicle_side_frame_count) > dictionary_count_ke_on_vagonTmp.side_frame) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Рама боковая в количестве " + input_side_frame_count + ", пожалуйста проверьте введенные данные.";
	}
	// Колесная пара в сборе
	if ((input_wheel_pair_count + vehicle_wheel_pair_count) > dictionary_count_ke_on_vagonTmp.wheel_pair) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Колесная пара в сборе в количестве " + input_wheel_pair_count + ", пожалуйста проверьте введенные данные.";
	}
	// Главная часть воздухораспределителя
	if ((input_air_distributor_count + vehicle_air_distributor_count) > dictionary_count_ke_on_vagonTmp.air_distributor) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Главная часть воздухораспределителя в количестве " + input_air_distributor_count + ", пожалуйста проверьте введенные данные.";
	}
	// Поглощающий аппарат
	if ((input_absorbing_device_count + vehicle_absorbing_device_count) > dictionary_count_ke_on_vagonTmp.absorbing_device) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Поглощающий аппарат в количестве " + input_absorbing_device_count + ", пожалуйста проверьте введенные данные.";
	}
	// Авторежим
	if ((input_auto_mode_count + vehicle_auto_mode_count) > dictionary_count_ke_on_vagonTmp.auto_mode) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Авторежим в количестве " + input_auto_mode_count + ", пожалуйста проверьте введенные данные.";
	}
	// Клин фрикционный
	if ((input_friction_wedge_count + vehicle_friction_wedge_count) > dictionary_count_ke_on_vagonTmp.friction_wedge) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Клин фрикционный в количестве " + input_friction_wedge_count + ", пожалуйста проверьте введенные данные.";
	}
	// Корпус скользуна
	if ((input_slider_body_count + vehicle_slider_body_count) > dictionary_count_ke_on_vagonTmp.slider_body) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Корпус скользуна в количестве " + input_slider_body_count + ", пожалуйста проверьте введенные данные.";
	}
	// Колпак скользуна
	if ((input_slider_cap_count + vehicle_slider_cap_count) > dictionary_count_ke_on_vagonTmp.slider_cap) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Колпак скользуна в количестве " + input_slider_cap_count + ", пожалуйста проверьте введенные данные.";
	}
	// Адаптер колеса
	if ((input_wheel_adapter_count + vehicle_wheel_adapter_count) > dictionary_count_ke_on_vagonTmp.wheel_adapter) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Адаптер колеса в количестве " + input_wheel_adapter_count + ", пожалуйста проверьте введенные данные.";
	}
	// Тормозной цилиндр
	if ((input_brake_cylinder_count + vehicle_brake_cylinder_count) > dictionary_count_ke_on_vagonTmp.brake_cylinder) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Тормозной цилиндр в количестве " + input_brake_cylinder_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пружины рессорного подвешивания подклиновая наружная
	if ((input_spring_suspension_under_wedge_external_count + vehicle_spring_suspension_under_wedge_external_count) > dictionary_count_ke_on_vagonTmp.spring_suspension_under_wedge_external) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пружины рессорного подвешивания подклиновая наружная в количестве " + input_spring_suspension_under_wedge_external_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пружины рессорного подвешивания подклиновая внутренняя
	if ((input_spring_suspension_under_wedge_internal_count + vehicle_spring_suspension_under_wedge_internal_count) > dictionary_count_ke_on_vagonTmp.spring_suspension_under_wedge_internal) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пружины рессорного подвешивания подклиновая внутренняя в количестве " + input_spring_suspension_under_wedge_internal_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пружины рессорного подвешивания наружная
	if ((input_spring_suspension_external_count + vehicle_spring_suspension_external_count) > dictionary_count_ke_on_vagonTmp.spring_suspension_external) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пружины рессорного подвешивания наружная в количестве " + input_spring_suspension_external_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пружины рессорного подвешивания внутренняя
	if ((input_spring_suspension_internal_count + vehicle_spring_suspension_internal_count) > dictionary_count_ke_on_vagonTmp.spring_suspension_internal) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пружины рессорного подвешивания внутренняя в количестве " + input_spring_suspension_internal_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пружины скользуна наружная
	if ((input_spring_slider_external_count + vehicle_spring_slider_external_count) > dictionary_count_ke_on_vagonTmp.spring_slider_external) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пружины скользуна наружная в количестве " + input_spring_slider_external_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пружины скользуна внутренняя
	if ((input_spring_slider_internal_count + vehicle_spring_slider_internal_count) > dictionary_count_ke_on_vagonTmp.spring_slider_internal) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пружины скользуна внутренняя в количестве " + input_spring_slider_internal_count + ", пожалуйста проверьте введенные данные.";
	}
	// Резервуары воздушные для автотормозов
	if ((input_air_tank_auto_brakes_count + vehicle_air_tank_auto_brakes_count) > dictionary_count_ke_on_vagonTmp.air_tank_auto_brakes) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Резервуары воздушные для автотормозов в количестве " + input_air_tank_auto_brakes_count + ", пожалуйста проверьте введенные данные.";
	}
	// Тяговый хомут автосцепки
	if ((input_traction_clamp_coupling_count + vehicle_traction_clamp_coupling_count) > dictionary_count_ke_on_vagonTmp.traction_clamp_coupling) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Тяговый хомут автосцепки в количестве " + input_traction_clamp_coupling_count + ", пожалуйста проверьте введенные данные.";
  	}
   	// Триангель
	if ((input_triangel_count + vehicle_triangel_count) > dictionary_count_ke_on_vagonTmp.triangel) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Триангель в количестве " + input_triangel_count + ", пожалуйста проверьте введенные данные.";
   	}
	// Магистральная часть воздухораспределителя
	if ((input_trunk_part_air_distributor_count + vehicle_trunk_part_air_distributor_count) > dictionary_count_ke_on_vagonTmp.trunk_part_air_distributor) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Магистральная часть воздухораспределителя в количестве " + input_trunk_part_air_distributor_count + ", пожалуйста проверьте введенные данные.";
	}
	// Адаптер подшипника
	if ((input_bearing_adapter_count + vehicle_bearing_adapter_count) > dictionary_count_ke_on_vagonTmp.bearing_adapter) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Адаптер подшипника в количестве " + input_bearing_adapter_count + ", пожалуйста проверьте введенные данные.";
	}
	// Сменный жд кузов
	if ((input_removable_railway_carcass_count + vehicle_removable_railway_carcass_count) > dictionary_count_ke_on_vagonTmp.railway_carcass) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Сменный ЖД кузов в количестве " + input_removable_railway_carcass_count + ", пожалуйста проверьте введенные данные.";
	}
	// Планка фрикционная
	if ((input_friction_strip_count + vehicle_friction_strip_count) > dictionary_count_ke_on_vagonTmp.friction_strip) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Планка фрикционная в количестве " + input_friction_strip_count + ", пожалуйста проверьте введенные данные.";
	}
	// Скоба
	if ((input_brace_count + vehicle_brace_count) > dictionary_count_ke_on_vagonTmp.brace) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Скоба в количестве " + input_brace_count + ", пожалуйста проверьте введенные данные.";
	}
	// Чистовая ось
	if ((input_clear_axis_count + vehicle_clear_axis_count) > dictionary_count_ke_on_vagonTmp.clear_axis) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Чистовая ось в количестве " + input_clear_axis_count + ", пожалуйста проверьте введенные данные.";
	}
	// Колесо
	if ((input_wheel_count + vehicle_wheel_count) > dictionary_count_ke_on_vagonTmp.wheel) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Колесо в количестве " + input_wheel_count + ", пожалуйста проверьте введенные данные.";
	}
	// Пластины в клиновых карманах
	if ((input_wedge_pockets_count + vehicle_wedge_pockets_count) > dictionary_count_ke_on_vagonTmp.wedge_pockets) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Пластины в клиновых карманах в количестве " + input_wedge_pockets_count + ", пожалуйста проверьте введенные данные.";
	}
	// Кольцо в подпятник
	if ((input_saddle_rings_count + vehicle_saddle_rings_count) > dictionary_count_ke_on_vagonTmp.saddle_rings) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Кольцо в подпятник в количестве " + input_saddle_rings_count + ", пожалуйста проверьте введенные данные.";
	}
	// Вставки в клиновые карманы
	if ((input_wedge_pockets_inserts_count + vehicle_wedge_pockets_inserts_count) > dictionary_count_ke_on_vagonTmp.wedge_pockets_inserts) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Вставки в клиновые карманы в количестве " + input_wedge_pockets_inserts_count + ", пожалуйста проверьте введенные данные.";
	}
	// Вкладыш подпятника
	if ((input_saddle_bearings_count + vehicle_saddle_bearings_count) > dictionary_count_ke_on_vagonTmp.saddle_bearings) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Вкладыш подпятника в количестве " + input_saddle_bearings_count + ", пожалуйста проверьте введенные данные.";
	}
	// Замок
	if ((input_locks_count + vehicle_locks_count) > dictionary_count_ke_on_vagonTmp.locks) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Замок в количестве " + input_locks_count + ", пожалуйста проверьте введенные данные.";
	}
	// Валик подъемника
	if ((input_elevator_rolls_count + vehicle_elevator_rolls_count) > dictionary_count_ke_on_vagonTmp.elevator_rolls) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Валик подъемника в количестве " + input_elevator_rolls_count + ", пожалуйста проверьте введенные данные.";
	}
	// Корпус автосцепки
	if ((input_auto_couplers_count + vehicle_auto_couplers_count) > dictionary_count_ke_on_vagonTmp.auto_couplers) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Корпус автосцепки в количестве " + input_auto_couplers_count + ", пожалуйста проверьте введенные данные.";
	}
	// Упоры передний и задний объединенные
	if ((input_front_rear_detents + vehicle_front_rear_detents) > dictionary_count_ke_on_vagonTmp.front_rear_detents) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Упоры передний и задний объединенные в количестве " + input_front_rear_detents + ", пожалуйста проверьте введенные данные.";
	}
	// Крышка люка полувагона
	if ((input_gondola_hatches + vehicle_gondola_hatches) > dictionary_count_ke_on_vagonTmp.gondola_hatches) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Крышка люка полувагона в количестве " + input_gondola_hatches + ", пожалуйста проверьте введенные данные.";
	}
	// Черновая ось
	if ((input_rough_axis_count + vehicle_rough_axis_count) > dictionary_count_ke_on_vagonTmp.rough_axis) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Черновая ось в количестве " + input_rough_axis_count + ", пожалуйста проверьте введенные данные.";
	}
	//Корпус поглощающего аппарата
	if ((input_absorbing_device_body_count + vehicle_absorbing_device_body_count) > dictionary_count_ke_on_vagonTmp.absorbing_device_body) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Корпус поглощающего аппарата в количестве " + input_absorbing_device_body_count + ", пожалуйста проверьте введенные данные.";
	}
	//Корпус поглощающего аппарата 
	if ((input_traction_clamp_count + vehicle_traction_clamp_count) > dictionary_count_ke_on_vagonTmp.traction_clamp) {
		isparamsvalid = false;
		errormessage += "На вагон нельзя установить элемент типа Тяговый хомут в количестве " + input_traction_clamp_count + ", пожалуйста проверьте введенные данные.";
	}


	if (!isparamsvalid) {
		return {
			success: false,
			message: errormessage
		};
	}
	else {
		return {
			success: true
		};
	}
}

// Установить СЧ на вагон в блокчейне.
function addtowagonblockchain(params) {
	// {
	// 	"method": {
	// 		"package":"NBD",
	// 		"function":"object_add_to_wagon"
	// 	},
	// 	"object_link": <object link>,
	// 	"info": {
	// 		"Заводской номер вагона": "",
	// 		"Дата установки СЧ на вагон": "",
	// 		"Позиция СЧ на вагоне": "",
	// 		"Год окончания гамма-процентного ресурса детали": ""
	// 	}
	// }

	var request = {
		"method": {
			"function": "object_add_to_wagon",
			"package": "NBD"
		},
		"object_link": {
			"hash": params.link.hash,
			"node": params.link.node,
			"recn": params.link.recn,
			"tn": params.link.tn
		},
		"info": null
	};

	if (isNotEmptyString(params.gamma_percent_resource_end_date)) {
		request.info = {
			"Заводской номер вагона": params.vehicle_manufacturer_number,
			"Дата установки на вагон": params.install_ke_date,
			"Позиция на вагоне": params.position_on_vagon,
			"Год окончания гамма-процентного ресурса детали": params.gamma_percent_resource_end_date
		}
	}
	else {
		request.info = {
			"Заводской номер вагона": params.vehicle_manufacturer_number,
			"Дата установки на вагон": params.install_ke_date,
			"Позиция на вагоне": params.position_on_vagon
		}
	}

	var blockchainResponse = sendrequest(request, params.nodeip);
	blockchainResponse.request = request;
	return blockchainResponse;
}

// Снять СЧ с вагона в блокчейне.
function removefromwagonblockchain(params) {
	// 	{"method":{"package":"NBD",
	// "node":<package publisher>,
	// "function":"object_remove_from_wagon"},
	// "object_link":<object link
	// structure>}

	var request =
		{
			"method":
				{
					"function": "object_remove_from_wagon",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				}
		}

	var blockchainResponse =  sendrequest(request, params.nodeip);
	blockchainResponse.request = request;
	return blockchainResponse;
}

function recyclingblockchain(params) {
	//{
	//	"method": {
	//		"package": "NBD",
	//		"node": <package publisher>,
	//		"function": "object_delete"
	//	},

	//	"object_link": <object link structure>
	//}

	var request =
		{
			"method":
				{
					"function": "object_delete",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				}
		}

	return sendrequest(request, params.nodeip);
}

/**
* @param {params} Параметры
*/
function repairblockchain(params) {
	//{
	//	"method": {
	//		"package": "NBD",
	//		"node": <package publisher>,
	//		"function": "object_repair"
	//	},

	//	"object_link": <object link structure>,
	//	"repair_info": <repair info structure>
	//}

	var request =
		{
			"method":
				{
					"function": "object_repair",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				},
			"repair_info":
				{
					"comments": params.repair_info.comments
				}
		}

	return sendrequest(request, params.nodeip);
}

// Передача объекта собственнику.
function changeownerlockchain(params) {
	//{
	//	"method": {
	//		"package": "NBD",
	//		"node": <package publisher>,
	//		"function": "object_change_owner"
	//	},

	//	"object_link": <object link structure>,
	//	"owner": <owner string>
	//}

	var request =
		{
			"method":
				{
					"function": "object_change_owner",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				},
			"owner": params.owner
		}

	return sendrequest(request, params.nodeip);
}

// Blockchain - Приостановление использования
function conservekeyelementblockchain(params) {
	//{
	//	"method": {
	//		"package": "NBD",
	//		"node": <package publisher>,
	//		"function": "object_conserve"
	//	},

	//	"object_link":<object link structure>
	//}

	var request =
		{
			"method":
				{
					"function": "object_conserve",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				}
		}

	var blockchainResponse = sendrequest(request, params.nodeip);
	blockchainResponse.request = request;
	return blockchainResponse;
}

// Blockchain - Возобновление использования
function restorekeyelementblockchain(params) {
	//{
	//	"method": {
	//		"package": "NBD",
	//		"node": <package publisher>,
	//		"function": "object_restore"
	//	},

	//	"object_link":<object link structure>
	//}

	var request =
		{
			"method":
				{
					"function": "object_restore",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				}
		}

	var blockchainResponse = sendrequest(request, params.nodeip);
	blockchainResponse.request = request;
	return blockchainResponse;
}

//a.polunina убрала в рамках задачи https://rm.mfc.ru/issues/46142
// // Реестр проверки на легитимность - Отправить запрос производителю
// function sendrequestverifylegitimacy(requestdata) {
// 	var res = true;
// 	var isparamsvalid = true;
// 	var errormessage = "Ошибка в параметрах. ";

// 	// Получаем запись из реестра проверки на легитимность по идентификатору
// 	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

// 	if (!!request_verify_legitimacy) {
// 		if (!!request_verify_legitimacy.reestr_key_elements) {
// 			// Получаем составная часть по идентификатору
// 			var reestr_key_element = db.findbyrecid("reestr_key_elements", request_verify_legitimacy.reestr_key_elements);
// 			var nodeip = getnodeipbymember(reestr_key_element.owner);

// 			if (!!reestr_key_element) {

// 				var conservekeyelementbch = {
// 					"nodeip": nodeip,
// 					"link":
// 						{
// 							"hash": reestr_key_element.blockchainhash,
// 							"node": reestr_key_element.blockchainnode,
// 							"recn": reestr_key_element.blockchainrecn,
// 							"tn": reestr_key_element.blockchaintn
// 						}
// 				};

// 				// Делаем запрос в блокчейн на "Приостановление использования"
// 				var blockchainResponse = conservekeyelementblockchain(conservekeyelementbch);

// 				if (!!blockchainResponse.result) {
// 					// Формируем запись для таблицы История составных частей
// 					// Действие - Консервация
// 					var logItem = set_ke_log(reestr_key_element, "bfb40741-c2c3-4d8f-b39c-0610636ae34c");

// 					res = res && db.insert("log", logItem);

// 					// Ставим текущий статус СЧ - Приостановлена эксплуатация
// 					reestr_key_element.statuske = "2fb7fcd3-2754-4605-926c-33ddf3834a8a";
// 					reestr_key_element.last_blockchain_request = JSON.stringify(conservekeyelementbch, null, '\t');

// 					res = res && db.update("reestr_key_elements", reestr_key_element);

// 					var reestr_member = getmemberbyuser();
// 					if (!!reestr_member) {
// 						request_verify_legitimacy.request_node = reestr_member.node;
// 					}

// 					// Дата взятия заявки в работу
// 					request_verify_legitimacy.accept_date = new Date().toISOString();
// 					// Статус заявки - В работе
// 					request_verify_legitimacy.request_status = "41616561-370e-474b-85b4-aea1bffc530c";

// 					res = res && db.update("reestr_verify_legitimacy", request_verify_legitimacy);

// 				}
// 				else {
// 					return blockchainResponse;
// 				}
// 			} else {
// 				isparamsvalid = false;
// 				errormessage += "составная часть '" + requestdata.recid + "' не найден в системе.";
// 			}
// 		}
// 	} else {
// 		isparamsvalid = false;
// 		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
// 	}

// 	if (isparamsvalid) {
// 	} else {
// 		return {
// 			success: false,
// 			message: errormessage
// 		};
// 	}

// 	return res;
// }

// Реестр проверки на легитимность - Отказать
function rejectrequestverifylegitimacy(requestdata) {
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем запись из реестра проверки на легитимность по идентификатору
	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

	if (!!request_verify_legitimacy) {
		// Статус заявки - Закрыта
		request_verify_legitimacy.request_status = "929ecd01-3b2c-4617-874c-03239b9915df";
		// Принятое решение - Отказ по заявке
		request_verify_legitimacy.decision = "bca0bee6-062f-4d69-95d4-a394f906aaa7";

		res = res && db.update("reestr_verify_legitimacy", request_verify_legitimacy);
	} else {
		isparamsvalid = false;
		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
	}

	if (isparamsvalid) {
	} else {
		return {
			success: false,
			message: errormessage
		};
	}

	return res;
}

// Реестр проверки на легитимность - Отправить ответ оператору
function sendresponsetooperator(requestdata) {
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем запись из реестра проверки на легитимность по идентификатору
	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

	if (!!request_verify_legitimacy) {
		// Статус заявки - Решение принято
		request_verify_legitimacy.request_status = "07f6d027-37ad-46a2-a73c-f907e392c46b";
		// Дата принятия решения текущая
		request_verify_legitimacy.decision_date = new Date().toISOString();

		res = res && db.update("reestr_verify_legitimacy", request_verify_legitimacy);
	} else {
		isparamsvalid = false;
		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
	}

	if (isparamsvalid) {
	} else {
		return {
			success: false,
			message: errormessage
		};
	}

	return res;
}

// Реестр проверки на легитимность - Восстановление
function restoremaintenanceke(requestdata) {
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем запись из реестра проверки на легитимность по идентификатору
	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

	if (!!request_verify_legitimacy) {
		if (!!request_verify_legitimacy.reestr_key_elements) {
			// Получаем составная часть по идентификатору
			var reestr_key_element = db.findbyrecid("reestr_key_elements", request_verify_legitimacy.reestr_key_elements);

			if (!!reestr_key_element) {
				var params_filter = {
					"ketype": reestr_key_element.typeke,
					"kenumber": reestr_key_element.numberke,
					"hash": reestr_key_element.blockchainhash
				};
				var keblockchain = getkelistfilter(params_filter);

				if (!!keblockchain && !!keblockchain.result && !!keblockchain.result[0]) {
					var keblockchainobj = keblockchain.result[0];

					var restorekeyelementbch = {
						"link":
							{
								"hash": keblockchainobj.link.hash,
								"node": keblockchainobj.link.node,
								"recn": keblockchainobj.link.recn,
								"tn": keblockchainobj.link.tn
							}
					};

					// Делаем запрос в блокчейн на "Возобновление использования"
					var blockchainResponse = restorekeyelementblockchain(restorekeyelementbch);

					if (!!blockchainResponse.result) {
						// Формируем запись для таблицы История составных частей
						// Действие - Расконсервация
						var logItem = set_ke_log(reestr_key_element, "e9425a93-73ca-4068-b09f-a25951a18489");

						res = res && db.insert("log", logItem);
						reestr_key_element.last_blockchain_request = JSON.stringify(blockchainResponse.request);
						// Текущий статус СЧ - Возобновлена эксплуатация
						reestr_key_element.statuske = "f7730d93-7567-4fe7-b146-b5d9b2559d02";
						// Текущий статус ЭП - Действующий
						reestr_key_element.statusep = "772e3af1-8e59-4167-91d7-c2a69fe8656d";

						res = res && db.update("reestr_key_elements", reestr_key_element);

						// Статус заявки - Закрыта
						request_verify_legitimacy.request_status = "929ecd01-3b2c-4617-874c-03239b9915df";

						res = res && db.update("reestr_verify_legitimacy", request_verify_legitimacy);

					}
					else {
						return blockchainResponse;
					}
				}
			} else {
				isparamsvalid = false;
				errormessage += "составная часть '" + requestdata.recid + "' не найден в системе.";
			}
		}
	} else {
		isparamsvalid = false;
		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
	}

	if (isparamsvalid) {
	} else {
		return {
			success: false,
			message: errormessage
		};
	}

	return res;
}

// Реестр проверки на легитимность - Истек срок рассмотрения
function expiredtimerequestverifylegitimacy(requestdata) {
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем запись из реестра проверки на легитимность по идентификатору
	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

	if (!!request_verify_legitimacy) {
		// Статус заявки - Срок рассмотрения истек
		request_verify_legitimacy.request_status = "1323cb5b-5180-496a-a562-db29082190b0";

		res = res && db.update("reestr_verify_legitimacy", request_verify_legitimacy);
	} else {
		isparamsvalid = false;
		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
	}

	if (isparamsvalid) {
	} else {
		return {
			success: false,
			message: errormessage
		};
	}

	return res;
}

//a.polunina убрала в рамках задачи https://rm.mfc.ru/issues/46142
// Реестр проверки на легитимность - Утилизация
// function recyclingillegitimateke(requestdata) {
// 	var res = true;
// 	var isparamsvalid = true;
// 	var errormessage = "Ошибка в параметрах. ";

// 	// Получаем запись из реестра проверки на легитимность по идентификатору
// 	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

// 	if (!!request_verify_legitimacy) {
// 		if (!!request_verify_legitimacy.reestr_key_elements) {
// 			// Получаем составная часть по идентификатору
// 			var reestr_key_element = db.findbyrecid("reestr_key_elements", request_verify_legitimacy.reestr_key_elements);

// 			if (!!reestr_key_element) {
// 				var nodeip = getnodeipbyke(reestr_key_element.owner);

// 				var params_filter = {
// 					"nodeip": nodeip,
// 					"ketype": reestr_key_element.typeke,
// 					"kenumber": reestr_key_element.numberke,
// 					"hash": reestr_key_element.blockchainhash
// 				};

// 				var keblockchain = getkelistfilter(params_filter);

// 				if (!!keblockchain && !!keblockchain.result && !!keblockchain.result[0]) {
// 					var keblockchainobj = keblockchain.result[0];

// 					var recyclingbch = {
// 						"nodeip": nodeip,
// 						"link":
// 							{
// 								"hash": keblockchainobj.link.hash,
// 								"node": keblockchainobj.link.node,
// 								"recn": keblockchainobj.link.recn,
// 								"tn": keblockchainobj.link.tn
// 							}
// 					};

// 					// Делаем запрос в блокчейн на "Утилизацию"
// 					var blockchainResponse = recyclingblockchain(recyclingbch);

// 					if (!!blockchainResponse.result) {
// 						// Тип действия с СЧ - Утилизация
// 						var logItem = set_ke_log(reestr_key_element, "65a774bb-64e6-4eca-b60e-a0e1438af55e");
// 						// Убрано из логов в рамках https://rm.mfc.ru/issues/42476
// 						// "utilization_reason": null,

// 						res = res && db.insert("log", logItem);

// 						// Текущий статус СЧ - Утилизация
// 						reestr_key_element.statuske = "32f6eded-2f6e-4ce8-a4d9-5f0378e4c3b0";
// 						// Текущий статус ЭП - Аннулированный
// 						reestr_key_element.statusep = "3de2b3e3-ff66-4f00-8a99-f4fd63858cc3";

// 						res = res && db.update("reestr_key_elements", reestr_key_element);

// 						event.log("reestr_key_elements",
// 							reestr_key_element.recid,
// 							"Утилизирован СЧ с номером " + reestr_key_element.numberke + ".",
// 							eventTypeEnum.Info);
// 					}
// 					else {
// 						return blockchainResponse;
// 					}
// 				}
// 				else {
// 					isparamsvalid = false;
// 					errormessage += "составная часть с номером '" + reestr_key_element.numberke + "' не найден в блокчейне.";
// 				}
// 			}
// 			else {
// 				isparamsvalid = false;
// 				errormessage += "составная часть '" + reestr_key_element.recid + "' не найден в системе.";
// 			}
// 		}
// 	} else {
// 		isparamsvalid = false;
// 		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
// 	}

// 	if (isparamsvalid) {
// 	}
// 	else {
// 		return {
// 			success: false,
// 			message: errormessage
// 		};
// 	}

// 	return res;
// }

// Реестр проверки на легитимность - Отправить ответ эксплуатанту
function sendresponsetoekspluatant(requestdata) {
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем запись из реестра проверки на легитимность по идентификатору
	var request_verify_legitimacy = db.findbyrecid("reestr_verify_legitimacy", requestdata.recid);

	if (!!request_verify_legitimacy) {
		// Статус заявки - Закрыта
		request_verify_legitimacy.request_status = "929ecd01-3b2c-4617-874c-03239b9915df";

		res = res && db.update("reestr_verify_legitimacy", request_verify_legitimacy);
	} else {
		isparamsvalid = false;
		errormessage += "Заявка проверки на легитимность '" + requestdata.recid + "' не найден в системе.";
	}

	if (isparamsvalid) {
	} else {
		return {
			success: false,
			message: errormessage
		};
	}

	return res;
}

//a.polunina Убрала в рамках задачи https://rm.mfc.ru/issues/46142

// // Реестр составных частей - Приостановить эксплуатацию
// function suspendoperationke(requestdata) {
// 	var res = true;
// 	var isparamsvalid = true;
// 	var errormessage = "Ошибка в параметрах. ";

// 	// Получаем составная часть по идентификатору
// 	var reestr_key_element = db.findbyrecid("reestr_key_elements", requestdata.recid);

// 	if (isNullObject(reestr_key_element)) {
// 		return badResp("составная часть '" + requestdata.recid + "' не найден в системе.");
// 	}

// 	var nodeip = getnodeipbymember(reestr_key_element.owner);

// 	var conservekeyelementbch = {
// 		"nodeip": nodeip,
// 		"link":
// 			{
// 				"hash": reestr_key_element.blockchainhash,
// 				"node": reestr_key_element.blockchainnode,
// 				"recn": reestr_key_element.blockchainrecn,
// 				"tn": reestr_key_element.blockchaintn
// 			}
// 	};

// 	// Делаем запрос в блокчейн на "Приостановление использования"
// 	var blockchainResponse = conservekeyelementblockchain(conservekeyelementbch);

// 	if (!!blockchainResponse.result) {
// 		// Формируем запись для таблицы История составных частей
// 		// Действие - Консервация
// 		var logItem = set_ke_log(reestr_key_element, "bfb40741-c2c3-4d8f-b39c-0610636ae34c");

// 		res = res && db.insert("log", logItem);

// 		// Ставим текущий статус СЧ - Приостановлена эксплуатация
// 		reestr_key_element.statuske = "2fb7fcd3-2754-4605-926c-33ddf3834a8a";
// 		reestr_key_element.last_blockchain_request = JSON.stringify(conservekeyelementbch, null, '\t');

// 		res = res && db.update("reestr_key_elements", reestr_key_element);
// 	}
// 	else {
// 		return blockchainResponse;
// 	}

// 	if (isparamsvalid) {
// 	} else {
// 		return {
// 			success: false,
// 			message: errormessage
// 		};
// 	}

// 	return res;
// }

// // Реестр составных частей - Возобновить эксплуатацию
// function restoreoperationke(requestdata) {
// 	var res = true;
// 	var isparamsvalid = true;
// 	var errormessage = "Ошибка в параметрах. ";

// 	var reestr_key_element = db.findbyrecid("reestr_key_elements", requestdata.recid);

// 	if (isNullObject(reestr_key_element)) {
// 		return badResp("составная часть '" + requestdata.recid + "' не найден в системе.");
// 	}

// 	var nodeip = getnodeipbymember(reestr_key_element.owner);

// 	var restorekeyelementbch = {
// 		"nodeip": nodeip,
// 		"link":
// 			{
// 				"hash": reestr_key_element.blockchainhash,
// 				"node": reestr_key_element.blockchainnode,
// 				"recn": reestr_key_element.blockchainrecn,
// 				"tn": reestr_key_element.blockchaintn
// 			}
// 	};

// 	// Делаем запрос в блокчейн на "Возобновление использования"
// 	var blockchainResponse = restorekeyelementblockchain(restorekeyelementbch);

// 	if (!!blockchainResponse.result) {
// 		// Формируем запись для таблицы История составных частей
// 		// Действие - Расконсервация
// 		var logItem = set_ke_log(reestr_key_element, "e9425a93-73ca-4068-b09f-a25951a18489");

// 		res = res && db.insert("log", logItem);

// 		// Текущий статус СЧ - Возобновлена эксплуатация
// 		reestr_key_element.statuske = "f7730d93-7567-4fe7-b146-b5d9b2559d02";

// 		res = res && db.update("reestr_key_elements", reestr_key_element);
// 	}
// 	else {
// 		return blockchainResponse;
// 	}

// 	if (isparamsvalid) {
// 	} else {
// 		return {
// 			success: false,
// 			message: errormessage
// 		};
// 	}

// 	return res;
// }

// // Сгенерировать номера СЧ и штрихкоды для них
// function generatebarcodesbynumbers(params) {
// 	// Генерируем номера
// 	var generaterfidRes = generaterfid(params);

// 	if (!generaterfidRes.success) {
// 		return generaterfidRes;
// 	}

// 	var ke_numbers_params = {
// 		"rfid_request": params.recid
// 	};

// 	// Получаем все номера из пула
// 	var ke_numbers = db.findbyparams("ke_numbers", ke_numbers_params);

// 	var ke_numbers_array = [];

// 	// Формируем массив номеров из пула
// 	if (!!ke_numbers) {
// 		for (var i = 0; i < ke_numbers.length; i++ ) {
// 			ke_numbers_array.push(ke_numbers[i].recname);
// 		}
// 	}
// 	else {
// 		return {
// 			success: false,
// 			message: "Не удалось найти сгенерированные номера2"
// 		};
// 	}

// 	// Вызываем серверный метод по генерации списка штрихкодов
// 	var numbers_barcodes_dictionary_object = barcode.generatelist(ke_numbers_array, 32, 52, 52, 104, 104);

// 	if (numbers_barcodes_dictionary_object !== "undefined"
// 		&& numbers_barcodes_dictionary_object != null
// 		&& numbers_barcodes_dictionary_object.data != null
// 		&& !!numbers_barcodes_dictionary_object.data) {

// 		var numbers_barcodes_dictionary = numbers_barcodes_dictionary_object.data;

// 		try {
// 			var upload_files_req = [];

// 			// Формируем массив загружаемых на сервер файлов
// 			for (var i = 0; i < ke_numbers.length; i++) {
// 				var number_barcode_base64 = numbers_barcodes_dictionary[ke_numbers[i].recname];

// 				var upload_file_params = {
// 					"file": {
// 						"name": "barcode-" + ke_numbers[i].recname + ".jpeg",
// 						"content": number_barcode_base64
// 					},
// 					"columnName": "barcode",
// 					"entityName": "ke_numbers",
// 					"description": "",
// 					"entityId": ke_numbers[i].recid
// 				};

// 				upload_files_req.push(upload_file_params);
// 			}

// 			// Отправляем на сервер файлы группами
// 			var group_size = 200;
// 			if (upload_files_req.length <= group_size) {
// 				// Загружаем файлы на сервер
// 				file.upload(upload_files_req);
// 			}
// 			else {
// 				for (var i = 0, j = upload_files_req.length; i < j; i += group_size) {
// 					var files_group = upload_files_req.slice(i, i + group_size);
// 					// Загружаем группу файлов на сервер
// 					file.upload(files_group);
// 				}
// 			}
// 		}
// 		catch (error) {
// 			return {
// 				success: false,
// 				message: "Произошла ошибка в процессе загрузки изображений Data Matrix кодов на сервер."
// 			};
// 		}

// 		var rfid_request = db.findbyrecid("rfid_request", params.recid);
// 		var rfid_request_status = rfid_request.rfid_request_status;

// 		rfid_request.rfid_request_status = rfid_request_status;
// 		rfid_request.barcodes_generated = true;

// 		db.update("rfid_request", rfid_request);
// 	}
// 	else {
// 		return {
// 			success: false,
// 			message: "Не удалось сгенерировать Data Matrix коды для номеров из пула"
// 		};
// 	}

// 	return {
// 		success: true,
// 		message: "Data Matrix коды успешно сгенерированы"
// 	};
// }


// Реестр составных частей - Запрет к обращению СЧ в составе СЕ
function forbidcirculationkeinassemblyunit(data){
	if(data.cancel){
		return {
			success: true,
			message: "",
			closeForm: true,
			showMessage: false
		};
	}
	if(isEmptyString(data.ke_node)){
		return {
			success: false,
			message: "СЧ не имеет родительской СЕ, возможно запись была обновлена",
			closeForm: false,
			showMessage: true
		};
	}
	var assemblyUnit = db.findbyrecid("reestr_ke_nodes", data.ke_node);
	if(isNullObject(assemblyUnit)){
		return {
			success: false,
			message: "Не найдена родительская СЕ в системе.",
			closeForm: false,
			showMessage: true
		}; 
	}
	var requestParams = {
		"recid": assemblyUnit.recid,
		"rejection_reason": data.rejection_reason
	}
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/forbiddanceassemblyunitcirculation", "post", requestParams, null);
	if(res.success){
		res["closeForm"] = true;
		res["showMessage"] = true;
	} else {
		res["closeForm"] = false;
		res["showMessage"] = true;
	}
	return res;
}
// Реестр СЕ - Запрет к обращению СЕ в составе СЕ
function forbidcirculationnodeinassemblyunit(data){
	if(data.cancel){
		return {
			success: true,
			message: "",
			closeForm: true,
			showMessage: false
		};
	}
	if(isEmptyString(data.parent_ke_node)){
		return {
			success: false,
			message: "Узел/СЕ не имеет родительской СЕ",
			closeForm: false,
			showMessage: true
		};
	}
	var assemblyUnitRes = getparentse(data.parent_ke_node);
	if(!assemblyUnitRes.success){
		return {
			success: false,
			message: "Не найдена родительская СЕ в системе.",
			closeForm: false,
			showMessage: true
		}; 
	}
	var requestParams = {
		"recid": assemblyUnitRes.data.recid,
		"rejection_reason": data.rejection_reason
	}
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/forbiddanceassemblyunitcirculation", "post", requestParams, null);
	if(res.success){
		res["closeForm"] = true;
		res["showMessage"] = true;
	} else {
		res["closeForm"] = false;
		res["showMessage"] = true;
	}
	return res;
}

// Реестр составных частей - Запрет к обращению
function forbidcirculation(params) {
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем составная часть по идентификатору
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	if (isNullObject(reestr_key_element)) {
		return badResp("составная часть не найден в системе.");
	}

	var rzd_url = get_rzd_urls_portal_settings();
	if(!rzd_url.success){
		return badResp("Не удалось получить адрес АРМ Росжелдора");
	}

	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		return badResp("Невозможно получить текущего пользователя");
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		return badResp("Получатель не найден в системе");
	}

	//Проверяем что у СЧ нет ссылки на партию
	if (reestr_key_element.batchid != null && reestr_key_element.batchid != "") {
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", reestr_key_element.batchid);
		if (isNullObject(batch)) {
			return badResp("Запись о партии не найдена в системе");
		}
		if (member.recid == batch.recipient_droplist){
			//если получатель
			if (batch.batch_status != "ef519ef4-ec73-4776-9295-2d007bb32907" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp(String().concat("Действие \"Запрет к обращению\" недоступно для СЧ, включенного в партию <a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\"> №", batch.batch_number, "</a> в текущем статусе."));
			}
		} else{
			//если отправитель
			//статус партии отклонена или получена частично флаг false
			if (batch.batch_status != "281496a2-3d01-479e-80cb-96e6e6e76135" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp(String().concat("Действие \"Запрет к обращению\" недоступно для СЧ, включенного в партию <a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\"> №", batch.batch_number, "</a> в текущем статусе."));
			}
		}
	}
	var nodeip = db.findbyparams("local_data_node_blockchain", {'recstate':1});

	var conservekeyelementbch = {
		"nodeip": nodeip.ip_address,
		"link":
			{
				"hash": reestr_key_element.blockchainhash,
				"node": reestr_key_element.blockchainnode,
				"recn": reestr_key_element.blockchainrecn,
				"tn": reestr_key_element.blockchaintn
			}
	};

	// Делаем запрос в блокчейн на "Приостановление использования"
	var blockchainResponse = conservekeyelementblockchain(conservekeyelementbch);

	if (!!blockchainResponse.result) {
		// Формируем запись для таблицы История составных частей
		// Действие - Запрет к обращению
		var logItem = set_ke_log(reestr_key_element, "4b0c4fb0-d564-4644-b0b8-575e727f4c88");
		// Убрано из логов в рамках https://rm.mfc.ru/issues/42476
		// "reason": params.rejection_reason

		// Сохраняем запись в Историю СЧ
		//res = res && db.insert("log", logItem);
		// Отправка записи в АРМ Росжелдора 29.09.2020 amaslov 44458
		MakeLogRecord("log", logItem, rzd_url.rzd_name_url);

		// Запомним текущий статус СЧ
		reestr_key_element.previous_statuske = reestr_key_element.statuske;

		// Ставим текущий статус СЧ - Запрещен к обращению
		reestr_key_element.statuske = commonConst.ZapreshenId;
		reestr_key_element.last_blockchain_request = JSON.stringify(blockchainResponse.request);

		res = res && db.update("reestr_key_elements", reestr_key_element);
	} else {
		return badResp(blockchainResponse);
	}

	if (!isparamsvalid) {
		return badResp(errormessage);
	}

	return res;
}

// Реестр составных частей - Возврат в обращение
function returncirculation(params) {
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	var res = true;
	var isparamsvalid = true;
	var errormessage = "Ошибка в параметрах. ";

	// Получаем составная часть по идентификатору
	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
	if (isNullObject(reestr_key_element)) {
		return badResp("составная часть не найден в системе.");
	}

	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		return badResp("Невозможно получить текущего пользователя");
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		return badResp("Получатель не найден в системе");
	}

	//Проверяем что у СЧ нет ссылки на партию
	if (reestr_key_element.batchid != null && reestr_key_element.batchid != "") {
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", reestr_key_element.batchid);
		if (isNullObject(batch)) {
			return badResp("Запись о партии не найдена в системе");
		}
		if (member.recid == batch.recipient_droplist){
			//если получатель
			if (batch.batch_status != "ef519ef4-ec73-4776-9295-2d007bb32907" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp(String().concat("Действие \"Запрет к обращению\" недоступно для СЧ, включенного в партию <a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\"> №", batch.batch_number, "</a> в текущем статусе."));
			}
		} else{
			//если отправитель
			//статус партии отклонена или получена частично флаг false
			if (batch.batch_status != "281496a2-3d01-479e-80cb-96e6e6e76135" && batch.batch_status != "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && reestr_key_element.change_node != true){
				return badResp(String().concat("Действие \"Запрет к обращению\" недоступно для СЧ, включенного в партию <a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\"> №", batch.batch_number, "</a> в текущем статусе."));
			}
		}
	}

	//Если СЧ в составе СЕ - возвращаем в обращение весь СЕ
	if(isNotEmptyString(reestr_key_element.ke_node)){
		var requestParams = {
			"recid": reestr_key_element.ke_node
		}
		return plugins.callAsMethod("/plugins/nbdlogicplugin/returnassemblyunitcirculation", "post", requestParams, null)
	}

	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		return badResp("Невозможно получить текущего пользователя");
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		return badResp("Получатель не найден в системе");
	}

	var rzd_url = get_rzd_urls_portal_settings();
	if(!rzd_url.success){
		return badResp("Не удалось получить адрес АРМ Росжелдора");
	}

	var nodeip = db.findbyparams("local_data_node_blockchain", {'recstate':1});

	var restorekeyelementbch = {
		"nodeip": nodeip.ip_address,
		"link":
			{
				"hash": reestr_key_element.blockchainhash,
				"node": reestr_key_element.blockchainnode,
				"recn": reestr_key_element.blockchainrecn,
				"tn": reestr_key_element.blockchaintn
			}
	};

	// Делаем запрос в блокчейн на "Возобновление использования"
	var blockchainResponse = restorekeyelementblockchain(restorekeyelementbch);

	if (!!blockchainResponse.result) {
		// Формируем запись для таблицы История составных частей
		// Действие - Возврат в обращение
		var logItem = set_ke_log(reestr_key_element, "cca267ef-21c9-4781-88b5-6ee8147883be");

		// Сохраняем запись в Историю СЧ
		//res = res && db.insert("log", logItem);
		// Отправка записи в АРМ Росжелдора 29.09.2020 amaslov 44458
		MakeLogRecord("log", logItem, rzd_url.rzd_name_url);

		// Ставим текущий статус СЧ - Предыдущий статус СЧ
		reestr_key_element.statuske = reestr_key_element.previous_statuske;
		reestr_key_element.last_blockchain_request = JSON.stringify(blockchainResponse.request);

		res = res && db.update("reestr_key_elements", reestr_key_element);
	} else {
		return badResp(blockchainResponse);
	}

	if (!isparamsvalid) {
		return badResp(errormessage);
	}

	return res;
}

// Реестр СЕ - Запрет к обращению
function forbidassemblyunitcirculation(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	var requestParams = {
		"recid": params.recid,
		"rejection_reason": params.rejection_reason
	}
	return plugins.callAsMethod("/plugins/nbdlogicplugin/forbiddanceassemblyunitcirculation", "post", requestParams, null);
}

// Реестр СЕ - Возврат в обращение
function returnassemblyunitcirculation(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	var requestParams = {
		"recid": params.recid
	}
	return plugins.callAsMethod("/plugins/nbdlogicplugin/returnassemblyunitcirculation", "post", requestParams, null);
}


function generaterfidbyexistnumbers(params){
	var ke_numbers_params = {
		"rfid_request": params.recid
	};
	// Генерим datamatrix серверным методом
	// Получаем все номера из пула
	var ke_numbers = db.findbyparams("ke_numbers", ke_numbers_params);

	var ke_numbers_array = [];

	// Формируем массив номеров из пула
	if (!!ke_numbers) {
		for (var i = 0; i < ke_numbers.length; i++ ) {
			ke_numbers_array.push(ke_numbers[i].recname);
		}
	}
	else {
		return {
			success: false,
			message: "Не удалось найти сгенерированные номера"
		};
	}

	// Вызываем серверный метод по генерации списка штрихкодов
	var numbers_barcodes_dictionary_object = barcode.generatelist(ke_numbers_array, 32, 52, 52, 104, 104);

	if (numbers_barcodes_dictionary_object !== "undefined"
		&& numbers_barcodes_dictionary_object != null
		&& numbers_barcodes_dictionary_object.data != null
		&& !!numbers_barcodes_dictionary_object.data) {

		var numbers_barcodes_dictionary = numbers_barcodes_dictionary_object.data;

		try {
			var upload_files_req = [];

			// Формируем массив загружаемых на сервер файлов
			for (var i = 0; i < ke_numbers.length; i++) {
				var number_barcode_base64 = numbers_barcodes_dictionary[ke_numbers[i].recname];

				var upload_file_params = {
					"file": {
						"name": "barcode-" + ke_numbers[i].recname + ".jpeg",
						"content": number_barcode_base64
					},
					"columnName": "barcode",
					"entityName": "ke_numbers",
					"description": "",
					"entityId": ke_numbers[i].recid
				};

				upload_files_req.push(upload_file_params);
			}

			// Отправляем на сервер файлы группами
			var group_size = 200;
			if (upload_files_req.length <= group_size) {
				// Загружаем файлы на сервер
				file.upload(upload_files_req);
			}
			else {
				for (var i = 0, j = upload_files_req.length; i < j; i += group_size) {
					var files_group = upload_files_req.slice(i, i + group_size);
					// Загружаем группу файлов на сервер
					file.upload(files_group);
				}
			}
		}
		catch (error) {
			return {
				success: false,
				message: "Произошла ошибка в процессе загрузки изображений Data Matrix кодов на сервер."
			};
		}

		var rfid_request = db.findbyrecid("rfid_request", params.recid);
		var rfid_request_status = rfid_request.rfid_request_status;

		rfid_request.rfid_request_status = rfid_request_status;
		rfid_request.barcodes_generated = true;

		db.update("rfid_request", rfid_request);
	}
	else {
		return {
			success: false,
			message: "Не удалось сгенерировать Data Matrix коды для номеров из пула"
		};
	}

	//второй шаг
	// Получаем все номера из пула
	var ke_numbers = db.findbyparams("ke_numbers", ke_numbers_params);

	// Формируем массив номеров из пула
	if (!!ke_numbers) {
		var report_pages = Math.floor(ke_numbers.length / 36);
		if (ke_numbers.length % 36 > 0) {
			report_pages += 1;
		}
		
		for (var i = 0; i < report_pages; i++ ) {
			var generateReportUrl = "/reports/generate/";
			var url = String().concat(host, generateReportUrl, "reportrfidrequestbarcodes");
			var requestBody = JSON.stringify({
				"colunmname": "barcodes",
				"entityname": "rfid_request",
				"entityid": params.recid,
				"variables": { "rfid_request_param": params.recid },
				"exportfileformat": 22,
				"exportfileextension": "bmp",
				"exportfilename": "barcodes_" + (i + 1),
				"exportpagenumber": i
			});

			var headers = {
				"Content-Type": "application/json",
				"Method": "post"
			};
			headers = addAuthHeader(headers);

			var res = fetch(url, {
				"headers": headers,
				"body": requestBody,
				"Method": "post"
			});

			if (!res.Success) {
				return {
					success: false,
					message: res.Message
				};
			}
		}
	}
	else {
		return {
			success: false,
			message: "Не удалось найти сгенерированные номера"
		};
	}
	return successResp("OK", params);
}

// function generaterfidrequestbarcodes(params) {
// 	// Генерируем номера и DataMatrix коды для номеров
// 	var generatebarcodesbynumbersRes = generatebarcodesbynumbers(params);

// 	if (!generatebarcodesbynumbersRes.success) {
// 		return generatebarcodesbynumbersRes;
// 	}

// 	var node = db.findbyrecid("rfid_request", params.recid);

// 	if (!!node) {
// 		var ke_numbers_params = {
// 			"rfid_request": params.recid
// 		};
	
// 		// Получаем все номера из пула
// 		var ke_numbers = db.findbyparams("ke_numbers", ke_numbers_params);
	
// 		// Формируем массив номеров из пула
// 		if (!!ke_numbers) {
// 			var report_pages = Math.floor(ke_numbers.length / 36);
// 			if (ke_numbers.length % 36 > 0) {
// 				report_pages += 1;
// 			}
			
// 			for (var i = 0; i < report_pages; i++ ) {
// 				var generateReportUrl = "/reports/generate/";
// 				var url = String().concat(host, generateReportUrl, "reportrfidrequestbarcodes");
// 				var requestBody = JSON.stringify({
// 					"colunmname": "barcodes",
// 					"entityname": "rfid_request",
// 					"entityid": params.recid,
// 					"variables": { "rfid_request_param": params.recid },
// 					"exportfileformat": 22,
// 					"exportfileextension": "bmp",
// 					"exportfilename": "barcodes_" + (i + 1),
// 					"exportpagenumber": i
// 				});

// 				var headers = {
// 					"Content-Type": "application/json",
// 					"Method": "post"
// 				};
// 				headers = addAuthHeader(headers);

// 				var res = fetch(url, {
// 					"headers": headers,
// 					"body": requestBody,
// 					"Method": "post"
// 				});

// 				if (!res.Success) {
// 					return {
// 						success: false,
// 						message: res.Message
// 					};
// 				}
// 			}
// 		}
// 		else {
// 			return {
// 				success: false,
// 				message: "Не удалось найти сгенерированные номера1"
// 			};
// 		}
// 	}
// 	else {
// 		return {
// 			success: false,
// 			message: "Пул номеров не найден в системе"
// 		};
// 	}

// 	return {
// 		success: true,
// 		message: "Изображения Data Matrix кодов успешно сгенерированы"
// 	};
// }

//a.polunina убрала в рамках задачи https://rm.mfc.ru/issues/46142
// Передать СЧ Эксплуатанту
// function confirmdelegation(params) {
// 	var reestr_key_element = db.findbyrecid("reestr_key_elements", params.recid);
// 	if (isNullObject(reestr_key_element)) {
// 		return badResp("составная часть не найден в системе.");
// 	}

// 	var nodeip = getnodeipbymember(reestr_key_element.owner);

// 	var listmembers_bch = { "nodeip": nodeip };

// 	var trusted_manufacturer = db.findbyrecid("dictionary_branding_codes", reestr_key_element.trusted_manufacturer);

// 	var objectchangeowner_bch = {
// 		"nodeip": nodeip,
// 		"link":
// 			{
// 				"hash": reestr_key_element.blockchainhash,
// 				"node": reestr_key_element.blockchainnode,
// 				"recn": reestr_key_element.blockchainrecn,
// 				"tn": reestr_key_element.blockchaintn
// 			},
// 		"owner": trusted_manufacturer.full_name
// 	};

// 	var date = new Date().toISOString();

// 	// Передача другому участнику
// 	var log_item = set_ke_log(key_element, "7745d6ac-854b-431c-8ef8-28215c4dd49f");
// 	// Убрано из логов в рамках https://rm.mfc.ru/issues/42476
// 	// // Прошлый владелец
// 	// "old_owner": reestr_key_element.ke_manufacturer,
// 	// // Новый владелец
// 	// "new_owner": reestr_key_element.trusted_manufacturer,


// 	db.insert("log", log_item);

// 	reestr_key_element.is_confirmed_delegation = true;

// 	// Выпущен в обращение
// 	if (reestr_key_element.statuske == "c82c2eb8-0cf9-4693-8a2b-c6bf605c97ab") {
// 		// Передан
// 		reestr_key_element.statuske = "cf989528-3bd8-47bf-bb11-378aae61c2a2";
// 		// Установлен на ТС
// 	} else if (reestr_key_element.statuske == "a0b630bc-fbed-4863-9053-6cec9ee3a459") { }

// 	db.update("reestr_key_elements", reestr_key_element);

// 	event.log("reestr_key_elements",
// 		params.recid,
// 		"СЧ с номером " + reestr_key_element.numberke + " передан предприятию " + trusted_manufacturer.recname + ".",
// 		eventTypeEnum.Info,
// 		objectchangeowner_bch);

// 	return successResp("Передача проведена успешно.");
// }

function objectchangeownerblockchain(params) {
	var request =
		{
			"method":
				{
					"function": "object_change_owner",
					"package": "NBD"
				},
			"object_link":
				{
					"hash": params.link.hash,
					"node": params.link.node,
					"recn": params.link.recn,
					"tn": params.link.tn
				},
			"owner": params.owner
		}

	return sendrequest(request, params.nodeip);
}

function listmembersblockchain(params) {
	var request =
	{
		"method":
			{
				"function": "list_members",
				"package": "NBD"
			}
	}

	return sendrequest(request, params.nodeip);
}

//нужен, т.к. платформа передаёт не целую запись
function requestcorrectke_in(params){
	var element = db.findbyrecid("reestr_key_elements", params.recid);
	if(isNullObject(element)){
		return {
			success: false,
			message: "Не удалось получить данные корректируемой СЧ",
			closeForm: true,
			showMessage: true,
			data: null
		};
	}
	return {
		success: true,
		message: "",
		closeForm: false,
		showMessage: false,
		data: element
	};
}
//метод "запросить корректировку СЧ"
function requestcorrectke(data){
	var fields = {
		"change_method_of_marking": !!data.change_method_of_marking,
		"change_method_of_encoding": !!data.change_method_of_encoding,
		"change_date_manufacture": !!data.change_date_manufacture,
		"change_billet_manufacturer_info": !!data.change_billet_manufacturer_info,
		"change_life_time": !!data.change_life_time,
		"change_individual_features": !!data.change_individual_features,
		"change_manufacturer_number": !!data.change_manufacturer_number,
		"change_rough_axis_number": !!data.change_rough_axis_number,
		"change_rough_axis_manufacturing_date": !!data.change_rough_axis_manufacturing_date,
		"change_melt_number": !!data.change_melt_number,
		"change_steel_grade": !!data.change_steel_grade,
		"change_administration_code": !!data.change_administration_code,
		"change_slip_knots_distance": !!data.change_slip_knots_distance,
		"change_absorbing_device_body_model": !!data.change_absorbing_device_body_model,
		"change_coupling_model": !!data.change_coupling_model,
		"change_auto_mode_cargo_model": !!data.change_auto_mode_cargo_model,
		"change_carcass_load_capacity": !!data.change_carcass_load_capacity,
		"change_carcass_volume": !!data.change_carcass_volume,
		"change_tare_max_weight": !!data.change_tare_max_weight,
		"change_specialization": !!data.change_specialization,
		"change_certificate_number": false
	}

	var url = String().concat("/plugins/nbdlogicplugin/requestcorrectke/", data.recid.toString());
	var res = plugins.callAsMethod(url, "post", fields, null);
	res.closeForm = res.success;
	return res;
}

//функция доставки данных в ДФ "Корректировать СЧ"
function correctke_form_in(params){
	//Массив ошибок по бизнес-процессу 
	var errors_logic_arr = [];
	//Массив системных ошибок 
	var errors_system_arr = [];
	// Получаем текущего участника
	var user = getcurrentuser();
	if(isNullObject(user)){
		errors_system_arr.push("Невозможно получить текущего пользователя")
	}

	var member = getmemberbyuserwithrecid(user.recid);
	if(isNullObject(member)){
		errors_system_arr.push("Получатель не найден в системе");
	}

	var keyElement = db.findbyrecid("reestr_key_elements", params.recid);
	if(isNullObject(keyElement)){
		errors_system_arr.push("Не удалось получить запись");
	}
	var key_element_code = db.findbyrecid("dictionary_key_elements_codes", keyElement.key_element_code);
	if(isNullObject(key_element_code)){
		errors_system_arr.push("Не удалось получить наименование изделия");
	}
	if (keyElement.batchid != null && keyElement.batchid !=""){
		//получаем запись партии
		var batch = db.findbyrecid("reestr_batch", keyElement.batchid);
		if (isNullObject(batch)) {
			errors_system_arr.push("Запись о партии не найдена в системе");
		}
		if (member.recid != batch.recipient_droplist){
			//если изготовитель, отправитель
			if (batch.batch_status == "ef519ef4-ec73-4776-9295-2d007bb32907" || (batch.batch_status == "f7b21136-24a8-4ae5-af5b-3b7b3dd0c36b" && keyElement.change_node == true)){
				//получени наименования статуса
				var batch_status_name = db.findbyrecid("dictionary_batch_status", batch.batch_status);
				if(isNullObject(batch_status_name)){
					errors_system_arr.push("Не удалось получить статус партии");
				}
				//Получаем запись из таблицы Запрос корректировки
				var correctionRequestRecords = db.findbyparams("correction_request", {
					"objectid": params.recid
				});
				if (!isEmptyOrNullArray(correctionRequestRecords) && correctionRequestRecords.length > 0) {
					var change_parameters = correctionRequestRecords[0].parameters;
				} else {
					errors_logic_arr.push("Невозможно корректировать ЭП " + keyElement.numberke + " " + key_element_code.recname + ", включенного в партию в статусе " + batch_status_name.recname + " без запроса на корректировку");
				}
			}
		}
	}

	if(isNotEmptyOrNullArray(errors_system_arr)){
		if (errors_system_arr.length > 0){
			return {
				success: false,
				message: String().concat(errors_system_arr.join(", ")),
				closeForm: true,
				showMessage: true,
				data: null
			};
		}
	}
	if(isNotEmptyOrNullArray(errors_logic_arr)){
		if (errors_logic_arr.length > 0){
			return {
				success: false,
				message: String().concat(errors_logic_arr.join(", ")),
				closeForm: true,
				showMessage: true,
				data: null
			};
		}
	}

	var data = {
		"recid": keyElement.recid,
		"key_element_code": keyElement.key_element_code,
		"has_rough_axis_number": keyElement.has_rough_axis_number,
		"batchid": keyElement.batchid,
		"change_flags": !!change_parameters ? JSON.parse(change_parameters) : null, 
		//для клин фрикционный
		"point_to_manufacturer_number": keyElement.point_to_manufacturer_number,
        "method_of_marking_group": {
            "method_of_marking_old": keyElement.method_of_marking_text,
            // "method_of_marking_new": keyElement.method_of_marking
		},
		"method_of_encoding_group": {
			"method_of_encoding_old": keyElement.method_of_encoding_text,
            // "method_of_encoding_new": keyElement.method_of_encoding
		},
		"date_manufacture_group": {
			"date_manufacture_old": keyElement.date_manufacture,
            // "date_manufacture_new": keyElement.date_manufacture
		},
		"manufacturer_number_group": {
			"manufacturer_number_old": keyElement.manufacturer_number,
            // "manufacturer_number_new": keyElement.manufacturer_number
		},
		"melt_number_group": {
			"melt_number_old": keyElement.melt_number,
            // "melt_number_new": keyElement.melt_number
		},
		"steel_grade_group": {
			"steel_grade_old": keyElement.steel_grade_text,
			// "steel_grade_new": keyElement.steel_grade
		},
		"administration_code_group": {
			"administration_code_old": keyElement.administration_code_text,
            // "administration_code_new": keyElement.administration_code
		},
		"certificate_number_group": {
			"certificate_number_old": keyElement.certificate_number_text,
            // "certificate_number_new": keyElement.certificate_number
		},
		"life_time_group": {
			"life_time_old": keyElement.life_time,
            // "life_time_new": keyElement.life_time
		},
		"billet_manufacturer_info_group": {
			"billet_manufacturer_info_old": keyElement.billet_manufacturer_info_text,
            // "billet_manufacturer_info_new": keyElement.billet_manufacturer_info
		},
		//для рамы боковой
		"slip_knots_distance_group": {
			"slip_knots_distance_old": keyElement.slip_knots_distance,
            // "slip_knots_distance_new": keyElement.slip_knots_distance
		},
		// Сменный жд кузов
		"individual_features_group": {
			"individual_features_old": keyElement.individual_features,
            // "individual_features_new": keyElement.individual_features
		},
		"carcass_load_capacity_group": {
			"carcass_load_capacity_old": keyElement.carcass_load_capacity,
            // "carcass_load_capacity_new": keyElement.carcass_load_capacity
		},
		"carcass_volume_group": {
			"carcass_volume_old": keyElement.carcass_volume,
            // "carcass_volume_new": keyElement.carcass_volume
		},
		"tare_max_weight_group": {
			"tare_max_weight_old": keyElement.tare_max_weight,
            // "tare_max_weight_new": keyElement.tare_max_weight
		},
		"specialization_group": {
			"specialization_old": keyElement.specialization_text,
		},
		"rough_axis_manufacturing_date_group": {
			"rough_axis_manufacturing_date_old": keyElement.rough_axis_manufacturing_date
		},
		"rough_axis_number_group": {
			"rough_axis_number_old": keyElement.rough_axis_number
		},
		"rough_axis_group": {
			"rough_axis_old": ""
		},
		//автосцепка
		"coupling_model_group": {
			"coupling_model_old": keyElement.coupling_model_text
		},
		//корпус поглощающего аппарата
		"absorbing_device_body_model_group": {
			"absorbing_device_body_model_old": keyElement.absorbing_device_body_model_text
		},
		//авторежим грузовой
		"auto_mode_cargo_model_group": {
			"auto_mode_cargo_model_old": keyElement.auto_mode_cargo_model_text
		}
	}
	
	//если ось чистовая 
	if(keyElement.key_element_code === 'e4ef0365-0365-40df-ab4e-a77104c352df' && isNotEmptyString( keyElement.rough_axis)){
		var rough_axis = db.findbyrecid("reestr_key_elements", keyElement.rough_axis)
		data.rough_axis_group.rough_axis_old = String().concat(rough_axis.key_element_code_calculated,", ", rough_axis.numberke, ", ", rough_axis.manufacturer_number)
	}
    return {
        success: true,
        message: "Запись доставлена в форму.",
        closeForm: false,
        showMessage: false,
        data: data
    };
}

function correctke_form(data){

	//определяем, в партии ли СЧ
	if(isNotEmptyString(data.batchid)){
		var batch = db.findbyrecid("reestr_batch", data.batchid);
		if(isNullObject(batch)){
			return  {
				success: false,
				message: "Произошла ошибка при получении информации о партии.",
				closeForm: false,
				showMessage: false,
				data: data
			}
		}

		//если партия в статусе черновик был изменен параметр "Сертификат соответствия" - выводить предупреждение об исключении из партии
		if(batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e' && isNotEmptyString(data.certificate_number_group.certificate_number_new)){
			data.countChild = 1;
		} else {
			data.countChild = 0;
		}
	}

	// Создание отдела архива данных, если его нет
	data.old = !data.old ? {} : data.old;

	// Инициализируем количество нужных нам дополнительных форм
	data.old.countChild = !data.old.countChild ? !data.countChild ? 0 : data.countChild : data.old.countChild;

	// Инициализируем текущий номер дополнительной формы
	data.old.childNow = !data.old.childNow ? 0.0 : data.old.childNow;

	// Условия, когда нужен переход на дополнительные формы
	//(когда СЧ в партии в статусе "Черновик" и был изменен параметр "Сертификат соответствия")
	if (data.old.countChild !== 0 && data.old.childNow < data.old.countChild && isNotEmptyString(data.certificate_number_group.certificate_number_new)) {
		var certificate = db.findbyrecid("reestr_certificates", data.certificate_number_group.certificate_number_new);
		if(isNullObject(certificate)){
			return {
				showMessage: true,
				message: "Ошибка при корректировке получении информации о сертификате соответствия",
				success: false,
				data: data,
				closeForm: false,
			};
		}
		//если сертификат изменился - выдаём предупреждение
		if(certificate.registration_number != data.certificate_number_group.certificate_number_old){
			// Перелистываем номер формы
			data.old.childNow++;
			// Отправляем на следующую дополнительную форму 
			return {
				showMessage: false,
				message: null,
				success: true,
				data: data,
				closeForm: false,
				idNextForm: "3aad0bb6-f09f-4619-b6e5-0a9b3b096f80" 
			};
		}
	}

	if(data.old.childNow ==0){

		var params = {
			"recid": data.recid,
			"method_of_marking": data.method_of_marking_group.method_of_marking_new,
			"method_of_encoding": data.method_of_encoding_group.method_of_encoding_new,
			"date_manufacture": data.date_manufacture_group.date_manufacture_new,
			"manufacturer_number": data.manufacturer_number_group.manufacturer_number_new,
			"melt_number": data.melt_number_group.melt_number_new,
			"steel_grade": data.steel_grade_group.steel_grade_new,
			"administration_code": data.administration_code_group.administration_code_new,
			"certificate_number": data.certificate_number_group.certificate_number_new,
			"life_time": data.life_time_group.life_time_new,
			"billet_manufacturer_info": data.billet_manufacturer_info_group.billet_manufacturer_info_new,
			//для рамы боковой
			"slip_knots_distance": data.slip_knots_distance_group.slip_knots_distance_new,
			// Сменный жд кузов
			"individual_features": data.individual_features_group.individual_features_new,
			"carcass_load_capacity": data.carcass_load_capacity_group.carcass_load_capacity_new,
			"carcass_volume": data.carcass_volume_group.carcass_volume_new,
			"tare_max_weight": data.tare_max_weight_group.tare_max_weight_new,
			"specialization": data.specialization_group.specialization_new,
			// ось чистовая
			"rough_axis_manufacturing_date": data.rough_axis_manufacturing_date_group.rough_axis_manufacturing_date_new,
			"rough_axis_number": data.rough_axis_number_group.rough_axis_number_new,
			"rough_axis": data.rough_axis_group.rough_axis_new,
			//корпус автосцепки
			"coupling_model": data.coupling_model_group.coupling_model_new,
			//корпус поглощающего аппарата
			"absorbing_device_body_model": data.absorbing_device_body_model_group.absorbing_device_body_model_new,
			//авторежим
			"auto_mode_cargo_model": data.auto_mode_cargo_model_group.auto_mode_cargo_model_new,
			//параметр, отвечающий за согласие исключить СЧ из партии в случае корректировки сертификата
			"is_agree_exclude_ke_from_batch": false,
		}
	} else {
		//определяем название формы
		var formName = "";
		let objKeys = typeof data.old !== "string" && Object.keys(data.old);
		objKeys.forEach(function(key) { 
			if(key.indexOf("correctke", 0) !== -1)
				formName = key; 
				return;
		}); 
		var params = {
			"recid": data.old[formName].recid,
			"method_of_marking": data.old[formName].method_of_marking_group.method_of_marking_new,
			"method_of_encoding": data.old[formName].method_of_encoding_group.method_of_encoding_new,
			"date_manufacture": data.old[formName].date_manufacture_group.date_manufacture_new,
			"manufacturer_number": data.old[formName].manufacturer_number_group.manufacturer_number_new,
			"melt_number": data.old[formName].melt_number_group.melt_number_new,
			"steel_grade": data.old[formName].steel_grade_group.steel_grade_new,
			"administration_code": data.old[formName].administration_code_group.administration_code_new,
			"certificate_number": (data.is_agree_exclude_ke_from_batch) ? data.old[formName].certificate_number_group.certificate_number_new : "",
			"life_time": data.old[formName].life_time_group.life_time_new,
			"billet_manufacturer_info": data.old[formName].billet_manufacturer_info_group.billet_manufacturer_info_new,
			//для рамы боковой
			"slip_knots_distance": data.old[formName].slip_knots_distance_group.slip_knots_distance_new,
			// Сменный жд кузов
			"individual_features": data.old[formName].individual_features_group.individual_features_new,
			"carcass_load_capacity": data.old[formName].carcass_load_capacity_group.carcass_load_capacity_new,
			"carcass_volume": data.old[formName].carcass_volume_group.carcass_volume_new,
			"tare_max_weight": data.old[formName].tare_max_weight_group.tare_max_weight_new,
			"specialization": data.old[formName].specialization_group.specialization_new,
			// ось чистовая
			"rough_axis_manufacturing_date": data.old[formName].rough_axis_manufacturing_date_group.rough_axis_manufacturing_date_new,
			"rough_axis_number": data.old[formName].rough_axis_number_group.rough_axis_number_new,
			"rough_axis": data.old[formName].rough_axis_group.rough_axis_new,
			//корпус автосцепки
			"coupling_model": data.old[formName].coupling_model_group.coupling_model_new,
			//корпус поглощающего аппарата
			"absorbing_device_body_model": data.old[formName].absorbing_device_body_model_group.absorbing_device_body_model_new,
			//авторежим
			"auto_mode_cargo_model": data.old[formName].auto_mode_cargo_model_group.auto_mode_cargo_model_new,
			//параметр, отвечающий за согласие исключить СЧ из партии в случае корректировки сертификата
			"is_agree_exclude_ke_from_batch": data.is_agree_exclude_ke_from_batch,
		}
	}
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/correctkeyelement", "post", params, null);
	res.closeForm = res.success;
	return res;
}

// Общий метод корректировки СЧ
function correctke(params) {
	var res = true;
	//Флаг, показывающий что были произведены изменения
	var has_changes = false;

	if (isNullObject(params)) {
		return badResp("Неверный формат входных параметров.");
	}

	var rzd_url = get_rzd_urls_portal_settings();
	if(!rzd_url.success){
		return badResp("Не удалось получить адрес АРМ Росжелдора");
	}

	var key_element = db.findbyrecid("reestr_key_elements", params.recid);

	// Группа общих параметров
	// params = {
	// 	// Способ (тип) маркировки
	// 	"method_of_marking": "string or null",
	// 	// Дата изготовления
	// 	"date_manufacture": "string or null",
	// }

	// Если статус СЧ "Готов к регистрации" и запрос идет НЕ из api метода, то корректировать СЧ нельзя
	if (key_element.statuske == "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
		if (params.is_api_request == null || params.is_api_request == false) {
			return badResp("СЧ в текущем статусе нельзя корректировать.");
		}
	}
	// Если статус СЧ НЕ "Выпущен в обращение" и НЕ "Снят с ТС", то корректировать СЧ нельзя
	else if (key_element.statuske != "c82c2eb8-0cf9-4693-8a2b-c6bf605c97ab"
		&& key_element.statuske != "259762d5-2ee4-4acb-a2c7-18593cb6cc4f") {
		return badResp("СЧ в текущем статусе нельзя корректировать.");
	}

	//Если СЧ был включен в партию
	if (isNotEmptyString(key_element.batchid)) {
		var batch = db.findbyrecid("reestr_batch", key_element.batchid);
		if(isNullObject(batch)){
			return badResp("Произошла ошибка при получении информации о партии.");
		}

		// Получаем текущего участника
		var user = getcurrentuser();
		if(isNullObject(user)){
			return badResp("Произошла ошибка при получении информации о текущем пользователе");
		}

		var member = getmemberbyuserwithrecid(user.recid);
		if(isNullObject(member)){
			return badResp("Произошла ошибка при получении информации о текущем участнике");
		}

		//Запрещаем (НА ЛЮБОЙ СТОРОНЕ) корректировать параметры СЧ, которые связаны с партиями в статусах "На подписании", "Готова к передаче", "Отправлена", "Ошибка отправки/получения".
		if(batch.batch_status == '5d900b59-a081-4a59-b5d0-96174f01c58a' || batch.batch_status == '640adf70-20a7-48bd-93f5-75862c7ae1b0' || batch.batch_status == '24225a06-5efb-4966-9db6-1c47acb92bcf' || batch.batch_status == '4d7e4b8f-49d0-4e92-9b8f-e3741ba8e1fc'){
			return badResp(String().concat("Невозможно скорректировать значения параметров, т.к. СЧ " + key_element.numberke + " включен в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
		}
		//если статус партии "получена", но корректировка происходит НЕ на стороне получателя, ЗАПРЕЩАЕМ её
		if(batch.batch_status == 'ef519ef4-ec73-4776-9295-2d007bb32907'){
			// Проверка является ли текущий участник получателем партии
			//Если тукущий участник - отправитель, то запрещаем
			if (member.recid !== batch.recipient_droplist){
				return badResp(String().concat("Невозможно скорректировать значения параметров, т.к. СЧ " + key_element.numberke + " включен в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
			}
			//иначе текущий участник - получатель, разрешаем корректировку
		}

		//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
		if(batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
			//если на получателе - запрещаем
			if(member.recid === batch.recipient_droplist){
				return badResp(String().concat("Невозможно скорректировать значения параметров, т.к. СЧ " + key_element.numberke + " включен в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
			}
			//если на отправителе
			//то ниже проверяем был ли изменён сертификат соответствия и если да, то исключаем из партии
		}
	}

	// Запрещаем изменение поля - Наименование изделия
	if (isNotEmptyString(params.key_element_code) && params.key_element_code != key_element.key_element_code) {
		return badResp("Запрещено изменять значение поля - Наименование изделия.");
	}

	// Если изменилось поле - Способ (тип) маркировки
	if (isNotEmptyString(params.method_of_marking)) {
		var method_of_marking = db.findbyrecid("dictionary_method_of_marking", params.method_of_marking);
		if (isNullObject(method_of_marking)) {
			return badResp("Способ (тип) маркировки не найден в системе.");
		}
		// Если значение изменилось относительно зафиксированного 
		if(method_of_marking.recname != key_element.method_of_marking_text){
			has_changes = true;
			key_element.method_of_marking_text = method_of_marking.recname;
		}
		key_element.method_of_marking = params.method_of_marking;
	}

	// Если изменилось поле - Способ кодировки
	if (isNotEmptyString(params.method_of_encoding)) {
		var method_of_encoding = db.findbyrecid("dictionary_method_of_encoding", params.method_of_encoding);
		if (isNullObject(method_of_encoding)) {
			return badResp("Способ кодировки не найден в системе.");
		}
		// Если значение изменилось относительно зафиксированного 
		if(method_of_encoding.recname != key_element.method_of_encoding_text){
			has_changes = true;
			key_element.method_of_encoding_text = method_of_encoding.recname;
		}
		key_element.method_of_encoding = params.method_of_encoding;
	}
	//  else if(params.method_of_encoding != key_element.method_of_encoding){
	// 	key_element.method_of_encoding = null;
	// 	key_element.method_of_encoding_text = null;
	// }

	if (isNotEmptyString(params.date_manufacture)) {
		var date_manufacture_old = new Date(key_element.date_manufacture);
		var date_manufacture_new = new Date(params.date_manufacture);
		// Без этого дата передаётся не корректно
		date_manufacture_new.setUTCDate(date_manufacture_new.getUTCDate() + 1);
		date_manufacture_new.setUTCHours(12);
		// Если изменилось поле - Дата изготовления
		if (date_manufacture_new.getTime() != date_manufacture_old.getTime()) {
			has_changes = true;
			key_element.date_manufacture = date_manufacture_new;
		}
	}
	var object_set_data_blockchain = null;
	var file_content_object_json = null;

	// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
	if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
		var nodeip = getnodeipbymember(key_element.owner);
		if (isEmptyString(nodeip)) {
			return badResp("Не удалось определить IP адрес блокчейна.");
		}

		// Получаем значения справочников для формирования объекта запроса в блокчейн
		var key_element_code = db.findbyrecid("dictionary_key_elements_codes", key_element.key_element_code);
		var ke_number = db.findbyrecid("ke_numbers", key_element.ke_number);
		// var method_of_marking = db.findbyrecid("dictionary_method_of_marking", key_element.method_of_marking);
		// var documentation_number = db.findbyrecid("reestr_documentation", key_element.documentation_number);
		var date_manufacture = new Date(key_element.date_manufacture);

		var current_date = new Date();
		current_date.setUTCDate(current_date.getUTCDate() + 1);
		current_date.setUTCHours(12);
		event.log("correctke", null, "дата текущая", 4, current_date.getTime());
		event.log("correctke", null, "дата изготовления", 4, date_manufacture.getTime());

		if (date_manufacture.getTime() > current_date.getTime()){
			return badResp("Дата изготовления не должна быть больше текущей даты");
		}

		key_element.date_manufacture = date_manufacture;
		// 	date_manufacture.setUTCHours(0, 0, 0, 0);
		// var manufacturer_details = db.findbyrecid("reestr_members", key_element.manufacturer_details);
		// var method_of_encoding = db.findbyrecid("dictionary_method_of_encoding", key_element.method_of_encoding);

		var normative_name = isNotNullObject(key_element_code) && isNotEmptyString(key_element_code.normative_name)
			? key_element_code.normative_name.trim()
			: null;

		object_set_data_blockchain = {
			"nodeip": nodeip,
	
			// Наименование изделия
			"ke_type": key_element_code.recname,
			// Наименование изделия по НД
			"normative_name": normative_name,
			// УИН
			"ke_number": ke_number.recname,
			// Способ (тип) маркировки
			"method_of_marking" : key_element.method_of_marking_text,
			// Наименование изделия
			"key_element_code": key_element_code.reccode,
			// Обозначение изделия
			"documentation_number": key_element.documentation_number_text,
			// Дата изготовления
			"date_manufacture": date_manufacture.getUTCFullYear() 
				+ '-' + (date_manufacture.getUTCMonth() + 1).toString().padStart(2, 0) 
				+ '-' + (date_manufacture.getUTCDate()).toString().padStart(2, 0),
			// Сведения об изготовителе
			"manufacturer_details": key_element.manufacturer_details_text,
			//Сведения об изготовителе заготовки
			"billet_manufacturer_info": key_element.billet_manufacturer_info_text,
			
			"hash": key_element.blockchainhash,
			"node": key_element.blockchainnode,
			"recn": key_element.blockchainrecn,
			"tn": key_element.blockchaintn
		};

		//формирование данных для json файла
			file_content_object_json = {
				"document_type": "Технический паспорт",
				"item_type": "Составная часть",
				"common_params": {
					"ke_number": ke_number.recname,
					"method_of_marking": key_element.method_of_marking_text,
					"method_of_encoding": key_element.method_of_encoding_text,
					"key_element_code": key_element_code.recname,
					"documentation_number": key_element.documentation_number_text,
					"date_manufacture": date_manufacture.getUTCFullYear() 
						+ '-' + (date_manufacture.getUTCMonth() + 1).toString().padStart(2, 0) 
						+ '-' + (date_manufacture.getUTCDate()).toString().padStart(2, 0),
					"owner": key_element.manufacturer_details_text
				},
				"special_params": null,
				"after_register_params": null
			};
	}

	// Балка надрессорная
	// params = {
	// 	// Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя
	// 	"ke_manufacturer": "string or null",
	// 	// Регистрационный номер свидетельства о присвоении номера для клеймения
	// 	"branding_code_certificate_number": "string or null",
	// 	// Номер изделия по системе нумерации предприятия-изготовителя
	// 	"manufacturer_number": "string or null",
	// 	// Номер плавки
	// 	"melt_number": "string or null",
	// 	// Марка материала
	// 	"steel_grade": "string or null",
	// 	// Код государства собственника детали
	// 	"administration_code": "string or null",
	// 	// Сведения о сертификате соответствия
	// 	"certificate_number": "string or null",
	// 	// Срок службы
	// 	"life_time": "string or null",
	//	//Сведения об изготовителе заготовки
	// 	"billet_manufacturer_info": 
	// 	// Сведения о первичном вводе в обращение
	// 	"initial_release": "string or null",
	// }
	if (key_element.key_element_code == keyElementCodes.pressure_beam_id) {

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Номер плавки
		if (isNotEmptyString(params.melt_number) && params.melt_number != key_element.melt_number) {
			has_changes = true;
			key_element.melt_number = params.melt_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Код государства собственника детали
		if (isNotEmptyString(params.administration_code) ) {
			var administration_code = db.findbyrecid("dictionary_administration_codes", params.administration_code);
			if (isNullObject(administration_code)) {
				return badResp("Код государства собственника детали не найден в системе.");
			}
			// Если значение изменилось относительно зафиксированного 
			if(administration_code.recname != key_element.administration_code_text){
				has_changes = true;
				key_element.administration_code_text = administration_code.recname;
			}
			key_element.administration_code = params.administration_code;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}

		// Если изменилось поле - Срок службы
		if (isNotEmptyString(params.life_time) && params.life_time != key_element.life_time) {
			has_changes = true;
			key_element.life_time = params.life_time;
		}

		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}
		
		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			var administration_code = db.findbyrecid("dictionary_administration_codes", key_element.administration_code);
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Срок службы
			object_set_data_blockchain.life_time = key_element.life_time;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Номер плавки
			object_set_data_blockchain.melt_number = key_element.melt_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			// Код государства собственника детали
			object_set_data_blockchain.administration_code = administration_code.reccode; // key_element.administration_code_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"life_time": key_element.life_time,
				"ke_manufacturer": ke_manufacturer[0], //.code,
				"short_ke_manufacturer": ke_manufacturer[1],//.recname,
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"melt_number":  key_element.melt_number,
				"steel_grade": key_element.steel_grade_text,
				"administration_code": administration_code.reccode,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	// Рама боковая
	// params = {
	// 	// Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя
	// 	"ke_manufacturer": "string or null",
	// 	// Регистрационный номер свидетельства о присвоении номера для клеймения
	// 	"branding_code_certificate_number": "string or null",
	// 	// Номер изделия по системе нумерации предприятия-изготовителя
	// 	"manufacturer_number": "string or null",
	// 	// Номер плавки
	// 	"melt_number": "string or null",
	// 	// Марка материала
	// 	"steel_grade": "string or null",
	// 	// Код государства собственника детали
	// 	"administration_code": "string or null",
	// 	// Сведения о сертификате соответствия
	// 	"certificate_number": "string or null",
	// 	// Срок службы
	// 	"life_time": "string or null",
	//	// Расстояние между наружными упорными поверхностями буксового проема (количество шишек)
	//	"slip_knots_distance": "string or null",
	//	//Сведения об изготовителе заготовки
	//	"billet_manufacturer_info": "string or null",
	// 	// Сведения о первичном вводе в обращение
	// 	"initial_release": "string or null",
	// }
	if (key_element.key_element_code == keyElementCodes.side_frame_id) {

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Номер плавки
		if (isNotEmptyString(params.melt_number) && params.melt_number != key_element.melt_number) {
			has_changes = true;
			key_element.melt_number = params.melt_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Код государства собственника детали
		if (isNotEmptyString(params.administration_code)) {
			var administration_code = db.findbyrecid("dictionary_administration_codes", params.administration_code);
			if (isNullObject(administration_code)) {
				return badResp("Код государства собственника детали не найден в системе.");
			}
			// Если значение изменилось относительно зафиксированного 
			if(administration_code.recname != key_element.administration_code_text){
				has_changes = true;
				key_element.administration_code_text = administration_code.recname;
			}
			key_element.administration_code = params.administration_code;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}

		// Если изменилось поле - Срок службы
		if (isNotEmptyString(params.life_time) && params.life_time != key_element.life_time) {
			has_changes = true;
			key_element.life_time = params.life_time;
		}

		// Если изменилось поле - Расстояние между наружными упорными поверхностями буксового проема (количество шишек)
		if (isNotEmptyString(params.slip_knots_distance) && params.slip_knots_distance != key_element.slip_knots_distance) {
			has_changes = true;
			key_element.slip_knots_distance = params.slip_knots_distance;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			// var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", key_element.ke_manufacturer);
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// var steel_grade = db.findbyrecid("dictionary_steel_grade", key_element.steel_grade);
			// var certificate_number = db.findbyrecid("reestr_certificates", key_element.certificate_number);
			var administration_code = db.findbyrecid("dictionary_administration_codes", key_element.administration_code);
			// var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", key_element.billet_manufacturer_info);
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Срок службы
			object_set_data_blockchain.life_time = key_element.life_time;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Номер плавки
			object_set_data_blockchain.melt_number = key_element.melt_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			// Код государства собственника детали
			object_set_data_blockchain.administration_code = administration_code.reccode;
			// Расстояние между наружными упорными поверхностями буксового проема (количество шишек)
			object_set_data_blockchain.slip_knots_distance = key_element.slip_knots_distance;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info =  key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"life_time": key_element.life_time,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"melt_number":  key_element.melt_number,
				"steel_grade": key_element.steel_grade_text,
				"administration_code": administration_code.reccode,
				"slip_knots_distance": key_element.slip_knots_distance,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	// Адаптер подшипника, Корпус скользуна, Колпак скользуна, Планка фрикционная, Скоба, Пластины в клиновых карманах, Кольцо в подпятник, Вставки в клиновые карманы, Вкладыш подпятника
	// params = {
	// 	// Условный номер для клеймения продукции вагоностроения/Сокращенное наименование предприятия-изготовителя
	// 	"ke_manufacturer": "string or null",
	// 	// Регистрационный номер свидетельства о присвоении номера для клеймения
	// 	"branding_code_certificate_number": "string or null",
	// 	// Марка материала
	// 	"steel_grade": "string or null",
	//	// Сведения об изготовителе заготовки
	//	"billet_manufacturer_info": "string or null",
	// 	// Сведения о первичном вводе в обращение
	// 	"initial_release": "string or null",
	// }
	if (key_element.key_element_code == keyElementCodes.bearing_adapter_id
		|| key_element.key_element_code == keyElementCodes.slider_body_id
		|| key_element.key_element_code == keyElementCodes.slider_cap_id
		|| key_element.key_element_code == keyElementCodes.friction_strip_id
		|| key_element.key_element_code == keyElementCodes.brace_id
		|| key_element.key_element_code == keyElementCodes.wedge_pockets_id
		|| key_element.key_element_code == keyElementCodes.wedge_pockets_inserts_id
		|| key_element.key_element_code == keyElementCodes.saddle_ring_id
		|| key_element.key_element_code == keyElementCodes.saddle_bearing_id) {

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			// var ke_manufacturer = db.findbyrecid("dictionary_branding_codes", key_element.ke_manufacturer);
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// var steel_grade = db.findbyrecid("dictionary_steel_grade", key_element.steel_grade);
			// var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", key_element.billet_manufacturer_info);
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	// Сменный железнодорожный кузов
	//  // Индивидуальные особенности
	// 	"individual_features": "string or null",
	// 	// Номер изделия по системе нумерации предприятия-изготовителя
	// 	"manufacturer_number": "string or null",
	// 	// Марка материала
	// 	"steel_grade": "string or null",
	//  //Срок службы
	// 	"life_time": "string or null",
	//	// Грузоподъемность
	//	"carcass_load_capacity": "string or null",
	// 	// Сведения о первичном вводе в обращение
	// 	"initial_release": "string or null",
	//  //Объем кузова (котла)
	//	"carcass_volume": "string or null",
	//  //Масса тары максимальная
	//  "tare_max_weight": "string or null",
	//  //Специализация
	//  "specialization": "string or null",
	// }
	if (key_element.key_element_code == keyElementCodes.removable_railway_carcass_id) {
		// Если изменилось поле - Индивидуальные особенности
		if (isNotEmptyString(params.individual_features) && params.individual_features != key_element.individual_features) {
			has_changes = true;
			key_element.individual_features = params.individual_features;
		}

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}
			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}

			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Срок службы
		if (isNotEmptyString(params.life_time) && params.life_time != key_element.life_time) {
			has_changes = true;
			key_element.life_time = params.life_time;
		}

		// Если изменилось поле - Грузоподъемность
		if (isNotEmptyString(params.carcass_load_capacity) && params.carcass_load_capacity != key_element.carcass_load_capacity) {
			if(isNaN(params.carcass_load_capacity)){
				return badResp("Грузоподъемность не число");
			}

			var carcass_load_capacity_parsed = parseFloat(params.carcass_load_capacity);
			if(carcass_load_capacity_parsed < 0){
				return badResp("Грузоподъемность отрицательна");
			}

			has_changes = true;
			key_element.carcass_load_capacity = params.carcass_load_capacity;
		}
		// Если изменилось поле - Объем кузова (котла)
		if (isNotEmptyString(params.carcass_volume) && params.carcass_volume != key_element.carcass_volume) {
			if(isNaN(params.carcass_volume)){
				return badResp("Объем кузова не число");
			}
			var carcass_volume_parsed = parseFloat(params.carcass_volume);
			if(carcass_volume_parsed < 0){
				return badResp("Объем кузова отрицательный");
			}
			has_changes = true;
			key_element.carcass_volume = params.carcass_volume;
		}

		// Если изменилось поле - Масса тары максимальная
		if (isNotEmptyString(params.tare_max_weight) && params.tare_max_weight != key_element.tare_max_weight) {
			if(isNaN(params.tare_max_weight)){
				return badResp("Масса тары не число");
			}
			var tare_max_weight_parsed = parseFloat(params.tare_max_weight);
			if(tare_max_weight_parsed < 0){
				return badResp("Масса тары отрицательна");
			}
			
			has_changes = true;
			key_element.tare_max_weight = params.tare_max_weight;
		}

		// Если изменилось поле - Специализация
		if (isNotEmptyString(params.specialization)) {
			var dictionary_spec = db.findbyrecid("dictionary_specializations", params.specialization);
			if(isNullObject(dictionary_spec)){
				return badResp("Информация о специализации не найдена в системе");
			}
			// Если значение изменилось относительно зафиксированного 
			if(dictionary_spec.spec_name != key_element.specialization_text){
				has_changes = true;
				key_element.specialization_text = dictionary_spec.spec_name;
			}
			key_element.specialization = params.specialization;
		}

		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			// Индивидуальные особенности
			object_set_data_blockchain.individual_features = key_element.individual_features.toString();
			// Срок службы
			object_set_data_blockchain.life_time = key_element.life_time.toString();
			// Грузоподъемность
			object_set_data_blockchain.carcass_load_capacity = key_element.carcass_load_capacity.toString();
			// Объем кузова
			object_set_data_blockchain.carcass_volume = key_element.carcass_volume.toString();
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number.toString();
			// Масса тары
			object_set_data_blockchain.tare_max_weight = key_element.tare_max_weight.toString();
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text.toString();
			// Специализация
			object_set_data_blockchain.specialization = key_element.specialization_text;
			// Технические условия
			object_set_data_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();

			file_content_object_json.special_params = {
				"life_time": key_element.life_time,
				"manufacturer_number": key_element.manufacturer_number,
				"steel_grade": key_element.steel_grade_text,
				"individual_features": key_element.individual_features.toString(),
				"carcass_load_capacity": key_element.carcass_load_capacity.toString(),
				"carcass_volume": key_element.carcass_volume.toString(),
				"tare_max_weight": key_element.tare_max_weight.toString(),
				"specialization": key_element.specialization_text,
				"technical_conditions": dictionary_technical_conditions_fields.recname.toString()
			}
		}
	}
	
	//Ось чистовая
	if(key_element.key_element_code == keyElementCodes.clear_axis_id){

		// Если изменилось поле - Номер черновой оси
		var rough_axis_number = null;
		if (key_element.has_rough_axis_number != null && key_element.has_rough_axis_number) {
			if (isNotEmptyString(params.rough_axis) && params.rough_axis != key_element.rough_axis) {
				var rough_axis = db.findbyrecid("reestr_key_elements", params.rough_axis);
				if (isNullObject(rough_axis)) {
					return badResp("Указанная ось черновая не найдена в системе.");
				}

				// Проверяем, что указанная черновая ось уже не указана у другой чистовой оси 
				var key_elements_by_rough_axis_params = {
					"rough_axis": params.rough_axis
				};
				var key_elements_by_rough_axis = db.findbyparams("reestr_key_elements", key_elements_by_rough_axis_params);
				if (isNotEmptyOrNullArray(key_elements_by_rough_axis) && key_elements_by_rough_axis.length > 0) {
					return badResp("Указанная ось черновая, уже связана с СЧ с УИН " + key_elements_by_rough_axis[0].numberke + ".");
				}

				has_changes = true;
				key_element.rough_axis = params.rough_axis;
				key_element.rough_axis_text = rough_axis.manufacturer_number;
				rough_axis_number = rough_axis.manufacturer_number;
			}
			else {
				rough_axis_number = key_element.rough_axis_calculated;
			}
		}
		else {
			if (isNotEmptyString(params.rough_axis_number) && params.rough_axis_number != key_element.rough_axis_number) {
				has_changes = true;
				key_element.rough_axis_number = params.rough_axis_number;
				rough_axis_number = params.rough_axis_number;
			}
			else {
				rough_axis_number = key_element.rough_axis_number;
			}
		}

		// Если изменилось поле - Год изготовления чистовой оси
		if (isNotEmptyString(params.rough_axis_manufacturing_date) && params.rough_axis_manufacturing_date != key_element.rough_axis_manufacturing_date) {
			has_changes = true;
			key_element.rough_axis_manufacturing_date = params.rough_axis_manufacturing_date;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}


		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}
		
		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер черновой оси
			object_set_data_blockchain.rough_axis_number = rough_axis_number;
			// Год изготовления черновой оси
			object_set_data_blockchain.rough_axis_manufacturing_date = key_element.rough_axis_manufacturing_date;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text,
				"rough_axis_manufacturing_number": rough_axis_number,
				"rough_axis_manufacturing_date": key_element.rough_axis_manufacturing_date
			}
		}
	}

	//Колесо
	if (key_element.key_element_code == keyElementCodes.wheel_id) {

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Номер плавки
		if (isNotEmptyString(params.melt_number) && params.melt_number != key_element.melt_number) {
			has_changes = true;
			key_element.melt_number = params.melt_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Номер плавки
			object_set_data_blockchain.melt_number = key_element.melt_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"melt_number":  key_element.melt_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Замок, валик подъемника
	if(key_element.key_element_code == keyElementCodes.lock_id
		|| key_element.key_element_code == keyElementCodes.elevator_roll_id){

		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Корпус автосцепки
	if (key_element.key_element_code == keyElementCodes.auto_coupler_id) {

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Модель автосцепки
		if (isNotEmptyString(params.coupling_model) && params.coupling_model != key_element.coupling_model) {
			var coupling_model = db.findbyrecid("dictionary_couplings_models", params.coupling_model);
			if (isNullObject(coupling_model)) {
				return badResp("Модель автосцепки не найдена в системе");
			}
			// Если значение изменилось относительно зафиксированного 
			if(coupling_model.coupling_name != key_element.coupling_model_text){
				has_changes = true;
				key_element.coupling_model_text = coupling_model.coupling_name;
			}
			key_element.coupling_model = params.coupling_model;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Модель автосцепки
			object_set_data_blockchain.coupling_model = key_element.coupling_model_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text,
				"coupling_model": key_element.coupling_model_text
			}
		}
	}

	//Упоры передний и задний объединенные
	if (key_element.key_element_code == keyElementCodes.front_rear_detents_id) {

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Срок службы
		if (isNotEmptyString(params.life_time) && params.life_time != key_element.life_time) {
			has_changes = true;
			key_element.life_time = params.life_time;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если изменилось поле - Код государства собственника детали
		if (isNotEmptyString(params.administration_code) ) {
			var administration_code = db.findbyrecid("dictionary_administration_codes", params.administration_code);
			if (isNullObject(administration_code)) {
				return badResp("Код государства собственника детали не найден в системе.");
			}
			// Если значение изменилось относительно зафиксированного 
			if(administration_code.recname != key_element.administration_code_text){
				has_changes = true;
				key_element.administration_code_text = administration_code.recname;
			}
			key_element.administration_code = params.administration_code;
		}

		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			var administration_code = db.findbyrecid("dictionary_administration_codes", key_element.administration_code);
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Время жизни
			object_set_data_blockchain.life_time = key_element.life_time;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;
			//Код государства собственника детали
			object_set_data_blockchain.administration_code = administration_code.reccode;
			// Технические условия
			object_set_data_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"steel_grade": key_element.steel_grade_text,
				"life_time": key_element.life_time,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text,
				"technical_conditions": dictionary_technical_conditions_fields.recname.toString(),
				"administration_code": administration_code.reccode
			}
		}
	}

	//Крышка люка полувагона
	if (key_element.key_element_code == keyElementCodes.gondola_hatch_id) {

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;

			file_content_object_json.special_params = {
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number
			}
		}
	}

	//Пружина рессорного подвешивания наружная
	if (key_element.key_element_code == keyElementCodes.spring_outside_id) {

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Марка материала
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Пружина рессорного подвешивания внутренняя
	if (key_element.key_element_code == keyElementCodes.spring_inside_id) {

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;	
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Пружина скользуна наружная
	if (key_element.key_element_code == keyElementCodes.spring_slider_outside_id) {

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Пружина скользуна внутренняя
	if (key_element.key_element_code == keyElementCodes.spring_slider_inside_id) {

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Подшипник буксового узла
	if (key_element.key_element_code == keyElementCodes.bearing_node_id) {

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}

		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Технические условия
			object_set_data_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"technical_conditions": dictionary_technical_conditions_fields.recname.toString()
			}
		}
	}

	//Ось черновая
	if(key_element.key_element_code == keyElementCodes.rough_axis_id){

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Номер плавки
		if (isNotEmptyString(params.melt_number) && params.melt_number != key_element.melt_number) {
			has_changes = true;
			key_element.melt_number = params.melt_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}


		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}
		
		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Номер плавки
			object_set_data_blockchain.melt_number = key_element.melt_number;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text,
				"melt_number": key_element.melt_number
			}
		}
	}

	//Корпус поглощающего аппарата
	if(key_element.key_element_code == keyElementCodes.absorbing_device_body_id){

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}
/*
		// Если изменилось поле - Обозначение модели корпуса полглощающего аппарата
		if (isNotEmptyString(params.absorbing_device_body_model) && params.absorbing_device_body_model != key_element.absorbing_device_body_model) {
			key_element.absorbing_device_body_model = params.absorbing_device_body_model;
		}
*/
		// Если изменилось поле - Модель корпуса поглощающего аппарата
		if (isNotEmptyString(params.absorbing_device_body_model)) {
			var absorbing_device_body_model = db.findbyrecid("dictionary_absorbing_device_body_models", params.absorbing_device_body_model);
			if (isNullObject(absorbing_device_body_model)) {
				return badResp("Модель корпуса поглощающего аппарата не найдена в системе");
			}

			// Если значение изменилось относительно зафиксированного 
			if(absorbing_device_body_model.recname != key_element.absorbing_device_body_model_text){
				has_changes = true;
				key_element.absorbing_device_body_model_text = absorbing_device_body_model.recname;
			}
			key_element.absorbing_device_body_model = params.absorbing_device_body_model;
		}

		
		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Обозначение модели
			object_set_data_blockchain.absorbing_device_body_model = key_element.absorbing_device_body_model_text;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;

			file_content_object_json.special_params = {
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"absorbing_device_body_model": key_element.absorbing_device_body_model_text
			}
		}
	}

	//Хомут тяговый
	if(key_element.key_element_code == keyElementCodes.traction_clamp_id){

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}


		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}
		
		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}
		
		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	//Авторежим грузовой
	if(key_element.key_element_code == keyElementCodes.auto_mode_cargo_id){

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		}


		// Если изменилось поле - Сведения о сертификате соответствия
		if (isNotEmptyString(params.certificate_number)) {
			var certificate_number = db.findbyrecid("reestr_certificates", params.certificate_number);
			if (isNullObject(certificate_number)) {
				return badResp("Сведения о сертификате соответствия не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(certificate_number.registration_number != key_element.certificate_number_text){
				has_changes = true;
				key_element.certificate_number_text = certificate_number.registration_number;
				//если статус партии "черновик" и корректировка НА ОТПРАВИТЕЛЕ
				if(batch != null && batch.batch_status == '255abbd7-fa7c-40d4-a270-5169a84fa05e'){
					//если на отправителе
					//исключение из партии в случае изменение сертификата соответствия
					if(params.is_agree_exclude_ke_from_batch){
						var resExclude = excludefrombatch(key_element);
						key_element.batchid = null;
						if(!resExclude.success){
							return badResp(String().concat("Произошла ошибка при исключении СЧ " + key_element.numberke + " из партии ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>"));
						}
					} else {
						//вероятно, СЧ был добавлен в партию после того как была открыта форма корректировки
						return badResp(String().concat("Произошла ошибка при корректировке СЧ " + key_element.numberke + ", включенной в партию ", "<a href=\"/tables/reestr_batch/", batch.recid, "\" target=\"_blank\" class=\"alert-link\">", batch.batch_number, "</a>. Попробуйте обновить страницу и заново провести корректировку."));
					}
				}
			}
			key_element.certificate_number = params.certificate_number;
		}

		// Если изменилось поле - Срок службы
		if (isNotEmptyString(params.life_time) && params.life_time != key_element.life_time) {
			has_changes = true;
			key_element.life_time = params.life_time;
		}

		// Если изменилось поле - Модель авторежим грузовой
		if (isNotEmptyString(params.auto_mode_cargo_model)) {
			var auto_mode_cargo_model = db.findbyrecid("dictionary_auto_mode_cargo_models", params.auto_mode_cargo_model);
			if (isNullObject(auto_mode_cargo_model)) {
				return badResp("Модель корпуса поглощающего аппарата не найдена в системе");
			}
			// Если значение изменилось относительно зафиксированного 
			if(auto_mode_cargo_model.recname != key_element.auto_mode_cargo_model_text){
				has_changes = true;
				key_element.auto_mode_cargo_model_text = auto_mode_cargo_model.recname;
			}
			key_element.auto_mode_cargo_model = params.auto_mode_cargo_model;
		}
		
		var reestr_documentation_fields = db.findbyrecid("reestr_documentation", key_element.documentation_number);
		if (isNullObject(reestr_documentation_fields)) {
			return badResp(error_message_head + "Запись в реестре документации не найдена.");
		}
		var dictionary_technical_conditions_fields = db.findbyrecid("dictionary_technical_conditions", reestr_documentation_fields.technical_conditions);
		if (isNullObject(dictionary_technical_conditions_fields)) {
			return badResp(error_message_head + "Запись в справочнике Технические условия не найдена.");
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Сведения о сертификате соответствия
			object_set_data_blockchain.certificate_number = key_element.certificate_number_text;
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Номер изделия по системе нумерации предприятия-изготовителя
			object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			// Технические условия
			object_set_data_blockchain.technical_conditions = dictionary_technical_conditions_fields.recname.toString();
			//срок службы
			object_set_data_blockchain.life_time = key_element.life_time;
			// Обозначение модели
			object_set_data_blockchain.auto_mode_cargo_model = key_element.auto_mode_cargo_model_text;

			file_content_object_json.special_params = {
				"certificate_number": key_element.certificate_number_text,
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"manufacturer_number": key_element.manufacturer_number,
				"technical_conditions": dictionary_technical_conditions_fields.recname.toString(),
				"life_time": key_element.life_time,
				"auto_mode_cargo_model": key_element.auto_mode_cargo_model_text
			}
		}
	}
	// Клин фрикционный
	if (key_element.key_element_code == keyElementCodes.friction_wedge_id) {

		// Если изменилось поле - Марка материала
		if (isNotEmptyString(params.steel_grade)) {
			var steel_grade = db.findbyrecid("dictionary_steel_grade", params.steel_grade);
			if (isNullObject(steel_grade)) {
				return badResp("Марка материала не найдена в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(steel_grade.recname != key_element.steel_grade_text){
				has_changes = true;
				key_element.steel_grade_text = steel_grade.recname;
			}
			key_element.steel_grade = params.steel_grade;
		}

		//Если изменилось поле - Сведения об изготовителе заготовки
		if(isNotEmptyString(params.billet_manufacturer_info)){
			var billet_manufacturer_info = db.findbyrecid("dictionary_billet_manufacturer_details", params.billet_manufacturer_info);
			if (isNullObject(billet_manufacturer_info)) {
				return badResp("Сведения об изготовителе заготовки не найдены в системе.");
			}

			// Если значение изменилось относительно зафиксированного 
			if(billet_manufacturer_info.billet_manufacturer_name != key_element.billet_manufacturer_info_text){
				has_changes = true;
				key_element.billet_manufacturer_info_text = billet_manufacturer_info.billet_manufacturer_name;
			}
			key_element.billet_manufacturer_info = params.billet_manufacturer_info;
		}

		// Если изменилось поле - Номер изделия по системе нумерации предприятия-изготовителя
		if (isNotEmptyString(params.manufacturer_number) && params.manufacturer_number != key_element.manufacturer_number) {
			has_changes = true;
			key_element.manufacturer_number = params.manufacturer_number;
		
			if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") { 
				// Номер изделия по системе нумерации предприятия-изготовителя
				object_set_data_blockchain.manufacturer_number = key_element.manufacturer_number;
			}
		}

		// Если статус СЧ НЕ "Готов к регистрации", формируем объект запроса к блокчейну
		if (key_element.statuske != "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
			var ke_manufacturer = key_element.ke_manufacturer_text.split(', ');
			// Условный номер для клеймения продукции вагоностроения
			object_set_data_blockchain.ke_manufacturer_code = ke_manufacturer[0];
			// Сокращенное наименование предприятия-изготовителя
			object_set_data_blockchain.ke_manufacturer_name = ke_manufacturer[1];
			// Регистрационный номер свидетельства о присвоении номера для клеймения
			object_set_data_blockchain.branding_code_certificate_number = key_element.branding_code_certificate_number;
			// Марка материала
			object_set_data_blockchain.steel_grade = key_element.steel_grade_text;
			//Сведения об изготовителе заготовки
			object_set_data_blockchain.billet_manufacturer_info = key_element.billet_manufacturer_info_text;

			file_content_object_json.special_params = {
				"ke_manufacturer": ke_manufacturer[0],
				"short_ke_manufacturer": ke_manufacturer[1],
				"branding_code_certificate_number": key_element.branding_code_certificate_number,
				"steel_grade": key_element.steel_grade_text,
				"billet_manufacturer_info": key_element.billet_manufacturer_info_text
			}
		}
	}

	file_content_object_json.after_register_params = {
		"acceptance_certificate": key_element.acceptance_certificate,
		"packing_certificate": key_element.packing_certificate
	}
	if(has_changes){
		var logItem = set_ke_log(key_element, "6f12bd95-1a74-4a89-b1ab-aaee46f7e1e8");
		//db.insert("log", logItem);
		// Отправка записи в АРМ Росжелдора 29.09.2020 amaslov 44458
		MakeLogRecord("log", logItem, rzd_url.rzd_name_url);
	}
	// Если запрос пришел из метода api и СЧ в статусе "Готов к регистрации", то не отправляем запрос в блокчейн  
	if (params.is_api_request && key_element.statuske == "52c7de6f-1bc2-48a7-90b4-1b14264a01ab") {
		res = res && db.update("reestr_key_elements", key_element);

		if (!res) {
			return badResp("Произошла ошибка при обновлении СЧ.");
		}
	}
	else if(!has_changes){
		return successResp("Корректировка не проведена, т.к. параметры не были изменены")
	}
	else {
		var request_params = correctobject(object_set_data_blockchain);
		var blockchain_resp = sendrequest(request_params[0], request_params[1]);
		if(blockchain_resp.noblockhain){
			key_element.last_blockchain_request = "";
			key_element.date_entry_blockchain = new Date().toISOString();
	
			res = res && db.update("reestr_key_elements", key_element);
	
			if (!res) {
				return badResp("Произошла ошибка при обновлении СЧ.");
			}
			return successResp("Корректировка проведена успешно.");
		}else{
			if (!!blockchain_resp.result) {
				key_element.last_blockchain_request = JSON.stringify(request_params[0], null, '\t');
				key_element.date_entry_blockchain = new Date().toISOString();
	
				res = res && db.update("reestr_key_elements", key_element);
	
				if (!res) {
					return badResp("Произошла ошибка при обновлении СЧ.");
				}
	
				event.log("reestr_key_elements",
					key_element.recid,
					"СЧ с номером " + key_element.numberke + " скорректирован в блокчейне.",
					eventTypeEnum.Info,
					request_params[0]);
			}
			else {
				return blockchain_resp;
			}
		}		
	}	

	//если есть приложенный json файл то удаляем его
	var files = getattachedfileincolumn("reestr_key_elements", "key_element_passport_file", params.recid);
	if(!isEmptyOrNullArray(files)){
		//Добавление неподписанных файлов в массив
		for(var j = 0; j < files.length; j++){
			var attached_file = files[j];
			delete_files(attached_file.recId);			
		}
	}
	// Формирование json-файла
	var save_content_as_file_result = SaveContentAsFileAsync("reestr_key_elements", params.recid, "key_element_passport_file", key_element.numberke.toString(), "json", JSON.stringify(file_content_object_json, null, '\t'))
	if(!save_content_as_file_result.success){
		return save_content_as_file_result;
	}

	//21.08.2020 amaslov 42449 Отправка файла паспорта в росжелдор из плагина
	//В плагине отправка реализована в заготовке контроллера корректировки СЧ для дальнейшего переноса в него всей логики 
	if(key_element.application_id != null){
		var application_record = db.findbyrecid("reestr_applications_for_key_elements_registration", key_element.application_id);
		if(application_record != null && ( //Если заявление найдено
		(application_record.reason1 && application_record.status == "56b4391b-82bc-42b5-a466-91d21db8022b")|| //И Если основание заявления "Учет изготовления" и статус "результат отправлене владельцу"
		application_record.status == "20b9d598-ea5b-4508-b0ce-c13d54d65944") //Или статус заявления "отправлено в росжелдор"
		)
		{
			var headers = {
				"Content-Type": "application/json"
			};
			var body = {
				ke: params,
				files: files
			};
			var headers = addAuthHeader(headers);
			var url = String().concat(host, "/plugins/nbdlogicplugin/correctkeyelement")
			var res = fetch(url, {
				headers: headers,
				"body": JSON.stringify(body),  
				"Method": "post"
			});
			var result = JSON.parse(res.data);
			if(result.success == false){
				return badResp(result.message);
			}
		}
	}	

	return successResp("Корректировка проведена успешно.");
}

function correctobject(params) {
	var request = {
		"method": {
			"function": "object_set_data",
			"package": "NBD"
		},
		"object_link": {
			"hash": params.hash,
			"node": params.node,
			"recn": params.recn,
			"tn": params.tn
		},
		"object_class": params.ke_type,
		"object_data": {
			"common": {
				"Способ (тип) маркировки": params.method_of_marking,
				"Наименование изделия по НД": params.normative_name,
				"Обозначение изделия": params.documentation_number.trim(),
				"Дата изготовления": params.date_manufacture,
				"Сведения об изготовителе": params.manufacturer_details
			},
			"specific": null
		}
	};

	// Балка надрессорная
	if (params.key_element_code == keyElementCodes.pressure_beam_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Срок службы": params.life_time,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade,
				"Код государства собственника детали (значение из классификатора КЖА 1001 15)": params.administration_code
			};
	}

	// Рама боковая
	if (params.key_element_code == keyElementCodes.side_frame_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Срок службы": params.life_time,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade,
				"Код государства собственника детали (значение из классификатора КЖА 1001 15)": params.administration_code,
				"Расстояние между наружными упорными поверхностями буксового проема (количество шишек)": params.slip_knots_distance
			};
	}

	// Адаптер подшипника, Корпус скользуна, Колпак скользуна, Планка фрикционная, Скоба, Пластины в клиновых карманах, Вставки в клиновые карманы
	if (params.key_element_code == keyElementCodes.bearing_adapter_code
		|| params.key_element_code == keyElementCodes.slider_body_code
		|| params.key_element_code == keyElementCodes.slider_cap_code
		|| params.key_element_code == keyElementCodes.friction_strip_code
		|| params.key_element_code == keyElementCodes.brace_code
		|| params.key_element_code == keyElementCodes.wedge_pockets_code
		|| params.key_element_code == keyElementCodes.saddle_ring_code
		|| params.key_element_code == keyElementCodes.wedge_pockets_inserts_code
		|| params.key_element_code == keyElementCodes.saddle_bearing_code) {
			
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade
			};
	}

	//Сменный ЖД кузов
	if (params.key_element_code == keyElementCodes.removable_railway_carcass_code){
		request.object_data.specific = {
			"Технические условия": params.technical_conditions,
			"Срок службы": params.life_time,
			"Индивидуальные особенности": params.individual_features,
			"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
			"Марка материала":	params.steel_grade,
			"Грузоподъемность":	params.carcass_load_capacity,
			"Объем кузова (котла)": params.carcass_volume,
			"Масса тары максимальная": params.tare_max_weight,
			"Специализация": params.specialization
		}
	}

	// Ось чистовая
	if (params.key_element_code == keyElementCodes.clear_axis_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер черновой оси": params.rough_axis_number,
				"Год изготовления черновой оси": params.rough_axis_manufacturing_date.trim(),
				"Марка материала": params.steel_grade
			};
			
	}

	// Колесо
	if (params.key_element_code == keyElementCodes.wheel_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade
			};
			
	}

	//Замок, валик подъемника
	if(params.key_element_code == keyElementCodes.lock_code
		|| params.key_element_code == keyElementCodes.elevator_roll_code){
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number
			};
	}

	// Корпус автосцепки
	if (params.key_element_code == keyElementCodes.auto_coupler_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Марка материала": params.steel_grade,
				"Обозначение модели": params.coupling_model
			};
			
	}

	//Упоры передний и задний объединенные
	if (params.key_element_code == keyElementCodes.front_rear_detents_code) {
		request.object_data.specific = 
			{ 
				"Технические условия": params.technical_conditions,
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Срок службы": params.life_time,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Марка материала": params.steel_grade,
				"Код государства собственника детали (значение из классификатора КЖА 1001 15)": params.administration_code
			};
	}
	
	//Крышка люка полувагона
	if (params.key_element_code == keyElementCodes.gondola_hatch_code) {
		request.object_data.specific = 
			{ 
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number
			};	
	}

	 //Пружина рессорного подвешивания наружная
	 if (params.key_element_code == keyElementCodes.spring_outside_code) {
		request.object_data.specific = 
		{ 
			"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
			"Сведения о сертификате соответствия": params.certificate_number,
			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
			"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
			"Марка материала": params.steel_grade
		};
	}

	 //Пружина рессорного подвешивания внутренняя
	 if (params.key_element_code == keyElementCodes.spring_inside_code) {
		request.object_data.specific = 
		{ 
			"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
			"Сведения о сертификате соответствия": params.certificate_number,
			"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
			"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
			"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
			"Марка материала": params.steel_grade
		};
	}

	 //Пружина скользуна наружная
	 if (params.key_element_code == keyElementCodes.spring_slider_outside_code) {
		request.object_data.specific = 
		{ 
			"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
			"Марка материала": params.steel_grade
		};
	}

	//Пружина скользуна внутренняя
	if (params.key_element_code == keyElementCodes.spring_slider_inside_code) {
		request.object_data.specific = 
		{ 
			"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
			"Марка материала": params.steel_grade
		};
	}

	//Подшипник буксового узла
	if (params.key_element_code == keyElementCodes.bearing_node_code) {
		request.object_data.specific = 
			{ 
				"Технические условия": params.technical_conditions,
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number
			};
	}

	//Ось черновая
	if (params.key_element_code == keyElementCodes.rough_axis_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Номер плавки": params.melt_number,
				"Марка материала": params.steel_grade
			};
	}

	//Корпус поглощающего аппарата
	if (params.key_element_code == keyElementCodes.absorbing_device_body_code) {
		request.object_data.specific = 
			{ 
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Обозначение модели": params.absorbing_device_body_model.toString()
			};
	}

	//Хомут тяговый
	if (params.key_element_code == keyElementCodes.traction_clamp_code) {
		request.object_data.specific = 
			{ 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Марка материала": params.steel_grade
			};
	}

	//Авторежим грузовой
	if (params.key_element_code == keyElementCodes.auto_mode_cargo_code) {
		request.object_data.specific = 
			{
				"Технические условия": params.technical_conditions, 
				"Сведения о сертификате соответствия": params.certificate_number,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number,
				"Обозначение модели": params.auto_mode_cargo_model.toString(),
				"Срок службы": params.life_time
			};
	}

	// Клин фрикционный
	if (params.key_element_code == keyElementCodes.friction_wedge_code) {
		if (isNotEmptyString(params.manufacturer_number)) {
			request.object_data.specific = { 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade,
				"Номер изделия по системе нумерации предприятия-изготовителя": params.manufacturer_number
			};
		} else {
			request.object_data.specific = { 
				"Сведения об изготовителе заготовки": params.billet_manufacturer_info,
				"Условный номер для клеймения продукции вагоностроения (по справочнику СЖА 1001 17)": params.ke_manufacturer_code,
				"Сокращенное наименование предприятия-изготовителя (по справочнику СЖА 1001 17)": params.ke_manufacturer_name,
				"Регистрационный номер свидетельства о присвоении номера для клеймения": params.branding_code_certificate_number,
				"Марка материала": params.steel_grade
			};
		}
	}
	var nodeip = params.nodeip
	return [request, nodeip];
}

// Добавить УИН в реестре составных частей
function add_uin_key_element(params){
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/adduinkeyelement", "post", params, null);
	res.closeForm = res.success;
	return res;
}

// Сохранение вида неисправностей
function save_dictionary_type_malfunction_pressure_beam(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	//Вызываем метод из плагина
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/savetypemalfunction", "post", params.selectedRecords[0], null);
	return res;
}

// Сохранение цены операции
function save_dictionary_transaction_prices(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	//Вызываем метод из плагина
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/savedictionarytransactionprices", "post", params.selectedRecords[0], null);
	return res;
}

// Сохранение шаблона сч
function save_reestr_parts_type(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	//Вызываем метод валидации настройки автоинкремента номера из плагина
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/validate_autoincrement_number", "post", params.selectedRecords[0], null);
	
	if (!res.success){
		return res;
	}
	
	return {
		success: true,
		message: "",
		data: null
	};
}

// Сохранение шаблона се
function save_reestr_ke_node_types(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	//Вызываем метод валидации настройки автоинкремента номера из плагина
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/validate_autoincrement_number", "post", params.selectedRecords[0], null);
	
	if (!res.success){
		return res;
	}
	
	return {
		success: true,
		message: "",
		data: null
	};
}

// Сохранение черновика сч
function save_reestr_key_elements(params){
	if (typeof params.values != 'undefined' && params.values != null && typeof params.tableName != 'undefined' && typeof params.countOfSelectedRecords != 'undefined') {
		params.values.recid = params.recid
		params = params.values;
	};
	//Вызываем метод валидации из плагина
	var res = plugins.callAsMethod("/plugins/nbdlogicplugin/save_reestr_key_elements", "post", params.selectedRecords[0], null);
	
	if (!res.success){
		return res;
	}
	
	return {
		success: true,
		message: "",
		data: null
	};
}